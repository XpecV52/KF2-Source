/*******************************************************************************
 * McpUserCloudFileDownload generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class McpUserCloudFileDownload extends McpServiceBase
    native
    config(Engine)
    implements(UserCloudFileInterface);

struct native McpUserCloudFileInfo extends EmsFile
{
    var string CreationDate;
    var string LastUpdateDate;
    var string CompressionType;
};

struct native McpUserCloudFilesEntry
{
    var string UserId;
    var array<TitleFileWeb> DownloadedFiles;
    var array<McpUserCloudFileInfo> EnumeratedFiles;
    var HttpRequestInterface HTTPRequestEnumerateFiles;

    structdefaultproperties
    {
        UserId=""
        DownloadedFiles=none
        EnumeratedFiles=none
        HTTPRequestEnumerateFiles=none
    }
};

var config string EnumerateCloudFilesUrl;
var config string ReadCloudFileUrl;
var config string WriteCloudFileUrl;
var config string DeleteCloudFileUrl;
var private array<McpUserCloudFilesEntry> UserCloudFileRequests;
var private array< delegate<OnEnumerateUserFilesComplete> > EnumerateUserFilesCompleteDelegates;
var private array< delegate<OnReadUserFileComplete> > ReadUserFileCompleteDelegates;
var private array< delegate<OnWriteUserFileComplete> > WriteUserFileCompleteDelegates;
var private array< delegate<OnDeleteUserFileComplete> > DeleteUserFileCompleteDelegates;
var delegate<OnEnumerateUserFilesComplete> __OnEnumerateUserFilesComplete__Delegate;
var delegate<OnReadUserFileComplete> __OnReadUserFileComplete__Delegate;
var delegate<OnWriteUserFileComplete> __OnWriteUserFileComplete__Delegate;
var delegate<OnDeleteUserFileComplete> __OnDeleteUserFileComplete__Delegate;

function bool GetFileContents(string UserId, string Filename, out array<byte> FileContents)
{
    local bool bResult;
    local int EntryIdx, FileIdx;

    EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
    if(EntryIdx != -1)
    {
        FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Find('Filename', Filename;
        if((FileIdx != -1) && UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState == 2)
        {
            FileContents = UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Data;
            bResult = true;
        }
    }
    return bResult;
}

function bool ClearFiles(string UserId)
{
    local bool bResult;
    local int EntryIdx, FileIdx;

    EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
    if(EntryIdx != -1)
    {
        FileIdx = 0;
        J0x47:

        if(FileIdx < UserCloudFileRequests[EntryIdx].DownloadedFiles.Length)
        {
            if(UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState == 1)
            {
                return false;
            }
            ++ FileIdx;
            goto J0x47;
        }
        UserCloudFileRequests[EntryIdx].DownloadedFiles.Length = 0;
        bResult = true;
    }
    return bResult;
}

function bool ClearFile(string UserId, string Filename)
{
    local bool bResult;
    local int EntryIdx, FileIdx;

    EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
    if(EntryIdx != -1)
    {
        FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Find('Filename', Filename;
        if((FileIdx != -1) && UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState != 1)
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles.Remove(FileIdx, 1;
            bResult = true;
        }
    }
    return bResult;
}

function EnumerateUserFiles(string UserId)
{
    local int EntryIdx;
    local string URL;
    local bool bPending;

    EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
    if(EntryIdx == -1)
    {
        EntryIdx = UserCloudFileRequests.Length;
        UserCloudFileRequests.Length = EntryIdx + 1;
        UserCloudFileRequests[EntryIdx].UserId = UserId;
    }
    if(UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles == none)
    {
        UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles = Class'HttpFactory'.static.CreateRequest();
        if(UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles != none)
        {
            URL = ((((GetBaseURL()) $ EnumerateCloudFilesUrl) $ (GetAppAccessURL())) $ "&uniqueUserId=") $ UserId;
            UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles.SetURL(URL);
            UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles.SetVerb("GET");
            UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles.__OnProcessRequestComplete__Delegate = OnHTTPRequestEnumerateUserFilesComplete;
            UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles.ProcessRequest();
            bPending = true;
        }        
    }
    else
    {
        LogInternal(((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "User files already being enumerated for") $ " UserId=") $ UserId);
    }
    if(!bPending)
    {
        CallEnumerateUserFileCompleteDelegates(false, UserId);
    }
}

private final function OnHTTPRequestEnumerateUserFilesComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local int EntryIdx, JsonIdx;
    local string JsonString, UserId;
    local JsonObject ParsedJson;
    local bool bResult;

    EntryIdx = UserCloudFileRequests.Find('HTTPRequestEnumerateFiles', Request;
    if(EntryIdx != -1)
    {
        UserId = UserCloudFileRequests[EntryIdx].UserId;
        if(bWasSuccessful && Response.GetResponseCode() == 200)
        {
            UserCloudFileRequests[EntryIdx].EnumeratedFiles.Length = 0;
            JsonString = Response.GetContentAsString();
            if(JsonString != "")
            {
                LogInternal(((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "") $ " JsonString=") $ JsonString);
                ParsedJson = Class'JsonObject'.static.DecodeJson(JsonString);
                UserCloudFileRequests[EntryIdx].EnumeratedFiles.Length = ParsedJson.ObjectArray.Length;
                JsonIdx = 0;
                J0x1F3:

                if(JsonIdx < ParsedJson.ObjectArray.Length)
                {
                    UserCloudFileRequests[EntryIdx].EnumeratedFiles[JsonIdx].Filename = ParsedJson.ObjectArray[JsonIdx].GetStringValue("file_name");
                    UserCloudFileRequests[EntryIdx].EnumeratedFiles[JsonIdx].FileSize = int(ParsedJson.ObjectArray[JsonIdx].GetStringValue("file_size"));
                    UserCloudFileRequests[EntryIdx].EnumeratedFiles[JsonIdx].DLName = ParsedJson.ObjectArray[JsonIdx].GetStringValue("file_name");
                    UserCloudFileRequests[EntryIdx].EnumeratedFiles[JsonIdx].CreationDate = ParsedJson.ObjectArray[JsonIdx].GetStringValue("creation_date");
                    UserCloudFileRequests[EntryIdx].EnumeratedFiles[JsonIdx].LastUpdateDate = ParsedJson.ObjectArray[JsonIdx].GetStringValue("last_update_time");
                    UserCloudFileRequests[EntryIdx].EnumeratedFiles[JsonIdx].CompressionType = ParsedJson.ObjectArray[JsonIdx].GetStringValue("compression_type");
                    ++ JsonIdx;
                    goto J0x1F3;
                }
            }
            bResult = true;            
        }
        else
        {
            LogInternal(((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Failed to enumerate files for") $ " UserId=") $ UserCloudFileRequests[EntryIdx].UserId) $ " URL=") $ Request.GetURL());
        }
        UserCloudFileRequests[EntryIdx].HTTPRequestEnumerateFiles = none;
    }
    CallEnumerateUserFileCompleteDelegates(bResult, UserId);
}

delegate OnEnumerateUserFilesComplete(bool bWasSuccessful, string UserId);

private final function CallEnumerateUserFileCompleteDelegates(bool bWasSuccessful, string UserId)
{
    local int Index;
    local delegate<OnEnumerateUserFilesComplete> CallDelegate;

    Index = 0;
    J0x0B:

    if(Index < EnumerateUserFilesCompleteDelegates.Length)
    {
        CallDelegate = EnumerateUserFilesCompleteDelegates[Index];
        if(CallDelegate != none)
        {
            OnEnumerateUserFilesComplete(bWasSuccessful, UserId);
        }
        ++ Index;
        goto J0x0B;
    }
}

function AddEnumerateUserFileCompleteDelegate(delegate<OnEnumerateUserFilesComplete> EnumerateUserFileCompleteDelegate)
{
    if(EnumerateUserFilesCompleteDelegates.Find(EnumerateUserFileCompleteDelegate == -1)
    {
        EnumerateUserFilesCompleteDelegates.AddItem(EnumerateUserFileCompleteDelegate;
    }
}

function ClearEnumerateUserFileCompleteDelegate(delegate<OnEnumerateUserFilesComplete> EnumerateUserFileCompleteDelegate)
{
    local int RemoveIndex;

    RemoveIndex = EnumerateUserFilesCompleteDelegates.Find(EnumerateUserFileCompleteDelegate;
    if(RemoveIndex != -1)
    {
        EnumerateUserFilesCompleteDelegates.Remove(RemoveIndex, 1;
    }
}

function GetUserFileList(string UserId, out array<EmsFile> UserFiles)
{
    local int EntryIdx, FileIdx;

    EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
    if(EntryIdx != -1)
    {
        UserFiles.Length = UserCloudFileRequests[EntryIdx].EnumeratedFiles.Length;
        FileIdx = 0;
        J0x79:

        if(FileIdx < UserCloudFileRequests[EntryIdx].EnumeratedFiles.Length)
        {
            UserFiles[FileIdx].DLName = UserCloudFileRequests[EntryIdx].EnumeratedFiles[FileIdx].DLName;
            UserFiles[FileIdx].Filename = UserCloudFileRequests[EntryIdx].EnumeratedFiles[FileIdx].Filename;
            UserFiles[FileIdx].FileSize = UserCloudFileRequests[EntryIdx].EnumeratedFiles[FileIdx].FileSize;
            ++ FileIdx;
            goto J0x79;
        }        
    }
    else
    {
        UserFiles.Length = 0;
    }
}

function bool ReadUserFile(string UserId, string Filename)
{
    local int EntryIdx, FileIdx;
    local string URL;
    local bool bPending;

    if((Len(UserId) > 0) && Len(Filename) > 0)
    {
        EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
        if(EntryIdx == -1)
        {
            EntryIdx = UserCloudFileRequests.Length;
            UserCloudFileRequests.Length = EntryIdx + 1;
            UserCloudFileRequests[EntryIdx].UserId = UserId;
        }
        FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Find('Filename', Filename;
        if(FileIdx == -1)
        {
            FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Length;
            UserCloudFileRequests[EntryIdx].DownloadedFiles.Length = FileIdx + 1;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Filename = Filename;
        }
        if((UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState != 1) && UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest == none)
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 1;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Data.Length = 0;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest = Class'HttpFactory'.static.CreateRequest();
            if(UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest != none)
            {
                URL = ((((((GetBaseURL()) $ ReadCloudFileUrl) $ (GetAppAccessURL())) $ "&uniqueUserId=") $ UserId) $ "&fileName=") $ Filename;
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetURL(URL);
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetVerb("GET");
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.__OnProcessRequestComplete__Delegate = OnHTTPRequestReadUserFileComplete;
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.ProcessRequest();
                bPending = true;
            }            
        }
        else
        {
            LogInternal(((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "File operation already in progress") $ " UserId=") $ UserId) $ " FileName=") $ Filename);
        }        
    }
    else
    {
        LogInternal(((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Invalid parameters") $ " UserId=") $ UserId) $ " FileName=") $ Filename);
    }
    if(!bPending)
    {
        CallReadUserFileCompleteDelegates(false, UserId, Filename);
    }
    return bPending;
}

private final function OnHTTPRequestReadUserFileComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local int EntryIdx, FileIdx;
    local string Filename, UserId;
    local bool bResult;
    local array<byte> FileContents;

    GetUserFileIndexForRequest(Request, EntryIdx, FileIdx);
    if((EntryIdx != -1) && FileIdx != -1)
    {
        UserId = UserCloudFileRequests[EntryIdx].UserId;
        Filename = UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Filename;
        if((bWasSuccessful && Response != none) && Response.GetResponseCode() == 200)
        {
            Response.GetContent(FileContents);
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Data = FileContents;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 2;
            bResult = true;            
        }
        else
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 3;
        }
        UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest = none;        
    }
    else
    {
        LogInternal(((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find entry index");
    }
    CallReadUserFileCompleteDelegates(bResult, UserId, Filename);
}

delegate OnReadUserFileComplete(bool bWasSuccessful, string UserId, string Filename);

private final function CallReadUserFileCompleteDelegates(bool bWasSuccessful, string UserId, string Filename)
{
    local int Index;
    local delegate<OnReadUserFileComplete> CallDelegate;

    Index = 0;
    J0x0B:

    if(Index < ReadUserFileCompleteDelegates.Length)
    {
        CallDelegate = ReadUserFileCompleteDelegates[Index];
        if(CallDelegate != none)
        {
            OnReadUserFileComplete(bWasSuccessful, UserId, Filename);
        }
        ++ Index;
        goto J0x0B;
    }
}

function AddReadUserFileCompleteDelegate(delegate<OnReadUserFileComplete> ReadUserFileCompleteDelegate)
{
    if(ReadUserFileCompleteDelegates.Find(ReadUserFileCompleteDelegate == -1)
    {
        ReadUserFileCompleteDelegates.AddItem(ReadUserFileCompleteDelegate;
    }
}

function ClearReadUserFileCompleteDelegate(delegate<OnReadUserFileComplete> ReadUserFileCompleteDelegate)
{
    local int RemoveIndex;

    RemoveIndex = ReadUserFileCompleteDelegates.Find(ReadUserFileCompleteDelegate;
    if(RemoveIndex != -1)
    {
        ReadUserFileCompleteDelegates.Remove(RemoveIndex, 1;
    }
}

function bool WriteUserFile(string UserId, string Filename, const out array<byte> FileContents)
{
    local int EntryIdx, FileIdx;
    local string URL;
    local bool bPending;

    if(((Len(UserId) > 0) && Len(Filename) > 0) && FileContents.Length > 0)
    {
        EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
        if(EntryIdx == -1)
        {
            EntryIdx = UserCloudFileRequests.Length;
            UserCloudFileRequests.Length = EntryIdx + 1;
            UserCloudFileRequests[EntryIdx].UserId = UserId;
        }
        FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Find('Filename', Filename;
        if(FileIdx == -1)
        {
            FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Length;
            UserCloudFileRequests[EntryIdx].DownloadedFiles.Length = FileIdx + 1;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Filename = Filename;
        }
        if((UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState != 1) && UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest == none)
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 1;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Data = FileContents;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest = Class'HttpFactory'.static.CreateRequest();
            if(UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest != none)
            {
                URL = ((((((GetBaseURL()) $ WriteCloudFileUrl) $ (GetAppAccessURL())) $ "&uniqueUserId=") $ UserId) $ "&fileName=") $ Filename;
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetURL(URL);
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetVerb("POST");
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetHeader("Content-Type", "multipart/form-data");
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetContent(FileContents);
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.__OnProcessRequestComplete__Delegate = OnHTTPRequestWriteUserFileComplete;
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.ProcessRequest();
                bPending = true;
            }            
        }
        else
        {
            LogInternal(((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "File operation already in progress") $ " UserId=") $ UserId) $ " FileName=") $ Filename);
        }        
    }
    else
    {
        LogInternal(((((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Invalid parameters") $ " UserId=") $ UserId) $ " FileName=") $ Filename) $ " FileContents=") $ string(FileContents.Length));
    }
    if(!bPending)
    {
        CallWriteUserFileCompleteDelegates(false, UserId, Filename);
    }
    return bPending;
}

private final function GetUserFileIndexForRequest(HttpRequestInterface Request, out int UserIdx, out int FileIdx)
{
    UserIdx = 0;
    J0x0B:

    if(UserIdx < UserCloudFileRequests.Length)
    {
        FileIdx = UserCloudFileRequests[UserIdx].DownloadedFiles.Find('HTTPRequest', Request;
        if(FileIdx != -1)
        {
            goto J0x8D;
        }
        ++ UserIdx;
        goto J0x0B;
    }
    J0x8D:

    if(FileIdx == -1)
    {
        UserIdx = -1;
    }
}

private final function OnHTTPRequestWriteUserFileComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local int EntryIdx, FileIdx;
    local string Filename, UserId;
    local bool bResult;

    GetUserFileIndexForRequest(Request, EntryIdx, FileIdx);
    if((EntryIdx != -1) && FileIdx != -1)
    {
        UserId = UserCloudFileRequests[EntryIdx].UserId;
        Filename = UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Filename;
        if((bWasSuccessful && Response != none) && Response.GetResponseCode() == 200)
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 2;
            bResult = true;            
        }
        else
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 3;
        }
        UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest = none;        
    }
    else
    {
        LogInternal(((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find entry index");
    }
    CallWriteUserFileCompleteDelegates(bResult, UserId, Filename);
}

delegate OnWriteUserFileComplete(bool bWasSuccessful, string UserId, string Filename);

private final function CallWriteUserFileCompleteDelegates(bool bWasSuccessful, string UserId, string Filename)
{
    local int Index;
    local delegate<OnWriteUserFileComplete> CallDelegate;

    Index = 0;
    J0x0B:

    if(Index < WriteUserFileCompleteDelegates.Length)
    {
        CallDelegate = WriteUserFileCompleteDelegates[Index];
        if(CallDelegate != none)
        {
            OnWriteUserFileComplete(bWasSuccessful, UserId, Filename);
        }
        ++ Index;
        goto J0x0B;
    }
}

function AddWriteUserFileCompleteDelegate(delegate<OnWriteUserFileComplete> WriteUserFileCompleteDelegate)
{
    if(WriteUserFileCompleteDelegates.Find(WriteUserFileCompleteDelegate == -1)
    {
        WriteUserFileCompleteDelegates.AddItem(WriteUserFileCompleteDelegate;
    }
}

function ClearWriteUserFileCompleteDelegate(delegate<OnWriteUserFileComplete> WriteUserFileCompleteDelegate)
{
    local int RemoveIndex;

    RemoveIndex = WriteUserFileCompleteDelegates.Find(WriteUserFileCompleteDelegate;
    if(RemoveIndex != -1)
    {
        WriteUserFileCompleteDelegates.Remove(RemoveIndex, 1;
    }
}

function bool DeleteUserFile(string UserId, string Filename, bool bShouldCloudDelete, bool bShouldLocallyDelete)
{
    local int EntryIdx, FileIdx;
    local string URL;
    local bool bPending;

    if(((Len(UserId) > 0) && Len(Filename) > 0) && bShouldCloudDelete)
    {
        EntryIdx = UserCloudFileRequests.Find('UserId', UserId;
        if(EntryIdx == -1)
        {
            EntryIdx = UserCloudFileRequests.Length;
            UserCloudFileRequests.Length = EntryIdx + 1;
            UserCloudFileRequests[EntryIdx].UserId = UserId;
        }
        FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Find('Filename', Filename;
        if(FileIdx == -1)
        {
            FileIdx = UserCloudFileRequests[EntryIdx].DownloadedFiles.Length;
            UserCloudFileRequests[EntryIdx].DownloadedFiles.Length = FileIdx + 1;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Filename = Filename;
        }
        if((UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState != 1) && UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest == none)
        {
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].AsyncState = 1;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Data.Length = 0;
            UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest = Class'HttpFactory'.static.CreateRequest();
            if(UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest != none)
            {
                URL = ((((((GetBaseURL()) $ DeleteCloudFileUrl) $ (GetAppAccessURL())) $ "&uniqueUserId=") $ UserId) $ "&fileName=") $ Filename;
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetURL(URL);
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.SetVerb("DELETE");
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.__OnProcessRequestComplete__Delegate = OnHTTPRequestDeleteUserFileComplete;
                UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].HTTPRequest.ProcessRequest();
                bPending = true;
            }            
        }
        else
        {
            LogInternal(((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "File operation already in progress") $ " UserId=") $ UserId) $ " FileName=") $ Filename);
        }        
    }
    else
    {
        LogInternal(((((((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Invalid parameters") $ " UserId=") $ UserId) $ " FileName=") $ Filename);
    }
    if(!bPending)
    {
        if(bShouldCloudDelete)
        {
            CallDeleteUserFileCompleteDelegates(false, UserId, Filename);            
        }
        else
        {
            if(bShouldLocallyDelete)
            {
                CallDeleteUserFileCompleteDelegates(true, UserId, Filename);
            }
        }
    }
    return bPending;
}

private final function OnHTTPRequestDeleteUserFileComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local int EntryIdx, FileIdx;
    local string Filename, UserId;
    local bool bResult;

    GetUserFileIndexForRequest(Request, EntryIdx, FileIdx);
    if((EntryIdx != -1) && FileIdx != -1)
    {
        UserId = UserCloudFileRequests[EntryIdx].UserId;
        Filename = UserCloudFileRequests[EntryIdx].DownloadedFiles[FileIdx].Filename;
        if((bWasSuccessful && Response != none) && Response.GetResponseCode() == 200)
        {
            bResult = true;
        }
        UserCloudFileRequests[EntryIdx].DownloadedFiles.Remove(FileIdx, 1;        
    }
    else
    {
        LogInternal(((((("(" $ string(Name)) $ ") McpUserCloudFileDownload::") $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find entry index");
    }
    CallDeleteUserFileCompleteDelegates(bResult, UserId, Filename);
}

delegate OnDeleteUserFileComplete(bool bWasSuccessful, string UserId, string Filename);

private final function CallDeleteUserFileCompleteDelegates(bool bWasSuccessful, string UserId, string Filename)
{
    local int Index;
    local delegate<OnDeleteUserFileComplete> CallDelegate;

    Index = 0;
    J0x0B:

    if(Index < DeleteUserFileCompleteDelegates.Length)
    {
        CallDelegate = DeleteUserFileCompleteDelegates[Index];
        if(CallDelegate != none)
        {
            OnDeleteUserFileComplete(bWasSuccessful, UserId, Filename);
        }
        ++ Index;
        goto J0x0B;
    }
}

function AddDeleteUserFileCompleteDelegate(delegate<OnDeleteUserFileComplete> DeleteUserFileCompleteDelegate)
{
    if(DeleteUserFileCompleteDelegates.Find(DeleteUserFileCompleteDelegate == -1)
    {
        DeleteUserFileCompleteDelegates.AddItem(DeleteUserFileCompleteDelegate;
    }
}

function ClearDeleteUserFileCompleteDelegate(delegate<OnDeleteUserFileComplete> DeleteUserFileCompleteDelegate)
{
    local int RemoveIndex;

    RemoveIndex = DeleteUserFileCompleteDelegates.Find(DeleteUserFileCompleteDelegate;
    if(RemoveIndex != -1)
    {
        DeleteUserFileCompleteDelegates.Remove(RemoveIndex, 1;
    }
}

function ClearAllDelegates()
{
    EnumerateUserFilesCompleteDelegates.Length = 0;
    ReadUserFileCompleteDelegates.Length = 0;
    WriteUserFileCompleteDelegates.Length = 0;
    DeleteUserFileCompleteDelegates.Length = 0;
}

defaultproperties
{
    EnumerateCloudFilesUrl="/cloudstoragelist"
    ReadCloudFileUrl="/cloudstoragecontents"
    WriteCloudFileUrl="/cloudstoragesave"
    DeleteCloudFileUrl="/cloudstoragedelete"
}