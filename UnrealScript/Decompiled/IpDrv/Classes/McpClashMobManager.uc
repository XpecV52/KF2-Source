/*******************************************************************************
 * McpClashMobManager generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class McpClashMobManager extends McpClashMobBase
    config(Engine);

struct McpChallengeRequest
{
    var string UniqueChallengeId;
    var HttpRequestInterface HTTPRequest;

    structdefaultproperties
    {
        UniqueChallengeId=""
        HTTPRequest=none
    }
};

struct McpChallengeUserRequest
{
    var string UniqueUserId;
    var array<McpChallengeRequest> ChallengeStatusRequests;
    var array<McpChallengeRequest> ChallengeAcceptRequests;
    var array<McpChallengeRequest> ChallengeUpdateProgressRequests;
    var array<McpChallengeRequest> ChallengeUpdateRewardRequests;

    structdefaultproperties
    {
        UniqueUserId=""
        ChallengeStatusRequests=none
        ChallengeAcceptRequests=none
        ChallengeUpdateProgressRequests=none
        ChallengeUpdateRewardRequests=none
    }
};

var config string ChallengeListUrl;
var config string ChallengeStatusUrl;
var config string ChallengeMultiStatusUrl;
var config string AcceptChallengeUrl;
var config string UpdateChallengeProgressUrl;
var config string UpdateRewardProgressUrl;
var HttpRequestInterface HTTPRequestChallengeList;
var array<McpChallengeUserRequest> ChallengeUserRequests;
var array<McpClashMobChallengeEvent> ChallengeEvents;
var array<McpClashMobChallengeUserStatus> ChallengeUserStatus;
var McpClashMobChallengeUserStatus TempChallengeUserStatus;
var array<McpClashMobChallengeUserStatus> TempChallengeUserStatusArray;
var OnlineTitleFileCacheInterface FileCache;
var McpClashMobFileDownload FileDownloader;

function Init()
{
    super(McpServiceBase).Init();
    if(EqualEqual_InterfaceInterface(FileCache, (none)))
    {
        FileCache = (new Class'TitleFileDownloadCache');
        if(NotEqual_InterfaceInterface(FileCache, (none)))
        {
            FileCache.AddLoadTitleFileCompleteDelegate(OnLoadCachedFileComplete);
        }
    }
    if(FileDownloader == none)
    {
        FileDownloader = new Class'McpClashMobFileDownload';
        FileDownloader.Init();
        if(FileDownloader != none)
        {
            FileDownloader.AddReadTitleFileCompleteDelegate(OnDownloadMcpFileComplete);
        }
    }
}

function QueryChallengeList()
{
    local string URL, ErrorStr;
    local bool bPending;

    if(HTTPRequestChallengeList == none)
    {
        HTTPRequestChallengeList = Class'HttpFactory'.static.CreateRequest();
        if(HTTPRequestChallengeList != none)
        {
            URL = ((GetBaseURL()) $ ChallengeListUrl) $ (GetAppAccessURL());
            HTTPRequestChallengeList.SetURL(URL);
            HTTPRequestChallengeList.SetVerb("GET");
            HTTPRequestChallengeList.__OnProcessRequestComplete__Delegate = OnQueryChallengeListHTTPRequestComplete;
            if(HTTPRequestChallengeList.ProcessRequest())
            {
                bPending = true;                
            }
            else
            {
                ErrorStr = "failed to start request, Url=" $ URL;
            }
        }        
    }
    else
    {
        ErrorStr = "last request is still being processed";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnQueryChallengeListComplete(false, ErrorStr);
    }
}

private final function OnQueryChallengeListHTTPRequestComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local string JSONStr, ErrorStr;
    local bool bResult;

    HTTPRequestChallengeList = none;
    if(bWasSuccessful && Response != none)
    {
        if(Response.GetResponseCode() == 200)
        {
            JSONStr = Response.GetContentAsString();
            ImportJSON("ChallengeEvents", JSONStr);
            bResult = true;            
        }
        else
        {
            ErrorStr = "invalid server response code, status=" $ string(Response.GetResponseCode());
        }        
    }
    else
    {
        ErrorStr = "no response";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    OnQueryChallengeListComplete(bResult, ErrorStr);
}

function GetChallengeList(out array<McpClashMobChallengeEvent> OutChallengeEvents)
{
    OutChallengeEvents = ChallengeEvents;
}

function GetChallengeFileList(string UniqueChallengeId, out array<McpClashMobChallengeFile> OutChallengeFiles)
{
    local int ChallengeEventIdx;

    OutChallengeFiles.Length = 0;
    ChallengeEventIdx = ChallengeEvents.Find('unique_challenge_id', UniqueChallengeId;
    if(ChallengeEventIdx != -1)
    {
        OutChallengeFiles = ChallengeEvents[ChallengeEventIdx].file_list;        
    }
    else
    {
        LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find event entry for") $ " UniqueChallengeId=") $ UniqueChallengeId);
    }
}

function DownloadChallengeFile(string UniqueChallengeId, string DLName)
{
    local string ErrorStr;
    local int ChallengeIdx, FileIdx;
    local bool bPending;

    ChallengeIdx = ChallengeEvents.Find('unique_challenge_id', UniqueChallengeId;
    if(ChallengeIdx != -1)
    {
        FileIdx = ChallengeEvents[ChallengeIdx].file_list.Find('dl_name', DLName;
        if(FileIdx != -1)
        {
            ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status = 1;
            FileCache.ClearCachedFile(DLName);
            FileCache.LoadTitleFile(DLName);
            bPending = true;            
        }
        else
        {
            ErrorStr = ((("Couldn't find file entry for" $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DlName=") $ UniqueChallengeId;
        }        
    }
    else
    {
        ErrorStr = ("Couldn't find event entry for" $ " UniqueChallengeId=") $ UniqueChallengeId;
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnDownloadChallengeFileComplete(false, UniqueChallengeId, DLName, "", ErrorStr);
    }
}

private final function OnLoadCachedFileComplete(bool bWasSuccessful, string DLName)
{
    local bool bRequiresDownload;
    local string FileHashCache, FileHashChallenge, Filename;
    local int ChallengeIdx, FileIdx;
    local array<byte> FileContents;

    ChallengeIdx = 0;
    J0x0B:

    if(ChallengeIdx < ChallengeEvents.Length)
    {
        FileIdx = ChallengeEvents[ChallengeIdx].file_list.Find('dl_name', DLName;
        if(FileIdx != -1)
        {
            goto J0x8D;
        }
        ++ ChallengeIdx;
        goto J0x0B;
    }
    J0x8D:

    if(FileIdx != -1)
    {
        ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status = 3;
        Filename = ChallengeEvents[ChallengeIdx].file_list[FileIdx].file_name;
        bRequiresDownload = true;
        if(bWasSuccessful)
        {
            FileHashChallenge = ChallengeEvents[ChallengeIdx].file_list[FileIdx].hash_code;
            if(Len(FileHashChallenge) > 0)
            {
                FileHashCache = FileCache.GetTitleFileHash(DLName);
                if((FileHashCache == FileHashChallenge) && FileCache.GetTitleFileContents(DLName, FileContents))
                {
                    LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Found challenge file in cache with valid hash. DLName=") $ DLName) @ "in file cache. Not downloading.");
                    ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status = 2;
                    OnDownloadChallengeFileComplete(true, ChallengeEvents[ChallengeIdx].unique_challenge_id, DLName, Filename, "");
                    bRequiresDownload = false;
                }
            }
        }
        if(bRequiresDownload)
        {
            LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Did not find challenge file DLName=") $ DLName) @ "in file cache with valid hash. Starting download.");
            ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status = 1;
            FileCache.DeleteTitleFile(DLName);
            FileDownloader.ClearDownloadedFile(DLName);
            FileDownloader.ReadTitleFile(DLName);
        }        
    }
    else
    {
        LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Could not find DLName=") $ DLName) @ "for challenge");
    }
}

function OnDownloadMcpFileComplete(bool bWasSuccessful, string DLName)
{
    local array<byte> FileContents;
    local int ChallengeIdx, FileIdx;
    local string Filename;

    ChallengeIdx = 0;
    J0x0B:

    if(ChallengeIdx < ChallengeEvents.Length)
    {
        FileIdx = ChallengeEvents[ChallengeIdx].file_list.Find('dl_name', DLName;
        if(FileIdx != -1)
        {
            goto J0x8D;
        }
        ++ ChallengeIdx;
        goto J0x0B;
    }
    J0x8D:

    if(FileIdx != -1)
    {
        if(bWasSuccessful && FileDownloader.GetTitleFileContents(DLName, FileContents))
        {
            LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Downloaded challenge file. DLName=") $ DLName) @ ". Copying to file cache.");
            ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status = 2;
            Filename = ChallengeEvents[ChallengeIdx].file_list[FileIdx].file_name;
            FileCache.SaveTitleFile(DLName, ChallengeEvents[ChallengeIdx].file_list[FileIdx].file_name, FileContents);
            FileDownloader.ClearDownloadedFile(DLName);
            OnDownloadChallengeFileComplete(true, ChallengeEvents[ChallengeIdx].unique_challenge_id, DLName, Filename, "");            
        }
        else
        {
            ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status = 3;
            OnDownloadChallengeFileComplete(false, ChallengeEvents[ChallengeIdx].unique_challenge_id, DLName, Filename, "FileNotFound");
        }        
    }
    else
    {
        LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Could not find DLName=") $ DLName) @ "for challenge");
    }
}

function GetChallengeFileContents(string UniqueChallengeId, string DLName, out array<byte> OutFileContents)
{
    local int ChallengeIdx, FileIdx;

    OutFileContents.Length = 0;
    ChallengeIdx = ChallengeEvents.Find('unique_challenge_id', UniqueChallengeId;
    if(ChallengeIdx != -1)
    {
        FileIdx = ChallengeEvents[ChallengeIdx].file_list.Find('dl_name', DLName;
        if(FileIdx != -1)
        {
            if((ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status != 2) || !FileCache.GetTitleFileContents(DLName, OutFileContents))
            {
                LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "No data loaded for file entry.") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DLName=") $ DLName);
            }            
        }
        else
        {
            LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find file entry.") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DLName=") $ DLName);
        }        
    }
    else
    {
        LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find event entry.") $ " UniqueChallengeId=") $ UniqueChallengeId);
    }
}

function ClearCachedChallengeFile(string UniqueChallengeId, string DLName)
{
    local int ChallengeIdx, FileIdx;

    ChallengeIdx = ChallengeEvents.Find('unique_challenge_id', UniqueChallengeId;
    if(ChallengeIdx != -1)
    {
        FileIdx = ChallengeEvents[ChallengeIdx].file_list.Find('dl_name', DLName;
        if(FileIdx != -1)
        {
            if(ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status != 1)
            {
                FileCache.ClearCachedFile(DLName);                
            }
            else
            {
                LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Can't clear. File download pending.") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DLName=") $ DLName);
            }            
        }
        else
        {
            LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find file entry.") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DLName=") $ DLName);
        }        
    }
    else
    {
        LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find event entry.") $ " UniqueChallengeId=") $ UniqueChallengeId);
    }
}

function DeleteCachedChallengeFile(string UniqueChallengeId, string DLName)
{
    local int ChallengeIdx, FileIdx;

    ChallengeIdx = ChallengeEvents.Find('unique_challenge_id', UniqueChallengeId;
    if(ChallengeIdx != -1)
    {
        FileIdx = ChallengeEvents[ChallengeIdx].file_list.Find('dl_name', DLName;
        if(FileIdx != -1)
        {
            if(ChallengeEvents[ChallengeIdx].file_list[FileIdx].Status != 1)
            {
                FileCache.DeleteTitleFile(DLName);                
            }
            else
            {
                LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Can't delete. File download pending.") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DLName=") $ DLName);
            }            
        }
        else
        {
            LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find file entry.") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " DLName=") $ DLName);
        }        
    }
    else
    {
        LogInternal(((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find event entry.") $ " UniqueChallengeId=") $ UniqueChallengeId);
    }
}

function AcceptChallenge(string UniqueChallengeId, string UniqueUserId)
{
    local string URL, ErrorStr;
    local int ChallengeQueryIdx, UserQueryIdx;
    local bool bPending;
    local HttpRequestInterface Request;

    UserQueryIdx = ChallengeUserRequests.Find('UniqueUserId', UniqueUserId;
    if(UserQueryIdx == -1)
    {
        UserQueryIdx = ChallengeUserRequests.Length;
        ChallengeUserRequests.Length = ChallengeUserRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].UniqueUserId = UniqueUserId;
    }
    ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests.Find('UniqueChallengeId', UniqueChallengeId;
    if(ChallengeQueryIdx == -1)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests.Length;
        ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests.Length = ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests[ChallengeQueryIdx].UniqueChallengeId = UniqueChallengeId;
    }
    if(ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests[ChallengeQueryIdx].HTTPRequest == none)
    {
        Request = Class'HttpFactory'.static.CreateRequest();
        if(Request != none)
        {
            ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests[ChallengeQueryIdx].HTTPRequest = Request;
            URL = ((((((GetBaseURL()) $ AcceptChallengeUrl) $ (GetAppAccessURL())) $ "&uniqueChallengeId=") $ UniqueChallengeId) $ "&uniqueUserId=") $ UniqueUserId;
            Request.SetURL(URL);
            Request.SetVerb("POST");
            Request.SetHeader("Content-Type", "multipart/form-data");
            Request.__OnProcessRequestComplete__Delegate = OnAcceptChallengeHTTPRequestComplete;
            if(Request.ProcessRequest())
            {
                bPending = true;                
            }
            else
            {
                ErrorStr = "failed to start request, Url=" $ URL;
            }
        }        
    }
    else
    {
        ErrorStr = "last request is still being processed";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnAcceptChallengeComplete(false, UniqueChallengeId, UniqueUserId, ErrorStr);
    }
}

private final function OnAcceptChallengeHTTPRequestComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local string UniqueChallengeId, UniqueUserId, ErrorStr;
    local bool bResult;
    local int UserQueryIdx, ChallengeQueryIdx;

    UserQueryIdx = 0;
    J0x0B:

    if(UserQueryIdx < ChallengeUserRequests.Length)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests.Find('HTTPRequest', Request;
        if(ChallengeQueryIdx != -1)
        {
            goto J0x8D;
        }
        ++ UserQueryIdx;
        goto J0x0B;
    }
    J0x8D:

    if((UserQueryIdx != -1) && ChallengeQueryIdx != -1)
    {
        ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests[ChallengeQueryIdx].HTTPRequest = none;
        UniqueUserId = ChallengeUserRequests[UserQueryIdx].UniqueUserId;
        UniqueChallengeId = ChallengeUserRequests[UserQueryIdx].ChallengeAcceptRequests[ChallengeQueryIdx].UniqueChallengeId;
        if(bWasSuccessful && Response != none)
        {
            if(Response.GetResponseCode() == 200)
            {
                bResult = true;                
            }
            else
            {
                ErrorStr = "invalid server response code, status=" $ string(Response.GetResponseCode());
            }            
        }
        else
        {
            ErrorStr = "no response";
        }        
    }
    else
    {
        ErrorStr = "couldn't find user/challenge entry for request";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    OnAcceptChallengeComplete(bResult, UniqueChallengeId, UniqueUserId, ErrorStr);
}

function QueryChallengeUserStatus(string UniqueChallengeId, string UniqueUserId)
{
    local string URL, ErrorStr;
    local int ChallengeQueryIdx, UserQueryIdx;
    local bool bPending;
    local HttpRequestInterface Request;

    UserQueryIdx = ChallengeUserRequests.Find('UniqueUserId', UniqueUserId;
    if(UserQueryIdx == -1)
    {
        UserQueryIdx = ChallengeUserRequests.Length;
        ChallengeUserRequests.Length = ChallengeUserRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].UniqueUserId = UniqueUserId;
    }
    ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Find('UniqueChallengeId', UniqueChallengeId;
    if(ChallengeQueryIdx == -1)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Length;
        ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Length = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].UniqueChallengeId = UniqueChallengeId;
    }
    if(ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].HTTPRequest == none)
    {
        Request = Class'HttpFactory'.static.CreateRequest();
        if(Request != none)
        {
            ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].HTTPRequest = Request;
            URL = ((((((GetBaseURL()) $ ChallengeStatusUrl) $ (GetAppAccessURL())) $ "&uniqueChallengeId=") $ UniqueChallengeId) $ "&uniqueUserId=") $ UniqueUserId;
            Request.SetURL(URL);
            Request.SetVerb("POST");
            Request.SetHeader("Content-Type", "multipart/form-data");
            Request.__OnProcessRequestComplete__Delegate = OnQueryChallengeStatusHTTPRequestComplete;
            if(Request.ProcessRequest())
            {
                bPending = true;                
            }
            else
            {
                ErrorStr = "failed to start request, Url=" $ URL;
            }
        }        
    }
    else
    {
        ErrorStr = "last request is still being processed";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnQueryChallengeUserStatusComplete(false, UniqueChallengeId, UniqueUserId, ErrorStr);
    }
}

private final function OnQueryChallengeStatusHTTPRequestComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local string JSONStr, UniqueChallengeId, UniqueUserId, ErrorStr;
    local bool bResult;
    local int UserQueryIdx, ChallengeQueryIdx, UserStatusIdx;

    UserQueryIdx = 0;
    J0x0B:

    if(UserQueryIdx < ChallengeUserRequests.Length)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Find('HTTPRequest', Request;
        if(ChallengeQueryIdx != -1)
        {
            goto J0x8D;
        }
        ++ UserQueryIdx;
        goto J0x0B;
    }
    J0x8D:

    if((UserQueryIdx < ChallengeUserRequests.Length) && ChallengeQueryIdx != -1)
    {
        ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].HTTPRequest = none;
        UniqueUserId = ChallengeUserRequests[UserQueryIdx].UniqueUserId;
        UniqueChallengeId = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].UniqueChallengeId;
        if(bWasSuccessful && Response != none)
        {
            if(Response.GetResponseCode() == 200)
            {
                JSONStr = Response.GetContentAsString();
                if(Len(JSONStr) > 0)
                {
                    ImportJSON("TempChallengeUserStatus", JSONStr);
                    if(Len(TempChallengeUserStatus.unique_challenge_id) > 0)
                    {
                        UserStatusIdx = 0;
                        J0x255:

                        if(UserStatusIdx < ChallengeUserStatus.Length)
                        {
                            if((ChallengeUserStatus[UserStatusIdx].unique_challenge_id == UniqueChallengeId) && ChallengeUserStatus[UserStatusIdx].unique_user_id == UniqueUserId)
                            {
                                goto J0x2E8;
                            }
                            ++ UserStatusIdx;
                            goto J0x255;
                        }
                        J0x2E8:

                        if(UserStatusIdx == ChallengeUserStatus.Length)
                        {
                            ChallengeUserStatus.Length = ChallengeUserStatus.Length + 1;
                        }
                        ChallengeUserStatus[UserStatusIdx] = TempChallengeUserStatus;
                    }
                    bResult = true;                    
                }
                else
                {
                    ErrorStr = "no JSON response";
                }                
            }
            else
            {
                ErrorStr = "invalid server response code, status=" $ string(Response.GetResponseCode());
            }            
        }
        else
        {
            ErrorStr = "no response";
        }        
    }
    else
    {
        ErrorStr = "couldn't find user/challenge entry for request";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    OnQueryChallengeUserStatusComplete(bResult, UniqueChallengeId, UniqueUserId, ErrorStr);
}

function QueryChallengeMultiUserStatus(string UniqueChallengeId, string UniqueUserId, const out array<string> UserIdsToRead)
{
    local string URL, ErrorStr, JSONStr;
    local int ChallengeQueryIdx, UserQueryIdx, UserIdIdx;
    local bool bPending;
    local HttpRequestInterface Request;

    UserQueryIdx = ChallengeUserRequests.Find('UniqueUserId', UniqueUserId;
    if(UserQueryIdx == -1)
    {
        UserQueryIdx = ChallengeUserRequests.Length;
        ChallengeUserRequests.Length = ChallengeUserRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].UniqueUserId = UniqueUserId;
    }
    ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Find('UniqueChallengeId', UniqueChallengeId;
    if(ChallengeQueryIdx == -1)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Length;
        ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Length = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].UniqueChallengeId = UniqueChallengeId;
    }
    if(ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].HTTPRequest == none)
    {
        Request = Class'HttpFactory'.static.CreateRequest();
        if(Request != none)
        {
            ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].HTTPRequest = Request;
            JSONStr = "[ ";
            UserIdIdx = 0;
            J0x2A8:

            if(UserIdIdx < UserIdsToRead.Length)
            {                
                JSONStr $= (("\"" $ UserIdsToRead[UserIdIdx]) $ "\"");
                if((UserIdIdx + 1) < UserIdsToRead.Length)
                {                    
                    JSONStr $= ",";
                }
                ++ UserIdIdx;
                goto J0x2A8;
            }            
            JSONStr $= " ]";
            Request.SetContentAsString(JSONStr);
            URL = ((((((GetBaseURL()) $ ChallengeMultiStatusUrl) $ (GetAppAccessURL())) $ "&uniqueChallengeId=") $ UniqueChallengeId) $ "&uniqueUserId=") $ UniqueUserId;
            Request.SetURL(URL);
            Request.SetVerb("POST");
            Request.SetHeader("Content-Type", "multipart/form-data");
            Request.__OnProcessRequestComplete__Delegate = OnQueryChallengeMultiStatusHTTPRequestComplete;
            if(Request.ProcessRequest())
            {
                bPending = true;                
            }
            else
            {
                ErrorStr = "failed to start request, Url=" $ URL;
            }
        }        
    }
    else
    {
        ErrorStr = "last request is still being processed";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnQueryChallengeUserStatusComplete(false, UniqueChallengeId, UniqueUserId, ErrorStr);
    }
}

private final function OnQueryChallengeMultiStatusHTTPRequestComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local string JSONStr, UniqueChallengeId, UniqueUserId, ErrorStr;
    local bool bResult;
    local int UserQueryIdx, ChallengeQueryIdx, UserStatusIdx, TempUserStatusIdx;

    UserQueryIdx = 0;
    J0x0B:

    if(UserQueryIdx < ChallengeUserRequests.Length)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests.Find('HTTPRequest', Request;
        if(ChallengeQueryIdx != -1)
        {
            goto J0x8D;
        }
        ++ UserQueryIdx;
        goto J0x0B;
    }
    J0x8D:

    if((UserQueryIdx < ChallengeUserRequests.Length) && ChallengeQueryIdx != -1)
    {
        ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].HTTPRequest = none;
        UniqueUserId = ChallengeUserRequests[UserQueryIdx].UniqueUserId;
        UniqueChallengeId = ChallengeUserRequests[UserQueryIdx].ChallengeStatusRequests[ChallengeQueryIdx].UniqueChallengeId;
        if(bWasSuccessful && Response != none)
        {
            if(Response.GetResponseCode() == 200)
            {
                JSONStr = Response.GetContentAsString();
                if(Len(JSONStr) > 0)
                {
                    TempChallengeUserStatusArray.Length = 0;
                    ImportJSON("TempChallengeUserStatusArray", JSONStr);
                    if(TempChallengeUserStatusArray.Length > 0)
                    {
                        TempUserStatusIdx = 0;
                        J0x252:

                        if(TempUserStatusIdx < TempChallengeUserStatusArray.Length)
                        {
                            UserStatusIdx = 0;
                            J0x275:

                            if(UserStatusIdx < ChallengeUserStatus.Length)
                            {
                                if((ChallengeUserStatus[UserStatusIdx].unique_challenge_id == TempChallengeUserStatusArray[TempUserStatusIdx].unique_challenge_id) && ChallengeUserStatus[UserStatusIdx].unique_user_id == TempChallengeUserStatusArray[TempUserStatusIdx].unique_user_id)
                                {
                                    goto J0x342;
                                }
                                ++ UserStatusIdx;
                                goto J0x275;
                            }
                            J0x342:

                            if(UserStatusIdx == ChallengeUserStatus.Length)
                            {
                                ChallengeUserStatus.Length = ChallengeUserStatus.Length + 1;
                            }
                            ChallengeUserStatus[UserStatusIdx] = TempChallengeUserStatusArray[TempUserStatusIdx];
                            ++ TempUserStatusIdx;
                            goto J0x252;
                        }
                    }
                    bResult = true;                    
                }
                else
                {
                    ErrorStr = "no JSON response";
                }                
            }
            else
            {
                ErrorStr = "invalid server response code, status=" $ string(Response.GetResponseCode());
            }            
        }
        else
        {
            ErrorStr = "no response";
        }        
    }
    else
    {
        ErrorStr = "couldn't find user/challenge entry for request";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    OnQueryChallengeUserStatusComplete(bResult, UniqueChallengeId, UniqueUserId, ErrorStr);
}

function GetChallengeUserStatus(string UniqueChallengeId, string UniqueUserId, out McpClashMobChallengeUserStatus OutChallengeUserStatus)
{
    local int UserStatusIdx;
    local McpClashMobChallengeUserStatus DefaultStatus;

    UserStatusIdx = 0;
    J0x0B:

    if(UserStatusIdx < ChallengeUserStatus.Length)
    {
        if((ChallengeUserStatus[UserStatusIdx].unique_challenge_id == UniqueChallengeId) && ChallengeUserStatus[UserStatusIdx].unique_user_id == UniqueUserId)
        {
            goto J0x9E;
        }
        ++ UserStatusIdx;
        goto J0x0B;
    }
    J0x9E:

    if(UserStatusIdx < ChallengeUserStatus.Length)
    {
        OutChallengeUserStatus = ChallengeUserStatus[UserStatusIdx];        
    }
    else
    {
        OutChallengeUserStatus = DefaultStatus;
        OutChallengeUserStatus.unique_challenge_id = UniqueChallengeId;
        OutChallengeUserStatus.unique_user_id = UniqueUserId;
        LogInternal(((((((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ "Couldn't find user status for") $ " UniqueChallengeId=") $ UniqueChallengeId) $ " UniqueUserId=") $ UniqueUserId);
    }
}

function UpdateChallengeUserProgress(string UniqueChallengeId, string UniqueUserId, bool bDidComplete, int GoalProgress)
{
    local string URL, ErrorStr;
    local int ChallengeQueryIdx, UserQueryIdx;
    local bool bPending;
    local HttpRequestInterface Request;

    UserQueryIdx = ChallengeUserRequests.Find('UniqueUserId', UniqueUserId;
    if(UserQueryIdx == -1)
    {
        UserQueryIdx = ChallengeUserRequests.Length;
        ChallengeUserRequests.Length = ChallengeUserRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].UniqueUserId = UniqueUserId;
    }
    ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests.Find('UniqueChallengeId', UniqueChallengeId;
    if(ChallengeQueryIdx == -1)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests.Length;
        ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests.Length = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests[ChallengeQueryIdx].UniqueChallengeId = UniqueChallengeId;
    }
    if(ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests[ChallengeQueryIdx].HTTPRequest == none)
    {
        Request = Class'HttpFactory'.static.CreateRequest();
        if(Request != none)
        {
            ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests[ChallengeQueryIdx].HTTPRequest = Request;
            URL = ((((((((((GetBaseURL()) $ UpdateChallengeProgressUrl) $ (GetAppAccessURL())) $ "&uniqueChallengeId=") $ UniqueChallengeId) $ "&uniqueUserId=") $ UniqueUserId) $ "&didComplete=") $ string(bDidComplete)) $ "&goalProgress=") $ string(GoalProgress);
            Request.SetURL(URL);
            Request.SetVerb("POST");
            Request.SetHeader("Content-Type", "multipart/form-data");
            Request.__OnProcessRequestComplete__Delegate = OnUpdateChallengeUserProgressHTTPRequestComplete;
            if(Request.ProcessRequest())
            {
                bPending = true;                
            }
            else
            {
                ErrorStr = "failed to start request, Url=" $ URL;
            }
        }        
    }
    else
    {
        ErrorStr = "last request is still being processed";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnUpdateChallengeUserProgressComplete(false, UniqueChallengeId, UniqueUserId, ErrorStr);
    }
}

private final function OnUpdateChallengeUserProgressHTTPRequestComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local string UniqueChallengeId, UniqueUserId, ErrorStr;
    local bool bResult;
    local int UserQueryIdx, ChallengeQueryIdx;

    UserQueryIdx = 0;
    J0x0B:

    if(UserQueryIdx < ChallengeUserRequests.Length)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests.Find('HTTPRequest', Request;
        if(ChallengeQueryIdx != -1)
        {
            goto J0x8D;
        }
        ++ UserQueryIdx;
        goto J0x0B;
    }
    J0x8D:

    if((UserQueryIdx != -1) && ChallengeQueryIdx != -1)
    {
        ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests[ChallengeQueryIdx].HTTPRequest = none;
        UniqueUserId = ChallengeUserRequests[UserQueryIdx].UniqueUserId;
        UniqueChallengeId = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateProgressRequests[ChallengeQueryIdx].UniqueChallengeId;
        if(bWasSuccessful && Response != none)
        {
            if(Response.GetResponseCode() == 200)
            {
                bResult = true;                
            }
            else
            {
                ErrorStr = "invalid server response code, status=" $ string(Response.GetResponseCode());
            }            
        }
        else
        {
            ErrorStr = "no response";
        }        
    }
    else
    {
        ErrorStr = "couldn't find user/challenge entry for request";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    OnUpdateChallengeUserProgressComplete(bResult, UniqueChallengeId, UniqueUserId, ErrorStr);
}

function UpdateChallengeUserReward(string UniqueChallengeId, string UniqueUserId, int UserReward)
{
    local string URL, ErrorStr;
    local int ChallengeQueryIdx, UserQueryIdx;
    local bool bPending;
    local HttpRequestInterface Request;

    UserQueryIdx = ChallengeUserRequests.Find('UniqueUserId', UniqueUserId;
    if(UserQueryIdx == -1)
    {
        UserQueryIdx = ChallengeUserRequests.Length;
        ChallengeUserRequests.Length = ChallengeUserRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].UniqueUserId = UniqueUserId;
    }
    ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests.Find('UniqueChallengeId', UniqueChallengeId;
    if(ChallengeQueryIdx == -1)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests.Length;
        ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests.Length = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests.Length + 1;
        ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests[ChallengeQueryIdx].UniqueChallengeId = UniqueChallengeId;
    }
    if(ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests[ChallengeQueryIdx].HTTPRequest == none)
    {
        Request = Class'HttpFactory'.static.CreateRequest();
        if(Request != none)
        {
            ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests[ChallengeQueryIdx].HTTPRequest = Request;
            URL = ((((((((GetBaseURL()) $ UpdateRewardProgressUrl) $ (GetAppAccessURL())) $ "&uniqueChallengeId=") $ UniqueChallengeId) $ "&uniqueUserId=") $ UniqueUserId) $ "&userAwardGiven=") $ string(UserReward);
            Request.SetURL(URL);
            Request.SetVerb("POST");
            Request.SetHeader("Content-Type", "multipart/form-data");
            Request.__OnProcessRequestComplete__Delegate = OnUpdateChallengeUserRewardHTTPRequestComplete;
            if(Request.ProcessRequest())
            {
                bPending = true;                
            }
            else
            {
                ErrorStr = "failed to start request, Url=" $ URL;
            }
        }        
    }
    else
    {
        ErrorStr = "last request is still being processed";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    if(!bPending)
    {
        OnUpdateChallengeUserRewardComplete(false, UniqueChallengeId, UniqueUserId, ErrorStr);
    }
}

private final function OnUpdateChallengeUserRewardHTTPRequestComplete(HttpRequestInterface Request, HttpResponseInterface Response, bool bWasSuccessful)
{
    local string UniqueChallengeId, UniqueUserId, ErrorStr;
    local bool bResult;
    local int UserQueryIdx, ChallengeQueryIdx;

    UserQueryIdx = 0;
    J0x0B:

    if(UserQueryIdx < ChallengeUserRequests.Length)
    {
        ChallengeQueryIdx = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests.Find('HTTPRequest', Request;
        if(ChallengeQueryIdx != -1)
        {
            goto J0x8D;
        }
        ++ UserQueryIdx;
        goto J0x0B;
    }
    J0x8D:

    if((UserQueryIdx != -1) && ChallengeQueryIdx != -1)
    {
        ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests[ChallengeQueryIdx].HTTPRequest = none;
        UniqueUserId = ChallengeUserRequests[UserQueryIdx].UniqueUserId;
        UniqueChallengeId = ChallengeUserRequests[UserQueryIdx].ChallengeUpdateRewardRequests[ChallengeQueryIdx].UniqueChallengeId;
        if(bWasSuccessful && Response != none)
        {
            if(Response.GetResponseCode() == 200)
            {
                bResult = true;                
            }
            else
            {
                ErrorStr = "invalid server response code, status=" $ string(Response.GetResponseCode());
            }            
        }
        else
        {
            ErrorStr = "no response";
        }        
    }
    else
    {
        ErrorStr = "couldn't find user/challenge entry for request";
    }
    if(Len(ErrorStr) > 0)
    {
        LogInternal(((("McpClashMobManager::" $ string(GetStateName())) $ ":") $ string(GetFuncName())) @ ErrorStr);
    }
    OnUpdateChallengeUserRewardComplete(bResult, UniqueChallengeId, UniqueUserId, ErrorStr);
}

defaultproperties
{
    ChallengeListUrl="/challengelist"
    ChallengeStatusUrl="/challengestatus"
    ChallengeMultiStatusUrl="/challengemultiplestatus"
    AcceptChallengeUrl="/acceptchallenge"
    UpdateChallengeProgressUrl="/updatechallenge"
    UpdateRewardProgressUrl="/updatereward"
}