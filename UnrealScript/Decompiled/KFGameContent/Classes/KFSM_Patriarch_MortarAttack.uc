/*******************************************************************************
 * KFSM_Patriarch_MortarAttack generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFSM_Patriarch_MortarAttack extends KFSM_Patriarch_MissileAttack;

var bool bIsBarrage;
var int NumBarrages;
var int MaxBarrages;
var name BarrageFireAnimName;

function SpecialMoveStarted(bool bForced, name PrevMove)
{
    super.SpecialMoveStarted(bForced, PrevMove);
    bIsBarrage = MyPatPawn.SpecialMoveFlags == 2;
    if(bIsBarrage)
    {
        AnimName = BarrageFireAnimName;
    }
    NumBarrages = 0;
}

function GetAimDirAndTargetLoc(int MissileNum, Vector MissileLoc, Rotator MissileRot, out Vector AimDir, out Vector TargetLoc)
{
    local Patriarch_MortarTarget MissileTarget;
    local Vector X, Y, Z;

    GetAxes(MissileRot, X, Y, Z);
    MissileTarget = MyPatController.GetMortarTarget(MissileNum);
    TargetLoc = MissileTarget.TargetPawn.Location + (vect(0, 0, -1) * MissileTarget.TargetPawn.GetCollisionHeight());
    AimDir = Normal(vect(0, 0, 1) + Normal(MissileTarget.TargetVelocity));
    InitialMissileSpeed = VSize(MissileTarget.TargetVelocity);
}

function PlayFireAnimation()
{
    if(MyPatPawn == none)
    {
        return;
    }
    if(bIsBarrage)
    {
        BlendOutTime = 0;
    }
    bUseRootMotion = false;
    MyPatPawn.Mesh.RootMotionMode = MyPatPawn.Mesh.default.RootMotionMode;
    MyPatPawn.RotationRate = MissileFireRotationRate;
    MyPatPawn.BodyStanceNodes[0].SetRootBoneAxisOption(1, 1, 1);
    PlaySpecialMoveAnim(AnimName, 1, 0, BlendOutTime, 1);
    MyPatPawn.BodyStanceNodes[1].GetCustomAnimNodeSeq().SetPosition(0, false);
    if(MyPatPawn.Role == ROLE_Authority)
    {
        FireMissiles();
    }
    MyPatPawn.PostAkEventOnBone(FireSound, 'BarrelSpinner', true, true);
    MyPatPawn.ZeroMovementVariables();
    if(bIsBarrage && !MyPatPawn.IsTimerActive('Timer_FireBarrage', self))
    {
        MyPatPawn.SetTimer(0.75, true, 'Timer_FireBarrage', self);
    }
}

function FireMissiles()
{
    if(MyPatController != none)
    {
        if(!bIsBarrage)
        {
            MyPatController.ClearMortarTargets();
            MyPatController.CollectMortarTargets(true, true);
        }
        MyPatController.CollectMortarTargets();
        if(MyPatController.MortarTargets.Length == 0)
        {
            MyPatPawn.EndSpecialMove();
            return;
        }
    }
    super.FireMissiles();
    MyPatController.ClearMortarTargets();
}

function Timer_FireBarrage()
{
    ++ NumBarrages;
    if(MyPatController != none)
    {
        MyPatController = KFAIController_ZedPatriarch(MyPatPawn.Controller);
        MyPatController.CollectMortarTargets(true, true);
    }
    if(NumBarrages >= MaxBarrages)
    {
        MyPatPawn.ClearTimer('Timer_FireBarrage', self);
        bIsBarrage = false;
        AnimName = default.AnimName;
        BlendOutTime = default.BlendOutTime;
    }
    PlayFireAnimation();
}

function AnimEndNotify(AnimNodeSequence SeqNode, float PlayedTime, float ExcessTime)
{
    if(MyPatPawn.IsTimerActive('Timer_FireBarrage', self))
    {
        return;
    }
    super.AnimEndNotify(SeqNode, PlayedTime, ExcessTime);
}

function SpecialMoveEnded(name PrevMove, name NextMove)
{
    if(MyPatPawn != none)
    {
        MyPatPawn.ClearTimer('Timer_FireBarrage', self);
        MyPatPawn.RotationRate = MyPatPawn.default.RotationRate;
    }
    super.SpecialMoveEnded(PrevMove, NextMove);
}

defaultproperties
{
    MaxBarrages=5
    BarrageFireAnimName=Mortar_rapidfire
    MissileClass=Class'KFProj_Mortar_Patriarch'
    LoadAnimNames[0]=Mortar_TO_Load
    LoadAnimNames[1]=Mortar_TO_LoadQ
    bAllowGunTracking=false
    bMissileFlocking=false
    SeekDelay=0.1
    SeekForce=25
    FireSound=AkEvent'WW_ZED_Patriarch.Play_Mortar_Shot'
    AnimName=Mortar_Shoot
    bDisableSteering=true
    bDisableTurnInPlace=true
    Handle=KFSM_Patriarch_MortarAttack
}