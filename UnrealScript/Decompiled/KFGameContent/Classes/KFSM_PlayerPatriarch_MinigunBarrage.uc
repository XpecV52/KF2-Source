/*******************************************************************************
 * KFSM_PlayerPatriarch_MinigunBarrage generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFSM_PlayerPatriarch_MinigunBarrage extends KFSM_Patriarch_MinigunBarrage;

var bool bAnimCanBeInterrupted;
var name AimOffsetProfileName;

function SpecialMoveStarted(bool bForced, name PrevMove)
{
    bAnimCanBeInterrupted = false;
    bPendingStopFire = false;
    KFPOwner.SetAimOffsetNodesProfile(AimOffsetProfileName);
    KFPOwner.bEnableAimOffset = true;
    super.SpecialMoveStarted(bForced, PrevMove);
}

function PlayFireAnim()
{
    if(bInterrupted || bObstructed)
    {
        return;
    }
    super.PlayFireAnim();
    if(KFPOwner.IsLocallyControlled())
    {
        KFPOwner.SetTimer(KFSkeletalMeshComponent(KFPOwner.Mesh).GetAnimInterruptTime(AnimName), false, 'Timer_AnimInterrupt', self);
    }
}

function PlayWindDownAnim()
{
    super.PlayWindDownAnim();
    RestoreCameraDefaults();
}

function Timer_AnimInterrupt()
{
    bAnimCanBeInterrupted = true;
    if(bPendingStopFire)
    {
        SpecialMoveButtonReleased();
    }
}

function SpecialMoveEnded(name PrevMove, name NextMove)
{
    if(KFPOwner != none)
    {
        KFPOwner.SpecialMoveFlags = 255;
        KFPOwner.bEnableAimOffset = false;
        KFPOwner.SetDefaultAimOffsetNodesProfile();
    }
    super.SpecialMoveEnded(PrevMove, NextMove);
}

function SpecialMoveFlagsUpdated()
{
    if(KFPOwner.SpecialMoveFlags == 254)
    {
        bInterrupted = true;
        if(!bIsFanFire)
        {
            MyPatPawn.StopBodyAnim(1, 0.1);
        }
        PlayWindDownAnim();        
    }
    else
    {
        super.SpecialMoveFlagsUpdated();
    }
}

function SpecialMoveButtonRetriggered()
{
    bPendingStopFire = false;
}

function SpecialMoveButtonReleased()
{
    bPendingStopFire = true;
    if(!bAnimCanBeInterrupted)
    {
        return;
    }
    KFPOwner.DoSpecialMove(KFPOwner.SpecialMove, true,, 254);
    if((KFPOwner.Role < ROLE_Authority) && KFPOwner.IsLocallyControlled())
    {
        KFPOwner.ServerDoSpecialMove(KFPOwner.SpecialMove, true,, 254);
    }
}

defaultproperties
{
    AimOffsetProfileName=Minigun
    bUseCustomThirdPersonViewOffset=true
    CustomThirdPersonViewOffset=(OffsetHigh=(X=-140,Y=90,Z=45),OffsetMid=(X=-125,Y=110,Z=45),OffsetLow=(X=-160,Y=130,Z=55))
    ViewOffsetInterpTime=0.4
    CustomCameraFOV=60
    CameraFOVTransitionTime=0.5
    Handle=KFSM_PlayerPatriarch_MinigunBarrage
}