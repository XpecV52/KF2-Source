/*******************************************************************************
 * KFAIController_ZedSiren generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFAIController_ZedSiren extends KFAIController_Monster
    config(AI)
    hidecategories(Navigation);

function PreMoveToEnemy()
{
    if((MyKFPawn.SpecialMove == 19) || (MyKFPawn.SpecialMove == 0) && !IsTimerActive('DoScream'))
    {
        DoScream(true);        
    }
    else
    {
        if(!IsTimerActive('DoScream'))
        {
            SetTimer(1, false, 'DoScream');
        }
    }
}

function DoScream(optional bool bCalledFromPreMove)
{
    bCalledFromPreMove = false;
    if((MyKFPawn == none) || !MyKFPawn.IsCombatCapable())
    {
        return;
    }
    if((MyKFPawn.SpecialMove == 0) || MyKFPawn.SpecialMove == 19)
    {
        Class'AICommand_Siren_Scream'.static.Scream(self);
    }
    if(!bCalledFromPreMove)
    {
        SetEnemyMoveGoal(self, true);
    }
}

function AcquireEnemyAndScream(optional bool bStartScreamTimer)
{
    local Pawn BestTarget;

    if(((MyKFPawn == none) || !MyKFPawn.IsCombatCapable()) || IsTimerActive('DoScream'))
    {
        return;
    }
    if(Enemy == none)
    {
        BestTarget = MyKFPawn.GetBestAggroEnemy();
        if(BestTarget == none)
        {
            BestTarget = GetClosestEnemy();
        }
        if(BestTarget != none)
        {
            ChangeEnemy(BestTarget, true);
        }
    }
    if(bStartScreamTimer)
    {
        SetTimer(1, false, 'DoScream');
    }
}

function NotifySpecialMoveStarted(KFSpecialMove SM)
{
    local AICommand_Siren_Scream ScreamCommand;

    if((MyKFPawn == none) || !MyKFPawn.IsAliveAndWell())
    {
        return;
    }
    if(!MyKFPawn.IsCombatCapable())
    {
        ScreamCommand = FindCommandOfClass(Class'AICommand_Siren_Scream');
        if(ScreamCommand != none)
        {
            AbortCommand(ScreamCommand);
        }
    }
    super(KFAIController).NotifySpecialMoveStarted(SM);
}

function NotifySpecialMoveEnded(KFSpecialMove SM)
{
    super(KFAIController).NotifySpecialMoveEnded(SM);
    if((((SM.Handle == 'KFSM_Stumble') || SM.Handle == 'KFSM_Stunned') || SM.Handle == 'KFSM_Frozen') || SM.Handle == 'KFSM_RecoverFromRagdoll')
    {
        AcquireEnemyAndScream(true);
    }
}

function NotifyMeleeAttackFinished()
{
    super(KFAIController).NotifyMeleeAttackFinished();
    if(MyKFPawn != none)
    {
        MyKFPawn.NotifyMeleeAttackFinished();
    }
}

function NotifyCommandFinished(AICommand FinishedCommand)
{
    if(AICommand_PanicWander(FinishedCommand) != none)
    {
        AcquireEnemyAndScream(true);
    }
    super(KFAIController).NotifyCommandFinished(FinishedCommand);
}

function DoPanicWander()
{
    local GameAICommand ActiveCommand;
    local AICommand_Siren_Scream ScreamCommand;

    ActiveCommand = GetActiveCommand();
    if((ActiveCommand != none) && AICommand_PanicWander(ActiveCommand) != none)
    {
        return;
    }
    ScreamCommand = FindCommandOfClass(Class'AICommand_Siren_Scream');
    if(ScreamCommand != none)
    {
        AbortCommand(ScreamCommand);
    }
    super(KFAIController).DoPanicWander();
}

function EnterZedVictoryState()
{
    if(IsTimerActive('DoScream'))
    {
        ClearTimer('DoScream');
    }
    super(KFAIController).EnterZedVictoryState();
}

defaultproperties
{
    bCanTeleportCloser=false
    bIsProbingMeleeRangeEvents=true
    SprintWithinEnemyRange=(X=600,Y=1200)
    LowIntensityAttackCooldown=7
}