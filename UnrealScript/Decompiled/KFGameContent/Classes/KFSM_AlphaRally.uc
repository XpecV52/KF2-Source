/*******************************************************************************
 * KFSM_AlphaRally generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFSM_AlphaRally extends KFSM_PlaySingleAnim;

var protected const AnimVariants RallyAnims;
var protected const bool bRallySelf;
var const float RallyRadius;
var protected const ParticleSystem RallyEffect;
var protected const ParticleSystem AltRallyEffect;
var protected const name RallyEffectBoneName;
var protected const name AltRallyEffectBoneNames[2];
var protected const Vector RallyEffectOffset;
var protected const Vector AltRallyEffectOffset;

static function byte PackRallyFlags()
{
    return byte(Rand(default.RallyAnims.Anims.Length));
}

protected function bool InternalCanDoSpecialMove()
{
    return (KFPOwner.Physics == 1) && KFPOwner.IsCombatCapable();
}

function SpecialMoveStarted(bool bForced, name PrevMove)
{
    super.SpecialMoveStarted(bForced, PrevMove);
    if(KFPOwner != none)
    {
        KFPOwner.SetTimer(BlendInTime, false, 'RallyZeds', self);
    }
}

function PlayAnimation()
{
    AnimName = RallyAnims.Anims[KFPOwner.SpecialMoveFlags];
    super.PlayAnimation();
}

function RallyZeds()
{
    local KFPawn_Monster KFPM;

    foreach KFPOwner.WorldInfo.GRI.VisibleCollidingActors(Class'KFPawn_Monster', KFPM, RallyRadius, KFPOwner.Location)
    {
        if(!bRallySelf && KFPM == KFPOwner)
        {
            continue;            
        }
        if(KFPM.IsHeadless() || !KFPM.IsAliveAndWell())
        {
            continue;            
        }
        KFPM.Rally(KFPOwner, RallyEffect, RallyEffectBoneName, RallyEffectOffset, AltRallyEffect, AltRallyEffectBoneNames, AltRallyEffectOffset);        
    }    
}

defaultproperties
{
    RallyAnims=Anims=/* Array type was not detected. */,Player_Taunt_V1=/* Unknown default property type! */,
/* Exception thrown while deserializing RallyAnims
System.ArgumentException: Requested value '3P_Sawblade_Animtree' was not found.
   at System.Enum.TryParseEnum(Type enumType, String value, Boolean ignoreCase, EnumResult& parseResult)
   at System.Enum.Parse(Type enumType, String value, Boolean ignoreCase)
   at UELib.Core.UDefaultProperty.DeserializeTagUE3()
   at UELib.Core.UDefaultProperty.Deserialize()
   at UELib.Core.UDefaultProperty.DeserializeDefaultPropertyValue(PropertyType type, DeserializeFlags& deserializeFlags) */
    bRallySelf=true
    RallyRadius=1000
    RallyEffect=ParticleSystem'ZED_Clot_EMIT.FX_ClotA_Rage_01'
    AltRallyEffect=ParticleSystem'ZED_Clot_EMIT.FX_Player_Zed_Buff_01'
    RallyEffectBoneName=Root
    AltRallyEffectBoneNames[0]=FX_EYE_L
    AltRallyEffectBoneNames[1]=FX_EYE_R
    RallyEffectOffset=(X=0,Y=0,Z=2)
    bUseRootMotion=true
    bDisableMovement=true
    bPawnRotationLocked=true
}