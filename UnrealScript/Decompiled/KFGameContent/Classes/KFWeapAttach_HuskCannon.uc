/*******************************************************************************
 * KFWeapAttach_HuskCannon generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFWeapAttach_HuskCannon extends KFWeaponAttachment
    hidecategories(Navigation,Object,Movement,Attachment,Collision,Physics,Advanced,Debug,Mobile);

var export editinline transient ParticleSystemComponent ChargingPSC;
var ParticleSystem ChargingEffect;
var ParticleSystem ChargedEffect;
var bool bIsCharging;
var bool bIsFullyCharged;
var float StartFireTime;
var int ChargeLevel;
var const ParticleSystem MuzzleFlashEffectL1;
var const ParticleSystem MuzzleFlashEffectL2;
var const ParticleSystem MuzzleFlashEffectL3;

simulated function StartFire()
{
    StartFireTime = WorldInfo.TimeSeconds;
    bIsCharging = true;
    if(ChargingPSC == none)
    {
        ChargingPSC = new (self) Class'ParticleSystemComponent';
        if(WeapMesh != none)
        {
            WeapMesh.AttachComponentToSocket(ChargingPSC, 'MuzzleFlash');            
        }
        else
        {
            AttachComponent(ChargingPSC);
        }        
    }
    else
    {
        ChargingPSC.ActivateSystem();
    }
    if(ChargingPSC != none)
    {
        ChargingPSC.SetTemplate(ChargingEffect);
    }
}

simulated event Tick(float DeltaTime)
{
    local float ChargeRTPC;

    if(bIsCharging && !bIsFullyCharged)
    {
        ChargeRTPC = FMin(Class'KFWeap_HuskCannon'.default.MaxChargeTime, WorldInfo.TimeSeconds - StartFireTime) / Class'KFWeap_HuskCannon'.default.MaxChargeTime;
        if(ChargeRTPC >= 1)
        {
            bIsFullyCharged = true;
            ChargingPSC.SetTemplate(ChargedEffect);
        }
    }
    super.Tick(DeltaTime);
}

simulated function bool ThirdPersonFireEffects(Vector HitLocation, KFPawn P, byte ThirdPersonAnimRateByte)
{
    bIsCharging = false;
    bIsFullyCharged = false;
    ChargeLevel = GetChargeFXLevel();
    if(ChargingPSC != none)
    {
        ChargingPSC.DeactivateSystem();
    }
    return super.ThirdPersonFireEffects(HitLocation, P, ThirdPersonAnimRateByte);
}

simulated function StopThirdPersonFireEffects()
{
    if(MuzzleFlash != none)
    {
        SetTimer(MuzzleFlash.MuzzleFlash.Duration, false, 'Timer_StopMuzzleFlash');
    }
}

simulated function Timer_StopMuzzleFlash()
{
    if(MuzzleFlash != none)
    {
        MuzzleFlash.StopMuzzleFlash();
    }
}

simulated function CauseMuzzleFlash(byte FiringMode)
{
    if((MuzzleFlash == none) && MuzzleFlashTemplate != none)
    {
        AttachMuzzleFlash();
    }
    switch(ChargeLevel)
    {
        case 1:
            MuzzleFlash.MuzzleFlash.ParticleSystemTemplate = MuzzleFlashEffectL1;
            MuzzleFlash.MuzzleFlash.PSC.SetTemplate(MuzzleFlashEffectL1);
            break;
        case 2:
            MuzzleFlash.MuzzleFlash.ParticleSystemTemplate = MuzzleFlashEffectL2;
            MuzzleFlash.MuzzleFlash.PSC.SetTemplate(MuzzleFlashEffectL2);
            break;
        case 3:
            MuzzleFlash.MuzzleFlash.ParticleSystemTemplate = MuzzleFlashEffectL3;
            MuzzleFlash.MuzzleFlash.PSC.SetTemplate(MuzzleFlashEffectL3);
            break;
        default:
            break;
    }
    super.CauseMuzzleFlash(FiringMode);
}

function int GetChargeFXLevel()
{
    local int MaxCharges, Charges;

    MaxCharges = int(Class'KFWeap_HuskCannon'.default.MaxChargeTime / Class'KFWeap_HuskCannon'.default.ValueIncreaseTime);
    Charges = Min(int((WorldInfo.TimeSeconds - StartFireTime) / Class'KFWeap_HuskCannon'.default.ValueIncreaseTime), MaxCharges);
    if(Charges <= 1)
    {
        return 1;        
    }
    else
    {
        if(Charges < MaxCharges)
        {
            return 2;            
        }
        else
        {
            return 3;
        }
    }
}

defaultproperties
{
    ChargingEffect=ParticleSystem'WEP_HuskCannon_EMIT.FX_Huskcannon_Charging_01'
    ChargedEffect=ParticleSystem'WEP_HuskCannon_EMIT.FX_Huskcannon_Charged_01'
    MuzzleFlashEffectL1=ParticleSystem'WEP_HuskCannon_EMIT.FX_Huskcannon_MuzzleFlash_L1_3P'
    MuzzleFlashEffectL2=ParticleSystem'WEP_HuskCannon_EMIT.FX_Huskcannon_MuzzleFlash_L2_3P'
    MuzzleFlashEffectL3=ParticleSystem'WEP_HuskCannon_EMIT.FX_Huskcannon_MuzzleFlash_L3_3P'
    begin object name=SkeletalMeshComponent0 class=SkeletalMeshComponent
        Animations=AnimNodeSequence'Default__KFWeapAttach_HuskCannon.SkeletalMeshComponent0.MeshSequenceA'
        ReplacementPrimitive=none
    object end
    // Reference: SkeletalMeshComponent'Default__KFWeapAttach_HuskCannon.SkeletalMeshComponent0'
    WeapMesh=SkeletalMeshComponent0
    MuzzleFlashTemplate=KFMuzzleFlash'WEP_HuskCannon_ARCH.Wep_HuskCannon_MuzzleFlash_3P'
}