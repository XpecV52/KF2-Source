/*******************************************************************************
 * SeqEvent_TakeDamage generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class SeqEvent_TakeDamage extends SequenceEvent
    native(Sequence)
    hidecategories(Object);

/** Damage must exceed this value to be counted */
var() float MinDamageAmount<autocomment=true>;
/** Total amount of damage to take before activating the event */
var() float DamageThreshold;
/** Types of damage that are counted */
var() array< class<DamageType> > DamageTypes<AllowAbstract=>;
/** Types of damage that are ignored */
var() array< class<DamageType> > IgnoreDamageTypes<AllowAbstract=>;
var float CurrentDamage;
/** Should the damage counter be reset if this event is toggled? */
var() bool bResetDamageOnToggle;

final function bool IsValidDamageType(class<DamageType> inDamageType)
{
    local int Idx;
    local bool bValidDamageType;

    if(DamageTypes.Length > 0)
    {
        bValidDamageType = false;
        Idx = 0;
        J0x27:

        if(Idx < DamageTypes.Length)
        {
            if(ClassIsChildOf(inDamageType, DamageTypes[Idx]))
            {
                bValidDamageType = true;
                goto J0x7E;
            }
            ++ Idx;
            goto J0x27;
        }
        J0x7E:

        if(!bValidDamageType)
        {
            return false;
        }
    }
    if(IgnoreDamageTypes.Length > 0)
    {
        Idx = 0;
        J0xAA:

        if(Idx < IgnoreDamageTypes.Length)
        {
            if(ClassIsChildOf(inDamageType, IgnoreDamageTypes[Idx]))
            {
                return false;
            }
            ++ Idx;
            goto J0xAA;
        }
    }
    return true;
}

function HandleDamage(Actor InOriginator, Actor InInstigator, class<DamageType> inDamageType, int inAmount)
{
    local SeqVar_Float FloatVar;
    local bool bAlreadyActivatedThisTick;

    PublishLinkedVariableValues();
    if(((((InOriginator != none) && bEnabled) && float(inAmount) >= MinDamageAmount) && IsValidDamageType(inDamageType)) && !bPlayerOnly || (InInstigator != none) && InInstigator.IsPlayerOwned())
    {
        CurrentDamage += float(inAmount);
        if(CurrentDamage >= DamageThreshold)
        {
            bAlreadyActivatedThisTick = bActive && ActivationTime ~= GetWorldInfo().TimeSeconds;
            if(CheckActivate(InOriginator, InInstigator, false))
            {
                foreach LinkedVariables(Class'SeqVar_Float', FloatVar, "Damage Taken")
                {
                    if(bAlreadyActivatedThisTick)
                    {
                        FloatVar.FloatValue += CurrentDamage;
                        continue;
                    }
                    FloatVar.FloatValue = CurrentDamage;                    
                }                
                if(DamageThreshold <= 0)
                {
                    CurrentDamage = 0;                    
                }
                else
                {
                    CurrentDamage -= DamageThreshold;
                }
            }
        }
    }
}

function Reset()
{
    super.Reset();
    CurrentDamage = 0;
}

static event int GetObjClassVersion()
{
    return super(SequenceObject).GetObjClassVersion() + 2;
}

event Toggled()
{
    if(bResetDamageOnToggle)
    {
        CurrentDamage = 0;
    }
    super.Toggled();
}

defaultproperties
{
    DamageThreshold=100
    bResetDamageOnToggle=true
    VariableLinks(0)=(ExpectedType=Class'SeqVar_Object',LinkedVariables=none,LinkDesc="Instigator",LinkVar=None,PropertyName=None,bWriteable=true,bSequenceNeverReadsOnlyWritesToThisVar=false,bModifiesLinkedObject=false,bHidden=false,MinVars=1,MaxVars=255,DrawX=0,CachedProperty=none,bAllowAnyType=false,bMoving=false,bClampedMax=false,bClampedMin=false,OverrideDelta=0)
    VariableLinks(1)=(ExpectedType=Class'SeqVar_Float',LinkedVariables=none,LinkDesc="Damage Taken",LinkVar=None,PropertyName=None,bWriteable=true,bSequenceNeverReadsOnlyWritesToThisVar=false,bModifiesLinkedObject=false,bHidden=false,MinVars=1,MaxVars=255,DrawX=0,CachedProperty=none,bAllowAnyType=false,bMoving=false,bClampedMax=false,bClampedMin=false,OverrideDelta=0)
    ObjName="Take Damage"
    ObjCategory="Actor"
}