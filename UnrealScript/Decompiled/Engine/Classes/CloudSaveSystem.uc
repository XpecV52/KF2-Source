/*******************************************************************************
 * CloudSaveSystem generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class CloudSaveSystem extends Object
    native;

const NUM_SAVE_SLOTS_KEY = "NumSaveSlots";
const DATA_STORE_ID_KEY = "DataStoreID";
const SAVE_DATA_BLOB_NAME_KEY = "DataBlobName";
const SAVE_SYSTEM_VERSION_KEY = "CloudSaveSystemVersion";
const COMMON_DATA_SAVE_SLOT_INDEX = -1;
const GET_SAVE_SLOT_ERROR = -2;
const GET_SAVE_SLOT_INVALID = -1;

enum SaveDataVersionSupport
{
    SaveDataVersionSupportLessThenEqual,
    SaveDataVersionSupportEqual,
    SaveDataVersionSupportAny,
    SaveDataVersionSupport_MAX
};

enum SaveSlotOperationEnum
{
    SSO_SET,
    SSO_GET,
    SSO_DELETE,
    SSO_MAX
};

struct native GetSaveDataCallbackStruct
{
    var int SlotIndex;
    var delegate<OnGetSaveDataCallback> Callback;

    structdefaultproperties
    {
        SlotIndex=0
        
/* Exception thrown while deserializing Callback
System.ArgumentOutOfRangeException: Length cannot be less than zero.
Parameter name: length
   at System.String.Substring(Int32 startIndex, Int32 length)
   at UELib.Core.UDefaultProperty.DeserializeDefaultPropertyValue(PropertyType type, DeserializeFlags& deserializeFlags) */
    }
};

struct native SetSaveDataCallbackStruct
{
    var int SlotIndex;
    var delegate<SaveSystemCallback> Callback;

    structdefaultproperties
    {
        SlotIndex=0
        
/* Exception thrown while deserializing Callback
System.ArgumentOutOfRangeException: Length cannot be less than zero.
Parameter name: length
   at System.String.Substring(Int32 startIndex, Int32 length)
   at UELib.Core.UDefaultProperty.DeserializeDefaultPropertyValue(PropertyType type, DeserializeFlags& deserializeFlags) */
    }
};

struct native SaveSlotOperation
{
    var int SlotIndex;
    var CloudSaveSystem.SaveSlotOperationEnum SlotOperation;

    structdefaultproperties
    {
        SlotIndex=0
        SlotOperation=SaveSlotOperationEnum.SSO_SET
    }
};

var private transient CloudSaveSystemKVSInterface KeyValueStore;
var private transient CloudSaveSystemDataBlobStoreInterface DataBlobStore;
var private transient array<GetSaveDataCallbackStruct> OnGetSaveDataCallbacks;
var private transient array<SetSaveDataCallbackStruct> OnSetSaveDataCallbacks;
var private transient delegate<SaveSystemCallback> DeleteSaveDataCallback;
var private transient int ActiveSlotForDelete;
var private transient array<SaveSlotOperation> ActiveSaveSlotOperations;
var delegate<OnGetSaveDataCallback> __OnGetSaveDataCallback__Delegate;
var delegate<SaveSystemCallback> __SaveSystemCallback__Delegate;

delegate OnGetSaveDataCallback(bool bWasSuccessful, int SaveSlot, out array<byte> DataBlob, string Error);

delegate SaveSystemCallback(bool bWasSuccessful, int SaveSlot, string Error);

final function bool GetNumberOfSaveSlots(out int NumSaveSlots)
{
    local PlatformInterfaceDelegateResult KVRes;
    local bool RValue;

    RValue = false;
    if(NotEqual_InterfaceInterface(KeyValueStore, (none)) && NotEqual_InterfaceInterface(DataBlobStore, (none)))
    {
        KeyValueStore.ReadKeyValue(-1, "NumSaveSlots", 1, KVRes);
        if(KVRes.bSuccessful)
        {
            RValue = true;
            NumSaveSlots = KVRes.Data.IntValue;
        }
    }
    return RValue;
}

private final function int DoesSaveSlotKeyValueDataAlreadyExist(string DataStoreID, string DataBlobName)
{
    local int SaveSlotScan, NumSaveSlots;
    local string CompareDataStoreID, CompareDataBlobName;
    local int RValue;

    RValue = -1;
    if((NotEqual_InterfaceInterface(KeyValueStore, (none)) && NotEqual_InterfaceInterface(DataBlobStore, (none))) && GetNumberOfSaveSlots(NumSaveSlots))
    {
        SaveSlotScan = 0;
        J0x74:

        if(SaveSlotScan < NumSaveSlots)
        {
            if(GetDataStoreIDAndBlobNameForSaveSlot(SaveSlotScan, CompareDataStoreID, CompareDataBlobName))
            {
                if((DataStoreID == CompareDataStoreID) && DataBlobName == CompareDataBlobName)
                {
                    RValue = SaveSlotScan;
                    goto J0x119;
                }                
            }
            else
            {
                RValue = -2;
            }
            ++ SaveSlotScan;
            goto J0x74;
        }
        J0x119:
        
    }
    else
    {
        RValue = -2;
    }
    return RValue;
}

private final function bool WriteNumSaveSlots(int NumSaveSlots)
{
    local PlatformInterfaceData KVSet;

    KVSet.IntValue = NumSaveSlots;
    KVSet.Type = 1;
    if(KeyValueStore.WriteKeyValue(-1, "NumSaveSlots", KVSet))
    {
        return true;
    }
    return false;
}

final function bool IsOperationActiveForSlot(int SlotIndex)
{
    local int Index;

    Index = ActiveSaveSlotOperations.Find('SlotIndex', SlotIndex;
    if(Index == -1)
    {
        return false;        
    }
    else
    {
        return true;
    }
}

final function bool IsDeleteOperationActive()
{
    if(ActiveSlotForDelete == -1)
    {
        return false;        
    }
    else
    {
        return true;
    }
}

final function bool AreAnySlotOperationsActive()
{
    if(ActiveSaveSlotOperations.Length > 0)
    {
        return true;        
    }
    else
    {
        return false;
    }
}

// Export UCloudSaveSystem::execSerializeObject(FFrame&, void* const)
native final function SerializeObject(Object ObjectToSerialize, out array<byte> Data, int DataVersion);

// Export UCloudSaveSystem::execDeserializeObject(FFrame&, void* const)
native final function Object DeserializeObject(Class ObjectClass, out array<byte> Data, CloudSaveSystem.SaveDataVersionSupport VersionSupport, int DataVersion);

final function Init(CloudSaveSystemKVSInterface InKeyValueStore, CloudSaveSystemDataBlobStoreInterface InDataBlobStore, int VersionNumber)
{
    local PlatformInterfaceDelegateResult SaveSystemVersionNumber;
    local PlatformInterfaceData SaveSystemVersionNumberSet;

    KeyValueStore = InKeyValueStore;
    DataBlobStore = InDataBlobStore;
    GetKeyValue(-1, "CloudSaveSystemVersion", 1, SaveSystemVersionNumber);
    if(!SaveSystemVersionNumber.bSuccessful || SaveSystemVersionNumber.Data.IntValue != VersionNumber)
    {
        SaveSystemVersionNumberSet.IntValue = VersionNumber;
        SaveSystemVersionNumberSet.Type = 1;
        SetKeyValue(-1, "CloudSaveSystemVersion", SaveSystemVersionNumberSet);
        WriteNumSaveSlots(0);
    }
}

final function GetSaveData(int SaveSlot, delegate<OnGetSaveDataCallback> OnGetSaveDataCallback)
{
    local string DataStoreID;
    local GetSaveDataCallbackStruct CallbackStruct;
    local SaveSlotOperation SlotOperation;
    local array<byte> EmptyBuffer;
    local string BlobName;
    local bool ErrorOccured;
    local string Error;

    ErrorOccured = true;
    if(EqualEqual_InterfaceInterface(KeyValueStore, (none)))
    {
        Error = "GetSaveData::KeyValueStore instance cannot be None";        
    }
    else
    {
        if(EqualEqual_InterfaceInterface(DataBlobStore, (none)))
        {
            Error = "GetSaveData::DataBlobStore instance cannot be None";            
        }
        else
        {
            if(OnGetSaveDataCallbacks.Find('SlotIndex', SaveSlot != -1)
            {
                Error = "GetSaveData::OnGetSaveDataCallback already present for save slot";                
            }
            else
            {
                if(ActiveSaveSlotOperations.Find('SlotIndex', SaveSlot != -1)
                {
                    Error = "GetSaveData::Save System operation already active for save slot";                    
                }
                else
                {
                    if(IsDeleteOperationActive())
                    {
                        Error = "GetSaveData::Delete Operation active cannot GetSaveData";                        
                    }
                    else
                    {
                        if(!GetDataStoreIDAndBlobNameForSaveSlot(SaveSlot, DataStoreID, BlobName))
                        {
                            Error = "GetSaveData::Failed to get store id and data blob name for save slot";                            
                        }
                        else
                        {
                            CallbackStruct.SlotIndex = SaveSlot;
                            CallbackStruct.Callback = OnGetSaveDataCallback;
                            OnGetSaveDataCallbacks.AddItem(CallbackStruct;
                            SlotOperation.SlotIndex = SaveSlot;
                            SlotOperation.SlotOperation = 1;
                            ActiveSaveSlotOperations.AddItem(SlotOperation;
                            DataBlobStore.GetDataBlob(DataStoreID, BlobName, OnGetSaveDataComplete);
                            ErrorOccured = false;
                        }
                    }
                }
            }
        }
    }
    if(ErrorOccured && OnGetSaveDataCallback != none)
    {
        OnGetSaveDataCallback(false, SaveSlot, EmptyBuffer, Error);
    }
}

private final function OnGetSaveDataComplete(bool bWasSuccessful, string StorageID, string BlobName, out array<byte> DataBlob, string Error)
{
    local int SaveSlotIndex, Index;
    local delegate<OnGetSaveDataCallback> LocalCallback;

    SaveSlotIndex = DoesSaveSlotKeyValueDataAlreadyExist(StorageID, BlobName);
    if(SaveSlotIndex >= 0)
    {
        Index = ActiveSaveSlotOperations.Find('SlotIndex', SaveSlotIndex;
        if(Index != -1)
        {
            if(ActiveSaveSlotOperations[Index].SlotOperation != 1)
            {
                bWasSuccessful = false;
                Error = "CloudSaveSystem in corrupt stat GetSaveData request finished but active slot operation should have been" @ string(ActiveSaveSlotOperations[Index].SlotOperation);
            }
            ActiveSaveSlotOperations.Remove(Index, 1;            
        }
        else
        {
            bWasSuccessful = false;
            Error = "CloudSaveSystem in corrupt state GetData request finished but was not correctly internally tracked.";
        }
        Index = OnGetSaveDataCallbacks.Find('SlotIndex', SaveSlotIndex;
        if(Index != -1)
        {
            LocalCallback = OnGetSaveDataCallbacks[Index].Callback;
            OnGetSaveDataCallback(bWasSuccessful, SaveSlotIndex, DataBlob, "Unknown Error loading data blob from Cloud");
            OnGetSaveDataCallbacks.Remove(Index, 1;
        }        
    }
    else
    {
        WarnInternal((("CloudSaveSystem in corrupt sate. save slot index does not exist for ID:" @ StorageID) @ "BlobName:") @ BlobName);
    }
}

final function SetSaveData(int SaveSlot, delegate<SaveSystemCallback> InSetSaveDataCallback, const out array<byte> SaveDataBlob)
{
    local SetSaveDataCallbackStruct CallbackStruct;
    local SaveSlotOperation SlotOperation;
    local string DataStoreID, BlobName;
    local bool ErrorOccured;
    local string Error;

    ErrorOccured = true;
    if(EqualEqual_InterfaceInterface(KeyValueStore, (none)))
    {
        Error = "SetSaveData::KeyValueStore instance cannot be None";        
    }
    else
    {
        if(EqualEqual_InterfaceInterface(DataBlobStore, (none)))
        {
            Error = "SetSaveData::DataBlobStore instance cannot be None";            
        }
        else
        {
            if(OnSetSaveDataCallbacks.Find('SlotIndex', SaveSlot != -1)
            {
                Error = "SetSaveData::OnSetSaveDataCallback already present for save slot";                
            }
            else
            {
                if(ActiveSaveSlotOperations.Find('SlotIndex', SaveSlot != -1)
                {
                    Error = "SetSaveData::Save System operation already active for save slot";                    
                }
                else
                {
                    if(IsDeleteOperationActive())
                    {
                        Error = "SetSaveData::Delete Operation active cannot SetSaveData";                        
                    }
                    else
                    {
                        if(!GetDataStoreIDAndBlobNameForSaveSlot(SaveSlot, DataStoreID, BlobName))
                        {
                            Error = "SetSaveData::Failed to get store id and data blob name for save slot";                            
                        }
                        else
                        {
                            CallbackStruct.SlotIndex = SaveSlot;
                            CallbackStruct.Callback = InSetSaveDataCallback;
                            OnSetSaveDataCallbacks.AddItem(CallbackStruct;
                            SlotOperation.SlotIndex = SaveSlot;
                            SlotOperation.SlotOperation = 0;
                            ActiveSaveSlotOperations.AddItem(SlotOperation;
                            ErrorOccured = false;
                            DataBlobStore.SetDataBlob(DataStoreID, BlobName, SaveDataBlob, OnSetSaveDataComplete);
                        }
                    }
                }
            }
        }
    }
    if(ErrorOccured && InSetSaveDataCallback != none)
    {
        SaveSystemCallback(false, SaveSlot, Error);
    }
}

private final function OnSetSaveDataComplete(bool bWasSucessfull, string StorageID, string BlobName, string Error)
{
    local int SaveSlotIndex, Index;
    local delegate<SaveSystemCallback> LocalCallback;

    SaveSlotIndex = DoesSaveSlotKeyValueDataAlreadyExist(StorageID, BlobName);
    if(SaveSlotIndex >= 0)
    {
        Index = ActiveSaveSlotOperations.Find('SlotIndex', SaveSlotIndex;
        if(Index != -1)
        {
            if(ActiveSaveSlotOperations[Index].SlotOperation != 0)
            {
                Error = "CloudSaveSystem in corrupt stat Set Data request finished but active slot operation should have been" @ string(ActiveSaveSlotOperations[Index].SlotOperation);
                bWasSucessfull = false;
            }
            ActiveSaveSlotOperations.Remove(Index, 1;            
        }
        else
        {
            bWasSucessfull = false;
            Error = "CloudSaveSystem in corrupt state Set Data request finished but was not correctly internally tracked.";
        }
        Index = OnSetSaveDataCallbacks.Find('SlotIndex', SaveSlotIndex;
        if(Index != -1)
        {
            LocalCallback = OnSetSaveDataCallbacks[Index].Callback;
            SaveSystemCallback(bWasSucessfull, SaveSlotIndex, Error);
            OnSetSaveDataCallbacks.Remove(Index, 1;
        }        
    }
    else
    {
        WarnInternal((("CloudSaveSystem in corrupt sate. Save slot index does not exist for ID:" @ StorageID) @ "BlobName:") @ BlobName);
    }
}

final function bool DeleteSaveData(int SaveSlot, delegate<SaveSystemCallback> InDeleteSaveDataCallback)
{
    local string DataStoreID, BlobName;
    local SaveSlotOperation SlotOperation;
    local bool RValue;

    RValue = false;
    if((((NotEqual_InterfaceInterface(KeyValueStore, (none)) && NotEqual_InterfaceInterface(DataBlobStore, (none))) && DeleteSaveDataCallback == none) && !AreAnySlotOperationsActive()) && !IsDeleteOperationActive())
    {
        if(GetDataStoreIDAndBlobNameForSaveSlot(SaveSlot, DataStoreID, BlobName))
        {
            RValue = DataBlobStore.DeleteDataBlob(DataStoreID, BlobName, OnDeleteSaveDataComplete);
            if(RValue)
            {
                DeleteSaveDataCallback = InDeleteSaveDataCallback;
                ActiveSlotForDelete = SaveSlot;
                SlotOperation.SlotIndex = SaveSlot;
                SlotOperation.SlotOperation = 2;
                ActiveSaveSlotOperations.AddItem(SlotOperation;
            }
        }
    }
    return RValue;
}

final function OnDeleteSaveDataComplete(bool bWasSucessfull, string StorageID, string BlobName, string Error)
{
    local delegate<SaveSystemCallback> Callback;
    local int Scan, Index, SlotDeleted, NumSaveSlots;
    local string DataStoreID, DataBlobName;

    if(bWasSucessfull)
    {
        if(!GetNumberOfSaveSlots(NumSaveSlots))
        {
            bWasSucessfull = false;
            Error = "Could not retrieve number of save slots during slot deletion. Save system in corrupt state.";            
        }
        else
        {
            Scan = ActiveSlotForDelete + 1;
            J0xB1:

            if((Scan < NumSaveSlots) && bWasSucessfull)
            {
                if(!GetDataStoreIDAndBlobNameForSaveSlot(Scan, DataStoreID, DataBlobName))
                {
                    bWasSucessfull = false;
                    Error = "Error retrieving DataStoreID and DataBlobName during slot deletion. Save system in corrupt state.";                    
                }
                else
                {
                    if(!InternalSetSaveSlotKeyValues(Scan - 1, DataStoreID, DataBlobName))
                    {
                        bWasSucessfull = false;
                        Error = "Error migrating DataStoreID and DataBlobName to new slot during slot deletion. Save system in corrupt state.";
                    }
                }
                ++ Scan;
                goto J0xB1;
            }
            if(bWasSucessfull)
            {
                -- NumSaveSlots;
                if(!WriteNumSaveSlots(NumSaveSlots))
                {
                    bWasSucessfull = false;
                    Error = "Error writing number of save slot to Cloud KVS";
                }
            }
        }
    }
    SlotDeleted = ActiveSlotForDelete;
    ActiveSlotForDelete = -1;
    Index = ActiveSaveSlotOperations.Find('SlotIndex', SlotDeleted;
    if(Index != -1)
    {
        if(ActiveSaveSlotOperations[Index].SlotOperation != 2)
        {
            WarnInternal("CloudSaveSystem in corrupt stat DeleteSaveData request finished but active slot operation should have been" @ string(ActiveSaveSlotOperations[Index].SlotOperation));
        }
        ActiveSaveSlotOperations.Remove(Index, 1;        
    }
    else
    {
        WarnInternal("CloudSaveSystem in corrupt state DeleteSaveData request finished but was not correctly internally tracked.");
    }
    if(DeleteSaveDataCallback != none)
    {
        Callback = DeleteSaveDataCallback;
        DeleteSaveDataCallback = None;
        SaveSystemCallback(bWasSucessfull, SlotDeleted, Error);
    }
}

final function bool SetSaveSlotKeyValues(string DataStoreID, string SaveDataBlobName, out int SaveSlot)
{
    local bool RValue;
    local int NumSaveSlots;
    local bool IncSlotCount;

    RValue = false;
    IncSlotCount = false;
    if((NotEqual_InterfaceInterface(KeyValueStore, (none)) && NotEqual_InterfaceInterface(DataBlobStore, (none))) && GetNumberOfSaveSlots(NumSaveSlots))
    {
        SaveSlot = DoesSaveSlotKeyValueDataAlreadyExist(DataStoreID, SaveDataBlobName);
        if(SaveSlot == -2)
        {
            return false;            
        }
        else
        {
            if(SaveSlot == -1)
            {
                SaveSlot = NumSaveSlots;
                IncSlotCount = true;
            }
        }
        if(InternalSetSaveSlotKeyValues(SaveSlot, DataStoreID, SaveDataBlobName))
        {
            if(IncSlotCount)
            {
                ++ NumSaveSlots;
                if(WriteNumSaveSlots(NumSaveSlots))
                {
                    RValue = true;
                }                
            }
            else
            {
                RValue = true;
            }
        }
    }
    return RValue;
}

private final function bool InternalSetSaveSlotKeyValues(int SaveSlot, string DataStoreID, string SaveDataBlobName)
{
    local PlatformInterfaceData KVSet;
    local bool RValue;

    RValue = false;
    KVSet.StringValue = DataStoreID;
    KVSet.Type = 3;
    if(KeyValueStore.WriteKeyValue(SaveSlot, "DataStoreID", KVSet))
    {
        KVSet.StringValue = SaveDataBlobName;
        KVSet.Type = 3;
        if(KeyValueStore.WriteKeyValue(SaveSlot, "DataBlobName", KVSet))
        {
            RValue = true;
        }
    }
    return RValue;
}

final function bool SetKeyValue(int SaveSlot, string KeyName, const out PlatformInterfaceData Value)
{
    if(EqualEqual_InterfaceInterface(KeyValueStore, (none)))
    {
        return false;
    }
    return KeyValueStore.WriteKeyValue(SaveSlot, KeyName, Value);
}

private final function bool GetDataStoreIDAndBlobNameForSaveSlot(int SaveSlot, out string DataStoreID, out string DataBlobName)
{
    local PlatformInterfaceDelegateResult KVRes;
    local bool RValue;

    RValue = false;
    if(NotEqual_InterfaceInterface(KeyValueStore, (none)) || NotEqual_InterfaceInterface(DataBlobStore, (none)))
    {
        KeyValueStore.ReadKeyValue(SaveSlot, "DataStoreID", 3, KVRes);
        if(KVRes.bSuccessful)
        {
            DataStoreID = KVRes.Data.StringValue;
            KeyValueStore.ReadKeyValue(SaveSlot, "DataBlobName", 3, KVRes);
            if(KVRes.bSuccessful)
            {
                DataBlobName = KVRes.Data.StringValue;
                RValue = true;
            }
        }
    }
    return RValue;
}

final function bool GetKeyValue(int SaveSlot, string KeyName, PlatformInterfaceBase.EPlatformInterfaceDataType Type, out PlatformInterfaceDelegateResult Value)
{
    if(EqualEqual_InterfaceInterface(KeyValueStore, (none)))
    {
        return false;
    }
    return KeyValueStore.ReadKeyValue(SaveSlot, KeyName, Type, Value);
}

defaultproperties
{
    ActiveSlotForDelete=-1
}