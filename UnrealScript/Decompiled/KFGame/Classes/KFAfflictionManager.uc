/*******************************************************************************
 * KFAfflictionManager generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFAfflictionManager extends Object within KFPawn
    native(Pawn);

enum EHitZoneBodyPart
{
    BP_Torso,
    BP_Head,
    BP_LeftArm,
    BP_RightArm,
    BP_LeftLeg,
    BP_RightLeg,
    BP_Special,
    BP_MAX
};

enum EAfflictionVulnerabilityType
{
    AV_Default,
    AV_Head,
    AV_Legs,
    AV_Arms,
    AV_Special,
    AV_MAX
};

enum EAfflictionType
{
    AF_EMP,
    AF_FirePanic,
    AF_MeleeHit,
    AF_GunHit,
    AF_Stumble,
    AF_Stun,
    AF_Poison,
    AF_Knockdown,
    AF_Freeze,
    AF_Microwave,
    AF_Custom1,
    AF_Custom2,
    AF_Custom3,
    EAfflictionType_Blank,
    EAfflictionType_MAX
};

struct native IncapSettingsInfo
{
    /** How long this incap lasts once triggered.  Only applies to non-specialmove entries */
    var() float Duration;
    /** How long this pawn is immune to additional incap of this type.  If > 0, resets strength to zero on activation */
    var() float Cooldown;
    /** Array mapped to EHitZoneBodyPart.  If out of bounds default to body (index 0) */
    var() array<float> Vulnerability;

    structdefaultproperties
    {
        Duration=5
        Cooldown=0
        Vulnerability=none
    }
};

var array< class<KFAfflictionBase> > AfflictionClasses;
var array<KFAfflictionBase> Afflictions;
var array<KFAfflictionBase> AfflictionTickArray;
var bool bDebugLog;
var float FireFullyCharredDuration;
var float FireCharPercentThreshhold;

function NotifyTakeHit(Controller DamageInstigator, Vector HitDir, class<KFDamageType> DamageType)
{
    local KFPerk InstigatorPerk;

    if(DamageType == none)
    {
        return;
    }
    if((DamageInstigator != none) && DamageInstigator.bIsPlayer)
    {
        InstigatorPerk = KFPlayerController(DamageInstigator).GetPerk();
    }
    if((Outer.GetTeamNum() > 254) && !Outer.bPlayedDeath)
    {
        ProcessSpecialMoveAfflictions(InstigatorPerk, HitDir, DamageType);
        ProcessHitReactionAfflictions(InstigatorPerk, DamageType);
    }
    ProcessEffectBasedAfflictions(InstigatorPerk, DamageType);
}

function byte GetPredictedHitReaction(class<KFDamageType> DamageType, KFAfflictionManager.EHitZoneBodyPart BodyPart)
{
    if(DamageType.default.MeleeHitPower > float(0))
    {
        return 2;        
    }
    else
    {
        if(DamageType.default.GunHitPower > float(0))
        {
            return 1;
        }
    }
    return 0;
}

protected function ProcessSpecialMoveAfflictions(KFPerk InstigatorPerk, Vector HitDir, class<KFDamageType> DamageType)
{
    local KFAfflictionManager.EHitZoneBodyPart BodyPart;
    local byte HitZoneIdx;
    local float KnockdownPower, StumblePower, StunPower;

    if(IsZero(HitDir))
    {
        return;
    }
    HitZoneIdx = Outer.HitFxInfo.HitBoneIndex;
    BodyPart = ((HitZoneIdx != 255) ? Outer.HitZones[HitZoneIdx].Limb : 0);
    KnockdownPower = DamageType.default.KnockdownPower;
    StumblePower = DamageType.default.StumblePower;
    StunPower = DamageType.default.StunPower;
    if(InstigatorPerk != none)
    {
        KnockdownPower *= InstigatorPerk.GetKnockdownPowerModifier(DamageType, BodyPart, Outer.bIsSprinting);
        StumblePower *= InstigatorPerk.GetStumblePowerModifier(Outer, DamageType,, BodyPart);
        StunPower *= InstigatorPerk.GetStunPowerModifier(DamageType, HitZoneIdx);
    }
    if((KnockdownPower > float(0)) && Outer.CanDoSpecialMove(6))
    {
        AccrueAffliction(7, KnockdownPower, BodyPart);
    }
    if((StunPower > float(0)) && Outer.CanDoSpecialMove(8))
    {
        AccrueAffliction(5, StunPower, BodyPart);
    }
    if((StumblePower > float(0)) && Outer.CanDoSpecialMove(4))
    {
        AccrueAffliction(4, StumblePower, BodyPart);
    }
    if((DamageType.default.FreezePower > float(0)) && Outer.CanDoSpecialMove(9))
    {
        AccrueAffliction(8, DamageType.default.FreezePower, BodyPart);
    }
}

protected function ProcessHitReactionAfflictions(KFPerk InstigatorPerk, class<KFDamageType> DamageType)
{
    local KFAfflictionManager.EHitZoneBodyPart BodyPart;
    local byte HitZoneIdx;
    local float ReactionModifier;

    ReactionModifier = 1;
    if(InstigatorPerk != none)
    {
        ReactionModifier = InstigatorPerk.GetReactionModifier(DamageType);
    }
    if(Outer.MyKFAIC != none)
    {
        HitZoneIdx = Outer.HitFxInfo.HitBoneIndex;
        BodyPart = ((HitZoneIdx != 255) ? Outer.HitZones[HitZoneIdx].Limb : 0);
        if(DamageType.default.MeleeHitPower > float(0))
        {
            AccrueAffliction(2, DamageType.default.MeleeHitPower * ReactionModifier, BodyPart);
        }
        if(((HitZoneIdx == 0) && Outer.IsHeadless()) && Outer.GetTimerCount('BleedOutTimer', Outer) == 0)
        {
            AccrueAffliction(2, 100, BodyPart);
        }
        if(DamageType.default.GunHitPower > float(0))
        {
            AccrueAffliction(3, DamageType.default.GunHitPower * ReactionModifier, BodyPart);
        }
    }
}

protected function ProcessEffectBasedAfflictions(KFPerk InstigatorPerk, class<KFDamageType> DamageType)
{
    if(Outer.bPlayedDeath && Outer.WorldInfo.TimeSeconds > Outer.TimeOfDeath)
    {
        if(DamageType.default.BurnPower > float(0))
        {
            AccrueAffliction(1, DamageType.default.BurnPower);
        }        
    }
    else
    {
        if(DamageType.default.EMPPower > float(0))
        {
            AccrueAffliction(0, DamageType.default.EMPPower);
        }
        if(DamageType.default.BurnPower > float(0))
        {
            AccrueAffliction(1, DamageType.default.BurnPower);
        }
        if(((DamageType.default.PoisonPower > float(0)) && DamageType.static.AlwaysPoisons()) || (InstigatorPerk != none) && InstigatorPerk.IsAcidicCompoundActive())
        {
            AccrueAffliction(6, DamageType.default.PoisonPower);
        }
        if(DamageType.default.MicrowavePower > float(0))
        {
            AccrueAffliction(9, DamageType.default.MicrowavePower);
        }
    }
}

function AccrueAffliction(KFAfflictionManager.EAfflictionType Type, float InPower, optional KFAfflictionManager.EHitZoneBodyPart BodyPart)
{
    if((InPower <= float(0)) || Type >= Outer.IncapSettings.Length)
    {
        return;
    }
    if(!VerifyAfflictionInstance(Type))
    {
        return;
    }
    if(Outer.HitFxInfo.bRadialDamage && Outer.HitFxRadialInfo.RadiusDamageScale != 255)
    {
        InPower *= ByteToFloat(Outer.HitFxRadialInfo.RadiusDamageScale);
        if(bDebugLog)
        {
            LogInternal((string(Type) @ "Applied damage falloff modifier of") @ string(ByteToFloat(Outer.HitFxRadialInfo.RadiusDamageScale)));
        }
    }
    if(Outer.IncapSettings[Type].Vulnerability.Length > 0)
    {
        InPower *= (GetAfflictionVulnerability(Type, BodyPart));
        if(bDebugLog)
        {
            LogInternal((((string(Type) @ "Applied hit zone vulnerability modifier of") @ string(GetAfflictionVulnerability(Type, BodyPart))) @ "for") @ string(BodyPart));
        }
    }
    Outer.AdjustAffliction(InPower);
    if(InPower > float(0))
    {
        Afflictions[Type].Accrue(InPower);
    }
}

simulated function float GetAfflictionVulnerability(KFAfflictionManager.EAfflictionType I, KFAfflictionManager.EHitZoneBodyPart BodyPart)
{
    local KFAfflictionManager.EAfflictionVulnerabilityType J;

    switch(BodyPart)
    {
        case 1:
            J = 1;
            break;
        case 2:
        case 3:
            J = 3;
            break;
        case 4:
        case 5:
            J = 2;
            break;
        case 6:
            J = 4;
            break;
        default:
            break;
    }
    if((J > 0) && J < Outer.IncapSettings[I].Vulnerability.Length)
    {
        return Outer.IncapSettings[I].Vulnerability[J];
    }
    return Outer.IncapSettings[I].Vulnerability[0];
}

simulated function bool VerifyAfflictionInstance(KFAfflictionManager.EAfflictionType Type)
{
    if((Type >= Afflictions.Length) || Afflictions[Type] == none)
    {
        if((Type < AfflictionClasses.Length) && AfflictionClasses[Type] != none)
        {
            Afflictions[Type] = new (Outer) AfflictionClasses[Type];
            Afflictions[Type].Init(Outer, Type);            
        }
        else
        {
            LogInternal(((((string(GetFuncName()) @ "Failed with afflication:") @ string(Type)) @ "class:") @ string(AfflictionClasses[Type])) @ string(self));
            Afflictions[Type] = none;
            return false;
        }
    }
    return true;
}

function float GetAfflictionDuration(KFAfflictionManager.EAfflictionType Type)
{
    if(Type < Outer.IncapSettings.Length)
    {
        return Outer.IncapSettings[Type].Duration;
    }
}

simulated function ShutDown()
{
    local int I;

    I = Afflictions.Length - 1;
    J0x17:

    if(I >= 0)
    {
        if(Afflictions[I] != none)
        {
            Afflictions[I].ShutDown();
        }
        -- I;
        goto J0x17;
    }
}

function ToggleEffects(KFAfflictionManager.EAfflictionType Type, bool bPrimary, optional bool bSecondary)
{
    if(Outer.WorldInfo.NetMode == NM_DedicatedServer)
    {
        return;
    }
    if((Type >= Afflictions.Length) || Afflictions[Type] == none)
    {
        if((!bPrimary && !bSecondary) || !VerifyAfflictionInstance(Type))
        {
            return;
        }
    }
    Afflictions[Type].ToggleEffects(bPrimary, bSecondary);
}

function UpdateMaterialParameter(KFAfflictionManager.EAfflictionType Type, float Value)
{
    if(Outer.WorldInfo.NetMode == NM_DedicatedServer)
    {
        return;
    }
    if((Type >= Afflictions.Length) || Afflictions[Type] == none)
    {
        if((Value <= float(0)) || !VerifyAfflictionInstance(Type))
        {
            return;
        }
    }
    Afflictions[Type].SetMaterialParameter(Value);
}

defaultproperties
{
    AfflictionClasses(0)=class'KFAffliction_EMP'
    AfflictionClasses(1)=class'KFAffliction_Fire'
    AfflictionClasses(2)=class'KFAffliction_HeavyRecovery'
    AfflictionClasses(3)=class'KFAffliction_MediumRecovery'
    AfflictionClasses(4)=class'KFAffliction_Stumble'
    AfflictionClasses(5)=class'KFAffliction_Stun'
    AfflictionClasses(6)=class'KFAffliction_Poison'
    AfflictionClasses(7)=class'KFAffliction_Knockdown'
    AfflictionClasses(8)=class'KFAffliction_Freeze'
    AfflictionClasses(9)=class'KFAffliction_Microwave'
}