/*******************************************************************************
 * KFGFxTraderContainer_Store generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxTraderContainer_Store extends KFGFxObject_Container within GFxMoviePlayer;

var KFGFxMenu_Trader MyTraderMenu;
var array<STraderItem> SlotsItemList;
var const localized string TraderString;
var KFPlayerController KFPC;

function Initialize(KFGFxObject_Menu NewParentMenu)
{
    super.Initialize(NewParentMenu);
    KFPC = KFPlayerController(Outer.GetPC());
    MyTraderMenu = KFGFxMenu_Trader(NewParentMenu);
    SetString("shopHeaderName", TraderString);
    LocalizeContainer();
    Outer.GetPC().SetTimer(0.1, false, 'DelayedRefresh', self);
}

function LocalizeContainer()
{
    local GFxObject LocalizedObject;

    LocalizedObject = Outer.CreateObject("Object");
    LocalizedObject.SetString("buyPrompt", Localize("KFGFxTraderContainer_ItemDetails", "BuyString", "KFGame"));
    SetObject("localizeStrings", LocalizedObject);
}

function DelayedRefresh()
{
    MyTraderMenu.RefreshShopItemList(MyTraderMenu.CurrentTab, byte(MyTraderMenu.CurrentFilterIndex));
    SetSelectedIndex(0);
}

function OnTraderReopened();

function SetSelectedIndex(int SelectedIndex)
{
    SetInt("selectedIndex", SelectedIndex);
}

function RefreshWeaponListByPerk(byte FilterIndex, out array<STraderItem> ItemList)
{
    local int I, SlotIndex;
    local GFxObject ItemDataArray;
    local array<STraderItem> FullItemList;

    if(KFPC != none)
    {
        SlotIndex = 0;
        ItemList.Length = 0;
        ItemDataArray = Outer.CreateArray();
        FullItemList = KFPC.GetPurchaseHelper().TraderItems.SaleItems;
        I = 0;
        J0xAE:

        if(I < FullItemList.Length)
        {
            if(IsItemFiltered(FullItemList[I]))
            {
                goto J0x213;                
            }
            else
            {
                if((FullItemList[I].AssociatedPerkClass != none) && (FilterIndex >= KFPC.PerkList.Length) || FullItemList[I].AssociatedPerkClass != KFPC.PerkList[FilterIndex].PerkClass)
                {
                    goto J0x213;                    
                }
                else
                {
                    ItemList.AddItem(FullItemList[I];
                    SetItemInfo(ItemDataArray, FullItemList[I], SlotIndex);
                    ++ SlotIndex;
                }
            }
            J0x213:

            ++ I;
            goto J0xAE;
        }
        SetObject("shopData", ItemDataArray);
    }
}

function RefreshItemsByType(byte FilterIndex, out array<STraderItem> ItemList)
{
    local int I, SlotIndex;
    local GFxObject ItemDataArray;
    local array<STraderItem> FullItemList;

    SlotIndex = 0;
    ItemList.Length = 0;
    ItemDataArray = Outer.CreateArray();
    FullItemList = KFPC.GetPurchaseHelper().TraderItems.SaleItems;
    I = 0;
    J0x9F:

    if(I < FullItemList.Length)
    {
        if((IsItemFiltered(FullItemList[I])) || !(FilterIndex == FullItemList[I].TraderFilter) || FilterIndex == FullItemList[I].AltTraderFilter)
        {
            goto J0x1AD;            
        }
        else
        {
            ItemList.AddItem(FullItemList[I];
            SetItemInfo(ItemDataArray, FullItemList[I], SlotIndex);
            ++ SlotIndex;
        }
        J0x1AD:

        ++ I;
        goto J0x9F;
    }
    SetObject("shopData", ItemDataArray);
}

function RefreshFavoriteItems(out array<STraderItem> ItemList)
{
    local int I, SlotIndex;
    local GFxObject ItemDataArray;
    local array<STraderItem> FullItemList;

    SlotIndex = 0;
    ItemList.Length = 0;
    ItemDataArray = Outer.CreateArray();
    FullItemList = KFPC.GetPurchaseHelper().TraderItems.SaleItems;
    I = 0;
    J0x9F:

    if(I < FullItemList.Length)
    {
        if((IsItemFiltered(FullItemList[I])) || !MyTraderMenu.GetIsFavorite(FullItemList[I].ClassName))
        {
            goto J0x183;            
        }
        else
        {
            ItemList.AddItem(FullItemList[I];
            SetItemInfo(ItemDataArray, FullItemList[I], SlotIndex);
            ++ SlotIndex;
        }
        J0x183:

        ++ I;
        goto J0x9F;
    }
    SetObject("shopData", ItemDataArray);
}

function RefreshAllItems(out array<STraderItem> ItemList)
{
    local int I, SlotIndex;
    local GFxObject ItemDataArray;
    local array<STraderItem> FullItemList;

    SlotIndex = 0;
    ItemList.Length = 0;
    ItemDataArray = Outer.CreateArray();
    FullItemList = KFPC.GetPurchaseHelper().TraderItems.SaleItems;
    I = 0;
    J0x9F:

    if(I < FullItemList.Length)
    {
        if(IsItemFiltered(FullItemList[I]))
        {
            goto J0x137;            
        }
        else
        {
            ItemList.AddItem(FullItemList[I];
            SetItemInfo(ItemDataArray, FullItemList[I], SlotIndex);
            ++ SlotIndex;
        }
        J0x137:

        ++ I;
        goto J0x9F;
    }
    SetObject("shopData", ItemDataArray);
}

function SetItemInfo(out GFxObject ItemDataArray, out STraderItem TraderItem, int SlotIndex)
{
    local GFxObject SlotObject;
    local string ItemTexPath, IconPath;
    local bool bCanAfford, bCanCarry;
    local int AdjustedBuyPrice;

    SlotObject = Outer.CreateObject("Object");
    ItemTexPath = "img://" $ TraderItem.WeaponDef.static.GetImagePath();
    if(TraderItem.AssociatedPerkClass != none)
    {
        IconPath = "img://" $ TraderItem.AssociatedPerkClass.static.GetPerkIconPath();        
    }
    else
    {
        IconPath = "img://" $ Class'KFGFxObject_TraderItems'.default.OffPerkIconPath;
    }
    SlotObject.SetString("buyText", Localize("KFGFxTraderContainer_ItemDetails", "BuyString", "KFGame"));
    SlotObject.SetString("weaponSource", ItemTexPath);
    SlotObject.SetString("perkIconSource", IconPath);
    SlotObject.SetString("weaponName", TraderItem.WeaponDef.static.GetItemName());
    SlotObject.SetString("weaponType", TraderItem.WeaponDef.static.GetItemCategory());
    SlotObject.SetInt("weaponWeight", MyTraderMenu.GetDisplayedBlocksRequiredFor(TraderItem));
    AdjustedBuyPrice = KFPC.GetPurchaseHelper().GetAdjustedBuyPriceFor(TraderItem);
    SlotObject.SetInt("weaponCost", AdjustedBuyPrice);
    bCanAfford = KFPC.GetPurchaseHelper().GetCanAfford(AdjustedBuyPrice);
    bCanCarry = KFPC.GetPurchaseHelper().CanCarry(TraderItem);
    SlotObject.SetBool("bCanAfford", bCanAfford);
    SlotObject.SetBool("bCanCarry", bCanCarry);
    ItemDataArray.SetElementObject(SlotIndex, SlotObject);
}

function bool IsItemFiltered(const out STraderItem Item)
{
    if(KFPC.GetPurchaseHelper().IsInOwnedItemList(Item.ClassName))
    {
        return true;
    }
    if(KFPC.GetPurchaseHelper().IsInOwnedItemList(Item.DualClassName))
    {
        return true;
    }
    if(!KFPC.GetPurchaseHelper().IsSellable(Item))
    {
        return true;
    }
    if((Item.WeaponDef.default.SharedUnlockId != 0) && !Class'KFUnlockManager'.static.IsSharedContentUnlocked(Item.WeaponDef.default.SharedUnlockId))
    {
        return true;
    }
    return false;
}

defaultproperties
{
    TraderString="PURCHASE GEAR"
}