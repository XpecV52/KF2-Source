/*******************************************************************************
 * KFGFxMoviePlayer_Manager generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxMoviePlayer_Manager extends GFxMoviePlayer
    config(UI);

const KFID_QuickWeaponSelect = 100;
const KFID_CurrentLayoutIndex = 101;
const KFID_ForceFeedbackEnabled = 103;
const KFID_SavedPerkIndex = 105;
const KFID_AllowBloodSplatterDecals = 106;
const KFID_GoreLevel = 107;
const KFID_StoredCharIndex = 111;
const KFID_MasterVolumeMultiplier = 112;
const KFID_DialogVolumeMultiplier = 113;
const KFID_MusicVolumeMultiplier = 114;
const KFID_SFXVolumeMultiplier = 115;
const KFID_GammaMultiplier = 117;
const KFID_MusicVocalsEnabled = 118;
const KFID_MinimalChatter = 119;
const KFID_ShowCrossHair = 121;
const KFID_FOVOptionsPercentageValue = 122;
const KFID_ShowKillTicker = 123;
const KFID_FriendlyHudScale = 125;
const KFID_FavoriteWeapons = 127;
const KFID_GearLoadouts = 128;
const KFID_SetGamma = 129;
const KFID_RequiresPushToTalk = 130;
const KFID_InvertController = 131;
const KFID_AutoTargetEnabled = 132;
const KFID_GamepadSensitivityScale = 133;
const KFID_ZoomedSensitivityScale = 134;
const KFID_GamepadZoomedSensitivityScale = 135;
const KFID_EnableMouseSmoothing = 136;
const KFID_MouseSensitivity = 138;
const KFID_TargetAdhesionEnabled = 139;
const KFID_TargetFrictionEnabled = 140;
const KFID_InvertMouse = 142;
const KFID_VOIPVolumeMultiplier = 143;
const KFID_SavedSoloModeIndex = 144;
const KFID_SavedSoloMapString = 145;
const KFID_SavedSoloDifficultyIndex = 146;
const KFID_SavedSoloLengthIndex = 147;
const KFID_SavedModeIndex = 148;
const KFID_SavedMapString = 149;
const KFID_SavedDifficultyIndex = 150;
const KFID_SavedLengthIndex = 151;
const KFID_SavedPrivacyIndex = 152;
const KFID_SavedServerTypeIndex = 153;
const KFID_SavedInProgressIndex = 154;
const KFID_ControllerSoundEnabled = 155;
const KFID_MatchmakingRegion = 156;
const KFID_UseAltAimOnDuals = 157;
const KFID_HideBossHealthBar = 158;
const KFID_AntiMotionSickness = 159;
const KFID_ShowWelderInInventory = 160;
const KFID_AutoTurnOff = 161;
const KFID_ReduceHightPitchSounds = 162;

enum EUIIndex
{
    UI_Start,
    UI_Perks,
    UI_Gear,
    UI_Inventory,
    UI_Store,
    UI_OptionsSelection,
    UI_Exit_Menu,
    UI_OptionsControls,
    UI_OptionsAudio,
    UI_OptionsGraphics,
    UI_OptionsGameSettings,
    UI_Achievements,
    UI_Extras,
    UI_PostGame,
    UI_Trader,
    UI_ServerBrowserMenu,
    UI_IIS,
    UI_MAX
};

enum EStartMenuState
{
    EMatchmaking,
    EServerBrowser,
    ESoloGame,
    EOverview,
    EServerBrowserOverview,
    EStartMenuState_MAX
};

enum EPopUpType
{
    EConfirmation,
    EGamma,
    ENotification,
    EPopUpMax,
    EInputPrompt,
    EPopUpType_MAX
};

struct SMenuPaths
{
    var string BaseSWFPath;
    var string ConsoleSWFPath;

    structdefaultproperties
    {
        BaseSWFPath=""
        ConsoleSWFPath=""
    }
};

struct DelayedPopup
{
    var KFGFxMoviePlayer_Manager.EPopUpType PopupType;
    var string Title;
    var string Description;
    var string LeftButton;

    structdefaultproperties
    {
        PopupType=EPopUpType.EConfirmation
        Title=""
        Description=""
        LeftButton=""
    }
};

struct SPopupData
{
    var string SWFPath;
    var const localized array<localized string> TitleStrings;
    var const localized array<localized string> DescriptionStrings;
    var const localized string LeftButtonString;
    var const localized string RightButtonString;

    structdefaultproperties
    {
        SWFPath=""
        TitleStrings=none
        DescriptionStrings=none
        LeftButtonString=""
        RightButtonString=""
    }
};

var array<SMenuPaths> MenuSWFPaths;
var KFGFxObject_Menu CurrentMenu;
var byte CurrentMenuIndex;
var KFGFxMoviePlayer_Manager.EStartMenuState StartMenuState;
var KFGFxMoviePlayer_Manager.EPopUpType CurrentPopUpType;
var KFGFxMenu_StartGame StartMenu;
var KFGFxMenu_Perks PerksMenu;
var KFGFxMenu_Gear GearMenu;
var KFGFxMenu_Inventory InventoryMenu;
var KFGFxMenu_Store StoreMenu;
var KFGFxOptionsMenu_Controls OptionsControlsMenu;
var KFGFxOptionsMenu_Audio OptionsAudioMenu;
var KFGFxOptionsMenu_Graphics OptionsGraphicsMenu;
var KFGFxOptionsMenu_GameSettings OptionsGameSettingsMenu;
var KFGFxOptionsMenu_Selection OptionsSelectionMenu;
var KFGFxMenu_PostGameReport PostGameMenu;
var KFGFxMenu_Trader TraderMenu;
var KFGFxMenu_ServerBrowser ServerBrowserMenu;
var KFGFxMenu_Exit ExitMenu;
var KFGFxMenu_IIS IISMenu;
var KFProfileSettings CachedProfile;
var bool bPostGameState;
var bool bKickVotePopupActive;
var bool bUsingGamepad;
var bool bAfterLobby;
var bool bMenusOpen;
var bool bMenusActive;
var bool bSearchingForGame;
var bool bCanCloseMenu;
var bool bPlayerInLobby;
var bool bSetGamma;
var class<KFGFxWidget_PartyInGame> InGamePartyWidgetClass;
var array<DelayedPopup> DelayedPopups;
var KFGFxObject_Popup CurrentPopup;
var protected array<SPopupData> PopupData;
var const localized string FailedSearchTitleString;
var const localized string FailedSearchString;
var const localized string BrowseServersString;
var const localized string HasInvitedToGameString;
var const localized string JoinGameString;
var KFGFxWidget_MenuBar MenuBarWidget;
var KFGFxWidget_BaseParty PartyWidget;
var KFGFxWidget_ButtonPrompt ButtonPromptWidget;
var array<string> WidgetPaths;
var PlayerReplicationInfo VotePRI;
var() transient KFHUDTimerHelper TimerHelper;
var TWOnlineLobby OnlineLobby;
var UniqueNetId CurrentInviteLobbyId;
var const UniqueNetId ZeroUniqueId;
var GFxObject ManagerObject;
var KFHUDBase HUD;
var TextureMovie BackgroundMovie;
var TextureMovie IISMovie;
var array<string> IgnoredCommands;
var name SoundThemeName;
var const int MouseInputChangedThreshold;
var OnlineSubsystem OnlineSub;
var PlayfabInterface PlayfabInter;
var delegate<PendingRightButtonDelegate> __PendingRightButtonDelegate__Delegate;
var delegate<PendingMiddleButtonDelegate> __PendingMiddleButtonDelegate__Delegate;
var delegate<PendingLeftButtonDelegate> __PendingLeftButtonDelegate__Delegate;

delegate PendingRightButtonDelegate();

delegate PendingMiddleButtonDelegate();

delegate PendingLeftButtonDelegate();

function Init(optional LocalPlayer LocPlay)
{
    local Vector2D ViewportSize;
    local GameViewportClient GVC;
    local float ScaleStage;

    TimerHelper = GetPC().Spawn(Class'KFHUDTimerHelper');
    Class'KFUIDataStore_GameResource'.static.InitializeProviders();
    HUD = KFHUDBase(GetPC().myHUD);
    super.Init(LocPlay);
    if(OnlineSub == none)
    {
        OnlineSub = Class'GameEngine'.static.GetOnlineSubsystem();
        if(OnlineSub != none)
        {
            OnlineLobby = OnlineSub.GetLobbyInterface();
            CachedProfile = KFProfileSettings(OnlineSub.PlayerInterface.GetProfileSettings(byte(GetLP().ControllerId)));
            if(CachedProfile != none)
            {
                bSetGamma = CachedProfile.GetProfileBool(129);
            }
        }
    }
    PlayfabInter = Class'GameEngine'.static.GetPlayfabInterface();
    TimerHelper.SetTimer(1, true, 'OneSecondLoop', self);
    SetTimingMode(1);
    GVC = GetGameViewportClient();
    if((GVC != none) && Class'WorldInfo'.static.IsConsoleBuild(8))
    {
        GVC.GetViewportSize(ViewportSize);
        ScaleStage = Class'Engine'.static.GetTitleSafeArea();
        SetViewport(int((ViewportSize.X - (ViewportSize.X * ScaleStage)) / float(2)), int((ViewportSize.Y - (ViewportSize.Y * ScaleStage)) / float(2)), int(ViewportSize.X * ScaleStage), int(ViewportSize.Y * ScaleStage));
    }
    bUsingGamepad = Class'WorldInfo'.static.IsConsoleBuild(8);
    UpdateDynamicIgnoreKeys();
}

function OnProfileSettingsRead()
{
    CachedProfile = KFProfileSettings(OnlineSub.PlayerInterface.GetProfileSettings(byte(GetLP().ControllerId)));
    if((CachedProfile != none) && CachedProfile.AsyncState == 3)
    {
        bSetGamma = CachedProfile.GetProfileBool(129);
        if(!bSetGamma && !Class'KFGameEngine'.static.CheckSkipGammaCheck())
        {
            ManagerObject.SetBool("bStartUpGamma", true);
            OpenPopup(1, "", Class'KFGFxOptionsMenu_Graphics'.default.AdjustGammaDescription, Class'KFGFxOptionsMenu_Graphics'.default.ResetGammaString, Class'KFGFxOptionsMenu_Graphics'.default.SetGammaString);
        }
    }
}

function LaunchMenus(optional bool bForceSkipLobby)
{
    local GFxWidgetBinding WidgetBinding;
    local bool bSkippedLobby, bShowIIS;
    local KFGameViewportClient GVC;
    local bool bShowMenuBg;
    local TextureMovie BGTexture;

    GVC = KFGameViewportClient(GetGameViewportClient());
    WidgetBinding.WidgetName = 'PartyWidget';
    if(Class'WorldInfo'.static.IsMenuLevel())
    {
        WidgetBinding.WidgetClass = Class'KFGFxWidget_PartyMainMenu';
        bShowIIS = (GVC != none) && !GVC.bSeenIIS;
        BGTexture = ((GetPC().WorldInfo.IsConsoleBuild() && bShowIIS) ? IISMovie : BackgroundMovie);
        SetExternalTexture("background", BackgroundMovie);
        SetExternalTexture("IIS_BG", IISMovie);
        bShowMenuBg = GVC.bSeenIIS || !GetPC().WorldInfo.IsConsoleBuild();
        ManagerObject.SetBool("backgroundVisible", bShowMenuBg);
        ManagerObject.SetBool("IISMovieVisible", !bShowMenuBg);
        BGTexture.Play();        
    }
    else
    {
        bSkippedLobby = bForceSkipLobby || CheckSkipLobby();
        WidgetBinding.WidgetClass = InGamePartyWidgetClass;
        ManagerObject.SetBool("backgroundVisible", false);
        ManagerObject.SetBool("IISMovieVisible", false);
        if(bSkippedLobby)
        {
            BackgroundMovie.Stop();
        }
    }
    WidgetBindings.AddItem(WidgetBinding;
    switch(Class'KFGameEngine'.static.GetPlatform())
    {
        case 1:
            WidgetBinding.WidgetName = 'OptionsGraphicsMenu';
            WidgetBinding.WidgetClass = Class'KFGFxOptionsMenu_Graphics_DX10';
            WidgetBindings.AddItem(WidgetBinding;
            break;
        default:
            WidgetBinding.WidgetName = 'OptionsGraphicsMenu';
            WidgetBinding.WidgetClass = Class'KFGFxOptionsMenu_Graphics';
            WidgetBindings.AddItem(WidgetBinding;
            break;
    }
    if(!bSkippedLobby)
    {
        LoadWidgets(WidgetPaths);
        if(Class'WorldInfo'.static.IsConsoleBuild() && bShowIIS)
        {
            OpenMenu(16, false);            
        }
        else
        {
            OpenMenu(0);
        }
        AllowCloseMenu();
        if(GVC.bNeedDisconnectMessage)
        {
            TimerHelper.SetTimer(0.1, false, 'DelayedShowDisconnectMessage', self);
            GVC.bNeedDisconnectMessage = false;
        }
    }
    if(bForceSkipLobby)
    {
        bAfterLobby = true;
        CloseMenus(true);
    }
    if(((!bSetGamma && !Class'KFGameEngine'.static.CheckSkipGammaCheck()) && CachedProfile != none) && CachedProfile.AsyncState != 1)
    {
        ManagerObject.SetBool("bStartUpGamma", true);
        OpenPopup(1, "", Class'KFGFxOptionsMenu_Graphics'.default.AdjustGammaDescription, Class'KFGFxOptionsMenu_Graphics'.default.ResetGammaString, Class'KFGFxOptionsMenu_Graphics'.default.SetGammaString);
    }
}

function DelayedShowDisconnectMessage()
{
    if(Class'KFGameEngine'.static.IsFullScreenMoviePlaying())
    {
        TimerHelper.SetTimer(0.1, false, 'DelayedShowDisconnectMessage', self);        
    }
    else
    {
        OpenPopup(2, Localize("Notifications", "ConnectionLostTitle", "KFGameConsole"), Localize("Notifications", "ConnectionLostMessage", "KFGameConsole"), Class'KFCommon_LocalizedStrings'.default.OKString);
    }
}

function SetDelayedShowPopup(KFGFxMoviePlayer_Manager.EPopUpType PopupType, string TitleString, string DescriptionString, optional string LeftButtonString)
{
    local DelayedPopup PopUp;

    if(Class'KFGameEngine'.static.IsFullScreenMoviePlaying() || CurrentPopup != none)
    {
        PopUp.PopupType = PopupType;
        PopUp.Title = TitleString;
        PopUp.Description = DescriptionString;
        PopUp.LeftButton = LeftButtonString;
        DelayedPopups.AddItem(PopUp;
        TimerHelper.SetTimer(0.1, false, 'ShowDelayedPopupMessage', self);        
    }
    else
    {
        OpenPopup(PopupType, TitleString, DescriptionString, LeftButtonString);
    }
}

function ShowDelayedPopupMessage()
{
    local DelayedPopup PopUp;

    if(Class'KFGameEngine'.static.IsFullScreenMoviePlaying() || CurrentPopup != none)
    {
        TimerHelper.SetTimer(0.1, false, 'ShowDelayedPopupMessage', self);
    }
    if(DelayedPopups.Length > 0)
    {
        PopUp = DelayedPopups[0];
        DelayedPopups.Remove(0, 1;
        OpenPopup(PopUp.PopupType, PopUp.Title, PopUp.Description, PopUp.LeftButton);
    }
}

function bool CheckSkipLobby()
{
    if(!bAfterLobby && Class'KFGameEngine'.static.CheckSkipLobby() || Class'KFGameEngine'.static.IsEditor())
    {
        if(KFPlayerController(GetPC()) != none)
        {
            KFPlayerController(GetPC()).SkipLobby();
            bAfterLobby = true;
            CloseMenus(true);
            return true;
        }
    }
    return false;
}

event bool WidgetInitialized(name WidgetName, name WidgetPath, GFxObject Widget)
{
    local PlayerController PC;
    local bool bHandled;

    bHandled = true;
    LogInternal("WidgetInitialized - Menu: " @ string(WidgetName), 'DevGFxUI');
    switch(WidgetName)
    {
        case 'root1':
            if(ManagerObject == none)
            {
                ManagerObject = Widget;
                ManagerObject.SetBool("bConsoleBuild", Class'WorldInfo'.static.IsConsoleBuild());
            }
            break;
        case 'ExitMenu':
            if(ExitMenu == none)
            {
                ExitMenu = KFGFxMenu_Exit(Widget);
                ExitMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, ExitMenu);
            break;
        case 'StartMenu':
            if(StartMenu == none)
            {
                StartMenu = KFGFxMenu_StartGame(Widget);
                StartMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, StartMenu);
            break;
        case 'PerksMenu':
            if(PerksMenu == none)
            {
                PerksMenu = KFGFxMenu_Perks(Widget);
                PerksMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, PerksMenu);
            break;
        case 'ServerBrowserMenu':
            if(ServerBrowserMenu == none)
            {
                ServerBrowserMenu = KFGFxMenu_ServerBrowser(Widget);
                ServerBrowserMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, ServerBrowserMenu);
            break;
        case 'GearMenu':
            PC = GetPC();
            if(PC.PlayerReplicationInfo.bReadyToPlay && PC.WorldInfo.GRI.bMatchHasBegun)
            {
                goto J0xB90;
            }
            if(GearMenu == none)
            {
                GearMenu = KFGFxMenu_Gear(Widget);
                GearMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, GearMenu);
            break;
        case 'InventoryMenu':
            PC = GetPC();
            if(InventoryMenu == none)
            {
                InventoryMenu = KFGFxMenu_Inventory(Widget);
                InventoryMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, InventoryMenu);
            break;
        case 'StoreMenu':
            PC = GetPC();
            if(StoreMenu == none)
            {
                StoreMenu = KFGFxMenu_Store(Widget);
                StoreMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, StoreMenu);
            break;
        case 'OptionsSelectionMenu':
            if(OptionsSelectionMenu == none)
            {
                OptionsSelectionMenu = KFGFxOptionsMenu_Selection(Widget);
                OptionsSelectionMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, OptionsSelectionMenu);
            break;
        case 'OptionsControlsMenu':
            if(OptionsControlsMenu == none)
            {
                OptionsControlsMenu = KFGFxOptionsMenu_Controls(Widget);
                OptionsControlsMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, OptionsControlsMenu);
            break;
        case 'OptionsAudioMenu':
            if(OptionsAudioMenu == none)
            {
                OptionsAudioMenu = KFGFxOptionsMenu_Audio(Widget);
                OptionsAudioMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, OptionsAudioMenu);
            break;
        case 'OptionsGraphicsMenu':
            if(OptionsGraphicsMenu == none)
            {
                OptionsGraphicsMenu = KFGFxOptionsMenu_Graphics(Widget);
                OptionsGraphicsMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, OptionsGraphicsMenu);
            break;
        case 'OptionsGameSettingsMenu':
            if(OptionsGameSettingsMenu == none)
            {
                OptionsGameSettingsMenu = KFGFxOptionsMenu_GameSettings(Widget);
                OptionsGameSettingsMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, OptionsGameSettingsMenu);
            break;
        case 'TraderMenu':
            if(TraderMenu == none)
            {
                TraderMenu = KFGFxMenu_Trader(Widget);
                TraderMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, TraderMenu);
            break;
        case 'PostGameMenu':
            if(PostGameMenu == none)
            {
                PostGameMenu = KFGFxMenu_PostGameReport(Widget);
                PostGameMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, PostGameMenu);
            break;
        case 'IISMenu':
            if(IISMenu == none)
            {
                IISMenu = KFGFxMenu_IIS(Widget);
                IISMenu.InitializeMenu(self);
            }
            OnMenuOpen(WidgetPath, IISMenu);
            break;
        case 'MenuBarWidget':
            if(MenuBarWidget == none)
            {
                MenuBarWidget = KFGFxWidget_MenuBar(Widget);
                MenuBarWidget.InitializeMenu(self);
                MenuBarWidget.InitializeCurrentMenu(0);
            }
            break;
        case 'ButtonPromptWidgetContainer':
            if(ButtonPromptWidget == none)
            {
                ButtonPromptWidget = KFGFxWidget_ButtonPrompt(Widget);
                ButtonPromptWidget.InitializeMenu(self);
            }
            break;
        case 'PartyWidget':
            if(PartyWidget == none)
            {
                if(Class'WorldInfo'.static.IsMenuLevel())
                {
                    PartyWidget = KFGFxWidget_PartyMainMenu(Widget);                    
                }
                else
                {
                    PartyWidget = KFGFxWidget_PartyInGame(Widget);
                    PartyWidget.StartCountdown(KFGameReplicationInfo(GetPC().WorldInfo.GRI).RemainingTime, false);
                }
                PartyWidget.Manager = self;
                PartyWidget.InitializeWidget();
            }
            break;
        case 'ChatBoxWidget':
            if(PartyWidget != none)
            {
                if(PartyWidget.PartyChatWidget == none)
                {
                    PartyWidget.PartyChatWidget = KFGFxHUD_ChatBoxWidget(Widget);
                    PartyWidget.PartyChatWidget.Init();
                }
            }
            break;
        case 'GammaPopup':
        case 'ConnectionErrorPopup':
        case 'ConfirmationPopup':
        case 'InputPromptPopup':
            InitializePopup(WidgetPath, KFGFxObject_Popup(Widget));
            break;
        default:
            bHandled = false;
            break;
    }
    J0xB90:

    return bHandled;
}

function StatsInitialized()
{
    if(PartyWidget != none)
    {
        PartyWidget.StatsInit();
    }
}

function AllowCloseMenu()
{
    bCanCloseMenu = true;
}

function ForceUpdateNextFrame()
{
    TimerHelper.SetTimer(0.01, false, 'OnForceUpdate', self);
}

function OnForceUpdate()
{
    OneSecondLoop();
    TimerHelper.SetTimer(1, true, 'OneSecondLoop', self);
}

function OneSecondLoop()
{
    if(bMenusOpen)
    {
        if(CurrentMenu != none)
        {
            CurrentMenu.OneSecondLoop();
        }
        if(PartyWidget != none)
        {
            PartyWidget.OneSecondLoop();
        }
        if(PostGameMenu != none)
        {
            PostGameMenu.OneSecondLoop();
        }
        if(IISMenu != none)
        {
            IISMenu.OneSecondLoop();
        }
    }
}

function SetMenusOpen(bool bIsOpen)
{
    local KFGFxHudWrapper HudWrapper;

    TimerHelper.SetTickIsDisabled(!bIsOpen);
    SetPause(!bIsOpen);
    bMenusOpen = bIsOpen;
    bMenusActive = bIsOpen;
    SetMovieCanReceiveInput(bIsOpen);
    HudWrapper = KFGFxHudWrapper(HUD);
    if((HudWrapper != none) && HudWrapper.HudMovie != none)
    {
        HudWrapper.HudMovie.UpdateVisibilityState();
    }
}

function OpenMenu(byte NewMenuIndex, optional bool bShowWidgets)
{
    local KFGFxMoviePlayer_Manager.EStartMenuState TempMenuState;
    local WorldInfo WI;
    local PlayerController PC;
    local string MenuPath;

    bShowWidgets = true;
    if(NewMenuIndex == 2)
    {
        PC = GetPC();
        if(PC.PlayerReplicationInfo.bReadyToPlay && PC.WorldInfo.GRI.bMatchHasBegun)
        {
            return;
        }
    }
    WI = Class'WorldInfo'.static.GetWorldInfo();
    if(NewMenuIndex == 13)
    {
        UnloadCurrentPopup();
    }
    if(!bMenusOpen)
    {
        SetMenusOpen(true);
    }
    if(VotePRI != none)
    {
        ShowKickVote(VotePRI);
    }
    if((bMenusOpen && NewMenuIndex != CurrentMenuIndex) && CurrentMenu != none)
    {
        CurrentMenu.OnClose();
        CurrentMenu = none;
    }
    if((CurrentMenuIndex == 16) && NewMenuIndex == 0)
    {
        IISMovie.Stop();
        ManagerObject.SetBool("IISMovieVisible", false);
        BackgroundMovie.Play();
        ManagerObject.SetBool("backgroundVisible", true);
    }
    if(NewMenuIndex == 16)
    {
        BackgroundMovie.Stop();
        ManagerObject.SetBool("backgroundVisible", false);
        IISMovie.Play();
        ManagerObject.SetBool("IISMovieVisible", true);
    }
    if(NewMenuIndex != 14)
    {
        CurrentMenuIndex = NewMenuIndex;        
    }
    else
    {
        PlaySoundFromTheme('TRADER_OPEN_MENU', 'UI');
        if((PC != none) && PC.PlayerInput != none)
        {
            PC.PlayerInput.ResetInput();
        }
        bCanCloseMenu = false;
        TimerHelper.SetTimer(0.5, false, 'AllowCloseMenu', self);
    }
    if(CurrentMenuIndex == 0)
    {
        if(StartMenuState == 1)
        {
            CurrentMenuIndex = 15;
            NewMenuIndex = 15;            
        }
        else
        {
            if(StartMenu != none)
            {
                TempMenuState = StartMenu.GetStartMenuState();
                if((((TempMenuState == 4) || TempMenuState == 3) && !IsInLobby()) && WI.IsMenuLevel())
                {
                    if(StartMenu != none)
                    {
                        StartMenu.SetOverview();
                    }                    
                }
                else
                {
                    SetStartMenuState(TempMenuState);
                }
            }
        }
    }
    UpdateMenuBar();
    if(Class'WorldInfo'.static.IsConsoleBuild() && MenuSWFPaths[NewMenuIndex].ConsoleSWFPath != "")
    {
        MenuPath = MenuSWFPaths[NewMenuIndex].ConsoleSWFPath;        
    }
    else
    {
        MenuPath = MenuSWFPaths[NewMenuIndex].BaseSWFPath;
    }
    LoadMenu(MenuPath, bShowWidgets);
    SetMovieCanReceiveInput(true);
}

function LoadMenu(string Path, bool bShowWidgets)
{
    ManagerObject.ActionScriptVoid("loadCurrentMenu");
}

function LoadWidgets(array<string> Paths)
{
    ManagerObject.ActionScriptVoid("loadWidgets");
}

function OnMenuOpen(name WidgetPath, KFGFxObject_Menu Widget)
{
    CurrentMenu = Widget;
    CurrentMenu.OnOpen();
    SetWidgetPathBinding(Widget, WidgetPath);
    if(CurrentPopup == none)
    {
        SetExternalInterface(Widget);
    }
    ConditionalPauseGame(true);
    SetHUDVisiblity(false);
}

function ClosePostGameMenu()
{
    if(CurrentMenu == PostGameMenu)
    {
        CloseMenus();
    }
}

function CloseMenus(optional bool bForceClose)
{
    bForceClose = false;
    if((bMenusOpen && bCanCloseMenu) || bForceClose)
    {
        UnloadCurrentPopup();
        if((((!bAfterLobby && PartyWidget != none) || (GetPC()) == none) || GetPC().WorldInfo.GRI == none) || GetPC().WorldInfo.GRI.bMatchIsOver)
        {
            PartyWidget.SetReadyButtonVisibility(false);
            bAfterLobby = true;
        }
        if(CurrentMenu != none)
        {
            if(CurrentMenu == TraderMenu)
            {
                PlaySoundFromTheme('TRADER_EXIT_BUTTON_CLICK', 'UI');
            }
            CurrentMenu.OnClose();
            CurrentMenu = none;
        }
        bMenusActive = false;
        ConditionalPauseGame(false);
        SetMenuVisibility(false);
        SetMovieCanReceiveInput(false);
        SetHUDVisiblity(true);
    }
}

event OnClose()
{
    CloseMenus();
    if(!BackgroundMovie.Stopped)
    {
        BackgroundMovie.Stop();
    }
}

event OnCleanup()
{
    super.OnCleanup();
    TimerHelper.ClearAllTimers();
    if(OnlineSub != none)
    {
        OnlineSub.ClearAllInventoryReadCompleteDelegates();
    }
    if(PlayfabInter != none)
    {
        PlayfabInter.InventoryReadDelegates.Length = 0;
    }
    GetGameViewportClient().__HandleInputAxis__Delegate = None;
}

function bool ToggleMenus()
{
    if(!bMenusOpen || HUD.bShowHUD)
    {
        ManagerObject.SetBool("bOpenedInGame", true);
        if(CurrentMenuIndex >= MenuSWFPaths.Length)
        {
            LaunchMenus();            
        }
        else
        {
            OpenMenu(1);
            UpdateMenuBar();
        }
        bCanCloseMenu = false;
        TimerHelper.SetTimer(0.5, false, 'AllowCloseMenu', self);
        TimerHelper.SetTimer(0.15, false, 'PlayOpeningSound', self);        
    }
    else
    {
        if(bCanCloseMenu)
        {
            if(GetPC().WorldInfo.GRI.bMatchIsOver && !bAfterLobby)
            {
                return false;
            }
            if(CurrentMenu != TraderMenu)
            {
                PlaySoundFromTheme('MAINMENU_CLOSE', 'UI');
            }
            CloseMenus();            
        }
        else
        {
            if(bPostGameState)
            {
                if(CurrentMenu == PostGameMenu)
                {
                    ManagerObject.SetBool("bOpenedInGame", true);
                    bMenusOpen = false;
                    OpenMenu(1);
                    SetWidgetsVisible(true);                    
                }
                else
                {
                    ManagerObject.SetBool("bOpenedInGame", false);
                    OpenMenu(13);
                    SetWidgetsVisible(false);
                }
            }
        }
    }
    return false;
}

function PlayOpeningSound()
{
    PlaySoundFromTheme('MainMenu_Open', SoundThemeName);
}

event MenusFinishedClosing()
{
    if(bMenusOpen)
    {
        SetMenusOpen(false);
    }
}

function SetWidgetsVisible(bool bVisible)
{
    LogInternal("BRIAN:: SetWidgetsVisible" @ string(bVisible));
    ManagerObject.ActionScriptVoid("setWidgetsVisiblity");
}

function SetMenuVisibility(bool bVisible)
{
    ManagerObject.ActionScriptVoid("setMenuVisibility");
}

function SetHUDVisiblity(bool bIsVisible)
{
    if(HUD != none)
    {
        HUD.SetVisible(bIsVisible);
    }
    bCaptureInput = !bIsVisible;
    if(((GetPC()) != none) && GetPC().PlayerInput != none)
    {
        GetPC().PlayerInput.ResetInput();
    }
}

function OnTraderTimeStart()
{
    if(CurrentMenu != none)
    {
        CurrentMenu.OnTraderTimeStart();
    }
}

function OnRoundOver()
{
    if(CurrentMenu != none)
    {
        CurrentMenu.OnRoundOver();
    }
}

function CloseTraderMenu()
{
    if(CurrentMenu == TraderMenu)
    {
        CloseMenus();
    }
}

function ShowWelcomeScreen()
{
    if((StartMenu != none) && StartMenu.OverviewContainer != none)
    {
        StartMenu.OverviewContainer.ShowWelcomeScreen();
    }
}

function NotifyUnsuccessfulSearch()
{
    if(CurrentMenu == StartMenu)
    {
        if(StartMenu.OptionsComponent != none)
        {
            StartMenu.OptionsComponent.SetSearching(false);
        }
        SetSearchingForMatch(false);
        OpenPopup(0, FailedSearchTitleString, FailedSearchString, BrowseServersString, Class'KFCommon_LocalizedStrings'.default.OKString, StartMenu.Callback_OpenServerBrowser);
    }
}

function AssignPendingLeftButtonDelegate(delegate<PendingLeftButtonDelegate> LeftDelegate)
{
    __PendingLeftButtonDelegate__Delegate = LeftDelegate;
}

function AssignPendingMiddleButtonDelegate(delegate<PendingMiddleButtonDelegate> MiddleDelegate)
{
    __PendingMiddleButtonDelegate__Delegate = MiddleDelegate;
}

function AssignPendingRightButtonDelegate(delegate<PendingRightButtonDelegate> RightDelegate)
{
    __PendingRightButtonDelegate__Delegate = RightDelegate;
}

function InitializePopup(name WidgetPath, KFGFxObject_Popup Widget)
{
    CurrentPopup = Widget;
    if(CurrentPopup != none)
    {
        SetWidgetPathBinding(Widget, WidgetPath);
        SetExternalInterface(Widget);
        CurrentPopup.InitializePopup(self);
        CurrentPopup.AssignLeftButtonDelegate(PendingLeftButtonDelegate);
        CurrentPopup.AssignMiddleButtonDelegate(PendingMiddleButtonDelegate);
        CurrentPopup.AssignRightButtonDelegate(PendingRightButtonDelegate);
        __PendingLeftButtonDelegate__Delegate = None;
        __PendingMiddleButtonDelegate__Delegate = None;
        __PendingRightButtonDelegate__Delegate = None;
    }
}

function OpenPopup(KFGFxMoviePlayer_Manager.EPopUpType PopupType, string TitleString, string DescriptionString, optional string LeftButtonString, optional string RightButtonString, optional delegate<PendingLeftButtonDelegate> LeftButtonDelegate, optional delegate<PendingRightButtonDelegate> RightButtonDelegate, optional string MiddleButtonString, optional delegate<PendingMiddleButtonDelegate> MiddleButtonDelegate, optional name OverridingSoundEffect)
{
    if((CurrentPopup != none) && PopupType == CurrentPopUpType)
    {
        CurrentPopup.UpdateDescritionText(DescriptionString);        
    }
    else
    {
        if(PopupData[PopupType].SWFPath != "")
        {
            UnloadCurrentPopup();
            CurrentPopUpType = PopupType;
            LoadPopup(PopupData[PopupType].SWFPath, TitleString, DescriptionString, LeftButtonString, RightButtonString, MiddleButtonString);
            bCaptureInput = true;
            bBlurLesserMovies = true;
            AssignPendingLeftButtonDelegate(LeftButtonDelegate);
            AssignPendingMiddleButtonDelegate(MiddleButtonDelegate);
            AssignPendingRightButtonDelegate(RightButtonDelegate);
            if(OverridingSoundEffect == 'None')
            {
                PlaySoundFromTheme('Alert_Popup', SoundThemeName);                
            }
            else
            {
                PlaySoundFromTheme(OverridingSoundEffect, SoundThemeName);
            }
        }
    }
}

function LoadPopup(string Path, optional string TitleString, optional string DescriptionString, optional string LeftButtonString, optional string RightButtonString, optional string MiddleButtonString)
{
    ManagerObject.ActionScriptVoid("loadCurrentPopup");
}

function UnloadCurrentPopup()
{
    ManagerObject.ActionScriptVoid("unloadCurrentPopup");
    if(CurrentPopup != none)
    {
        CurrentPopup.OnClosed();
        CurrentPopup = none;
        CurrentPopUpType = 3;
        bBlurLesserMovies = false;
        if(CurrentMenu == none)
        {
            bCaptureInput = false;
        }
    }
}

function LoadPopups(array<string> Paths)
{
    ManagerObject.ActionScriptVoid("loadPopups");
}

function UnloadPopups()
{
    ManagerObject.ActionScriptVoid("unloadPopups");
}

function ConditionalPauseGame(bool bPause)
{
    local WorldInfo WI;

    WI = Class'WorldInfo'.static.GetWorldInfo();
    if(WI.NetMode == NM_Standalone)
    {
        if(bPause)
        {
            if((((WI.IsMenuLevel() || !bAfterLobby) || CurrentMenu == TraderMenu) || (GetPC()) == none) || GetPC().WorldInfo.GRI.bMatchIsOver)
            {
                return;
            }
            GetPC().SetPause(true, CanUnpauseMenuClosed);            
        }
        else
        {
            if((GetPC()) != none)
            {
                GetPC().SetPause(false);
            }
        }
    }
}

function bool CanUnpauseMenuClosed()
{
    LogInternal("JOPILA - CanUnpauseMenuClosed" @ string(bMenusActive));
    return !bMenusActive;
}

function ClientRecieveNewTeam();

function OnLobbyStatusChanged(bool bIsInLobby)
{
    bPlayerInLobby = bIsInLobby;
    if(PartyWidget != none)
    {
        PartyWidget.UpdateInLobby(bIsInLobby);
    }
    if(CurrentMenu != none)
    {
        CurrentMenu.OnLobbyStatusChanged(bIsInLobby);
    }
    UpdateMenuBar();
}

function bool IsInLobby()
{
    if(OnlineLobby != none)
    {
        return OnlineLobby.IsInLobby();
    }
    return bPlayerInLobby;
}

function bool GetMultiplayerMenuActive()
{
    if(CurrentMenuIndex == 15)
    {
        return true;
    }
    if(((StartMenu != none) && CurrentMenuIndex == 0) && StartMenu.GetStartMenuState() == 0)
    {
        return true;
    }
    return false;
}

function KFGFxMoviePlayer_Manager.EStartMenuState GetStartMenuState()
{
    if(StartMenu != none)
    {
        return StartMenu.GetStartMenuState();
    }
    return 0;
}

function SetStartMenuState(KFGFxMoviePlayer_Manager.EStartMenuState MenuState)
{
    StartMenuState = MenuState;
    UpdateMenuBar();
}

function SetSearchingForMatch(bool bSearching)
{
    bSearchingForGame = bSearching;
    if(PartyWidget != none)
    {
        PartyWidget.SendSearching();
    }
}

function UpdateMenuBar()
{
    if(MenuBarWidget != none)
    {
        MenuBarWidget.UpdateMenu(CurrentMenuIndex);
    }
}

function HandleSteamLobbyLeaderTakeOver(UniqueNetId AdminId)
{
    if(StartMenu != none)
    {
        StartMenu.HandleSteamLobbyLeaderTakeOver(AdminId);
    }
}

function ChangeOverviewState(bool bLeaderIsOnServerBrowser)
{
    if(StartMenu != none)
    {
        StartMenu.bLeaderInServerBrowser = bLeaderIsOnServerBrowser;
    }
}

event bool FilterButtonInput(int ControllerId, name ButtonName, Core.Object.EInputEvent InputEvent)
{
    local KFPlayerReplicationInfo KFPRI;

    KFPRI = KFPlayerReplicationInfo(GetPC().PlayerReplicationInfo);
    if(Class'KFGameEngine'.static.IsFullScreenMoviePlaying())
    {
        return true;
    }
    if(((((bAfterLobby || GetPC().WorldInfo.GRI.bMatchIsOver) && InputEvent == 0) && (ButtonName == 'Escape') || ButtonName == 'XboxTypeS_Start') && bMenusOpen) && bCanCloseMenu || bPostGameState)
    {
        return ToggleMenus();        
    }
    else
    {
        if(InputEvent == 0)
        {
            if(ButtonName == 'XboxTypeS_RightThumbStick')
            {
                if(((!GetPC().WorldInfo.GRI.bMatchIsOver && !bAfterLobby) && !Class'WorldInfo'.static.IsMenuLevel()) && CurrentPopup == none)
                {
                    CurrentMenu.Callback_ReadyClicked(!KFPRI.bReadyToPlay);
                    PartyWidget.SetBool("bReady", KFPRI.bReadyToPlay);
                    PartyWidget.ReadyButton.SetBool("selected", KFPRI.bReadyToPlay);
                }                
            }
            else
            {
                if(MenuBarWidget != none)
                {
                    if(ButtonName == 'XboxTypeS_RightShoulder')
                    {
                        MenuBarWidget.CalloutButtonBumperPress(1);                        
                    }
                    else
                    {
                        if(ButtonName == 'XboxTypeS_LeftShoulder')
                        {
                            MenuBarWidget.CalloutButtonBumperPress(-1);
                        }
                    }
                }
            }
        }
    }
    if(CurrentMenu != none)
    {
        CurrentMenu.FilterButtonInput(ControllerId, ButtonName, InputEvent);
        if(!Class'WorldInfo'.static.IsConsoleBuild(8))
        {
            CheckIfUsingGamepad();
        }
    }
    return false;
}

function CheckIfUsingGamepad()
{
    local bool bGamepad;

    if(CurrentMenu != none)
    {
        bGamepad = GetUsingGamepad();
        if(bUsingGamepad != bGamepad)
        {
            OnInputTypeChanged(bGamepad);
        }
    }
}

function OnInputTypeChanged(bool bGamepad)
{
    ManagerObject.SetBool("bUsingGamepad", bGamepad);
    bUsingGamepad = bGamepad;
}

function bool GetUsingGamepad()
{
    local PlayerController PC;

    PC = GetPC();
    if((PC == none) || PC.PlayerInput == none)
    {
        return false;
    }
    return PC.PlayerInput.bUsingGamepad;
}

function UpdateDynamicIgnoreKeys()
{
    local name KeyBindName;
    local int I;

    if(((GetPC()) == none) || KFPlayerInput(GetPC().PlayerInput) == none)
    {
        return;
    }
    ClearFocusIgnoreKeys();
    I = 0;
    J0x57:

    if(I < IgnoredCommands.Length)
    {
        KeyBindName = GetKeyBindName(IgnoredCommands[I]);
        AddFocusIgnoreKey(KeyBindName);
        ++ I;
        goto J0x57;
    }
}

function name GetKeyBindName(string GBA_Command)
{
    local KFPlayerInput KFInput;
    local KeyBind MyKeyBind;

    KFInput = KFPlayerInput(GetPC().PlayerInput);
    KFInput.GetKeyBindFromCommand(MyKeyBind, GBA_Command, false);
    return MyKeyBind.Name;
}

function bool IsFocusIgnoreKey(string GBA_Command)
{
    if(IgnoredCommands.Find(GBA_Command != -1)
    {
        return true;
    }
    return false;
}

function UpdateVOIP(PlayerReplicationInfo PRI, bool bIsTalking)
{
    if(PartyWidget != none)
    {
        PartyWidget.UpdateVOIP(PRI, bIsTalking);
    }
    if(PostGameMenu != none)
    {
        PostGameMenu.VOIPEventTriggered(PRI, bIsTalking);
    }
}

function RemotePlayerDisconnected(UniqueNetId UniqueId);

function ShowKickVote(PlayerReplicationInfo PRI)
{
    VotePRI = PRI;
    if(bMenusOpen)
    {
        bKickVotePopupActive = true;
        OpenPopup(0, Class'KFGFxWidget_KickVote'.default.VoteKickString, VotePRI.PlayerName, Class'KFCommon_LocalizedStrings'.default.YesString, Class'KFCommon_LocalizedStrings'.default.NoString, CastYesVote, CastNoVote);
    }
}

simulated function HideKickVote()
{
    if(bKickVotePopupActive)
    {
        bKickVotePopupActive = false;
        UnloadCurrentPopup();
    }
    VotePRI = none;
}

function CastYesVote()
{
    local KFPlayerReplicationInfo KFPRI;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(GetPC());
    if(KFPC != none)
    {
        KFPRI = KFPlayerReplicationInfo(KFPC.PlayerReplicationInfo);
        if(KFPRI != none)
        {
            KFPRI.CastKickVote(KFPRI, true);
        }
    }
}

function CastNoVote()
{
    local KFPlayerReplicationInfo KFPRI;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(GetPC());
    if(KFPC != none)
    {
        KFPRI = KFPlayerReplicationInfo(KFPC.PlayerReplicationInfo);
        if(KFPRI != none)
        {
            KFPRI.CastKickVote(KFPRI, false);
        }
    }
}

function currentFocus()
{
    ManagerObject.ActionScriptVoid("currentFocus");
}

defaultproperties
{
    MenuSWFPaths(0)=(BaseSWFPath="../UI_Menus/StartMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(1)=(BaseSWFPath="../UI_Menus/PerksMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(2)=(BaseSWFPath="../UI_Menus/GearMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(3)=(BaseSWFPath="../UI_Menus/InventoryMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(4)=(BaseSWFPath="../UI_Menus/StoreMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(5)=(BaseSWFPath="../UI_Menus/OptionsSelectionMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(6)=(BaseSWFPath="../UI_Menus/ExitMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(7)=(BaseSWFPath="../UI_Menus/OptionsControlsMenu_SWF.swf",ConsoleSWFPath="../UI_Menus/OptionsControlsMenu_SWF_Console.swf")
    MenuSWFPaths(8)=(BaseSWFPath="../UI_Menus/OptionsAudioMenu_SWF.swf",ConsoleSWFPath="../UI_Menus/OptionsAudioMenu_SWF_Console.swf")
    MenuSWFPaths(9)=(BaseSWFPath="../UI_Menus/OptionsGraphicsMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(10)=(BaseSWFPath="../UI_Menus/OptionsGameSettingsMenu_SWF.swf",ConsoleSWFPath="../UI_Menus/OptionsGameSettingsMenu_SWF_Console.swf")
    MenuSWFPaths(11)=(BaseSWFPath="",ConsoleSWFPath="")
    MenuSWFPaths(12)=(BaseSWFPath="",ConsoleSWFPath="")
    MenuSWFPaths(13)=(BaseSWFPath="../UI_Menus/PostGameMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(14)=(BaseSWFPath="../UI_Menus/TraderMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(15)=(BaseSWFPath="../UI_Menus/ServerBrowserMenu_SWF.swf",ConsoleSWFPath="")
    MenuSWFPaths(16)=(BaseSWFPath="../UI_Menus/IISMenu_SWF.swf",ConsoleSWFPath="")
    CurrentMenuIndex=255
    InGamePartyWidgetClass=Class'KFGFxWidget_PartyInGame'
    PopupData(0)=(SWFPath="../UI_PopUps/ConfirmationPopup_SWF.swf",TitleStrings=none,DescriptionStrings=none,LeftButtonString="",RightButtonString="")
    PopupData(1)=(SWFPath="../UI_PopUps/GammaPopup_SWF.swf",TitleStrings=none,DescriptionStrings=none,LeftButtonString="",RightButtonString="")
    PopupData(2)=(SWFPath="../UI_PopUps/ConnectionErrorPopup_SWF.swf",TitleStrings=none,DescriptionStrings=none,LeftButtonString="",RightButtonString="")
    PopupData(3)=(SWFPath="",TitleStrings=none,DescriptionStrings=none,LeftButtonString="",RightButtonString="")
    PopupData(4)=(SWFPath="../UI_PopUps/InputPromptPopup_SWF.swf",TitleStrings=none,DescriptionStrings=none,LeftButtonString="",RightButtonString="")
    FailedSearchTitleString="FAILED TO FIND MATCH"
    FailedSearchString="Matchmaking failed to find a match with the options provided. Please broaden your search or consider using the server browser to find a match."
    BrowseServersString="BROWSE SERVERS"
    HasInvitedToGameString=" has invited you to a game"
    JoinGameString="Join Game?"
    WidgetPaths(0)="../UI_Widgets/MenuBarWidget_SWF.swf"
    WidgetPaths(1)="../UI_Widgets/PartyWidget_SWF.swf"
    WidgetPaths(2)="../UI_Widgets/ButtonPromptWidget_SWF.swf"
    BackgroundMovie=TextureMovie'UI_Managers.MenuBG'
    IISMovie=TextureMovie'UI_Managers.IIS'
    IgnoredCommands(0)="GBA_VoiceChat"
    SoundThemeName=ButtonSoundTheme
    MouseInputChangedThreshold=5
    MovieInfo=SwfMovie'UI_Managers.LoaderManager_SWF'
    bAutoPlay=true
    bCaptureInput=true
    SoundThemes=/* Array type was not detected. */
    WidgetBindings=/* Array type was not detected. */
}