/*******************************************************************************
 * KFGameInfo_Entry generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGameInfo_Entry extends KFGameInfo
    config(Game)
    hidecategories(Navigation,Movement,Collision);

var bool bInitialized;
var int LastSystemTimeMinutes;

static function PreloadContentClasses();

function bool NeedPlayers();

function Pawn SpawnDefaultPawnFor(Controller NewPlayer, NavigationPoint StartSpot);

function InitSpawnManager();

function InitTraderList();

function StartMatch()
{
    local PlayerController PC;
    local LocalPlayer LP;

    foreach LocalPlayerControllers(Class'PlayerController', PC)
    {
        LP = LocalPlayer(PC.Player);
        if(LP != none)
        {
            LP.RemoveAllPostProcessingChains();
            LP.InsertPostProcessingChain(LP.Outer.GetWorldPostProcessChain(), -1, true);
            if(PC.myHUD != none)
            {
                PC.myHUD.NotifyBindPostProcessEffects();
            }
        }        
    }    
}

event InitGame(string Options, out string ErrorMessage)
{
    if((ParseOption(Options, "PerformUnitTests")) ~= "1")
    {
        if(MyAutoTestManager == none)
        {
            MyAutoTestManager = Spawn(AutoTestManagerClass);
        }
        MyAutoTestManager.InitializeOptions(Options);
    }
    if(HasOption(Options, "Closed"))
    {
        Class'KFGameEngine'.static.RefreshOnlineGameData();
    }
    LastSystemTimeMinutes = GetSystemTimeMinutes();
    BroadcastHandler = Spawn(BroadcastHandlerClass);
}

private final function int GetSystemTimeMinutes()
{
    local int Year, Month, DayOfWeek, Day, Hour, minute,
	    second, MSec;

    GetSystemTime(Year, Month, DayOfWeek, Day, Hour, minute, second, MSec);
    return (minute + (Hour * 60)) + ((Day * 60) * 24);
}

function Tick(float DeltaTime)
{
    super.Tick(DeltaTime);
    if(!bInitialized)
    {
        ForceMenuMusicTrack();
        bInitialized = true;
    }
}

exec function FinishCraft()
{
    local KFPlayerController KFPC;

    LogInternal("!!!!!!!!!!!!!!!!!!!!!!!!!");
    foreach LocalPlayerControllers(Class'KFPlayerController', KFPC)
    {
        if((KFPC.MyGFxManager != none) && KFPC.MyGFxManager.InventoryMenu != none)
        {
            KFPC.MyGFxManager.InventoryMenu.FinishCraft();
        }        
    }    
}

auto state PendingMatch
{
    ignores RestartPlayer, EndState;

    function Timer()
    {
        local int SystemTimeMinutes;

        SystemTimeMinutes = GetSystemTimeMinutes();
        if((SystemTimeMinutes - LastSystemTimeMinutes) >= 30)
        {
            Class'KFGameEngine'.static.RefreshOnlineGameData();
            LastSystemTimeMinutes = SystemTimeMinutes;
        }
    }

    function BeginState(name PreviousStateName)
    {
        bWaitingToStartMatch = true;
    }
    stop;    
}
