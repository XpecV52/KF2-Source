/*******************************************************************************
 * KFGFxWidget_PartyMainMenu generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxWidget_PartyMainMenu extends KFGFxWidget_BaseParty within GFxMoviePlayer;

var bool bIsInParty;

function OneSecondLoop()
{
    if((OnlineLobby != none) && OnlineLobby.IsInLobby())
    {
        SendMyOptions();
        SendSearching();
        UpdateInLobby(true);        
    }
    else
    {
        UpdateInLobby(false);
    }
    RefreshParty();
}

function InitializeWidget()
{
    super.InitializeWidget();
    SetReadyButtonVisibility(false);
}

function SendSearching()
{
    local string SearchingTextString, SearchingMessage;
    local UniqueNetId AdminId;
    local bool bIsLeader;

    if(Manager == none)
    {
        return;
    }
    if((OnlineLobby != none) && OnlineLobby.IsInLobby())
    {
        OnlineLobby.GetLobbyAdmin(OnlineLobby.GetCurrentLobbyId(), AdminId);
        bIsLeader = Outer.GetPC().PlayerReplicationInfo.UniqueId == AdminId;
        if(bIsLeader)
        {
            if(Manager.CurrentMenuIndex == 0)
            {
                if(Manager.bSearchingForGame)
                {
                    SearchingTextString = SearchingForGameString;
                    SetSearchingText(SearchingTextString);
                    SearchingMessage = SearchingForGame;                    
                }
                else
                {
                    SearchingMessage = UpdatingOptions;
                }                
            }
            else
            {
                if(Manager.CurrentMenuIndex == 15)
                {
                    SearchingMessage = ServerBrowserOpen;                    
                }
                else
                {
                    SearchingMessage = InOtherMenu;
                }
            }
            OnlineLobby.LobbyMessage(SearchingPrefix $ SearchingMessage);
        }        
    }
    else
    {
        if(Manager.bSearchingForGame)
        {
            SearchingTextString = SearchingForGameString;
            SetSearchingText(SearchingTextString);            
        }
        else
        {
            SetSearchingText(SearchingTextString);
        }
    }
}

function SetSearchingText(string Message)
{
    SetString("searchingText", Message);
}

function RefreshParty()
{
    local ActiveLobbyInfo LobbyInfo;
    local UniqueNetId AdminId;
    local int SlotIndex;
    local bool bInParty;
    local PlayerController PC;
    local string PlayerName, ReadablePlayerName;

    super.RefreshParty();
    if((OnlineLobby != none) && OnlineLobby.GetCurrentLobby(LobbyInfo))
    {
        OnlineLobby.GetLobbyAdmin(OnlineLobby.GetCurrentLobbyId(), AdminId);
        if(PartyChatWidget != none)
        {
            PartyChatWidget.SetLobbyChatVisible(LobbyInfo.Members.Length > 1);
        }
        if(AdminId != LastLeaderID)
        {
            HandleLeaderChange(AdminId);
        }
        OccupiedSlots = LobbyInfo.Members.Length;
        bInParty = (OccupiedSlots > 1) || bInLobby;
        if(bIsInParty != bInParty)
        {
            EmptySlot(0);
            bIsInParty = bInParty;
        }
        SlotIndex = 0;
        J0x19D:

        if(SlotIndex < PlayerSlots)
        {
            if(SlotIndex < LobbyInfo.Members.Length)
            {
                RefreshSlot(SlotIndex, LobbyInfo.Members[SlotIndex].PlayerUID);                
            }
            else
            {
                if(MemberSlots[SlotIndex].bIsSlotTaken)
                {
                    EmptySlot(SlotIndex);
                }
            }
            ++ SlotIndex;
            goto J0x19D;
        }        
    }
    else
    {
        PC = Outer.GetPC();
        RefreshSlot(0, PC.PlayerReplicationInfo.UniqueId);
        InitializePerk();
        bInParty = false || bInLobby;
        bIsInParty = bInParty;
        SetSearchingText("");
        ReadablePlayerName = PC.PlayerReplicationInfo.GetHumanReadableName();
        if(OnlineLobby != none)
        {
            PlayerName = OnlineLobby.GetFriendNickname(PC.PlayerReplicationInfo.UniqueId);
        }
        UpdatePlayerName(0, ((PlayerName != "") ? PlayerName : ((ReadablePlayerName == DefaultPlayerName) ? DefaultPlayerName $ "0" : ReadablePlayerName)));
        if(PartyChatWidget != none)
        {
            PartyChatWidget.SetLobbyChatVisible(false);
        }
        SlotIndex = 1;
        J0x463:

        if(SlotIndex < PlayerSlots)
        {
            if(MemberSlots[SlotIndex].bIsSlotTaken)
            {
                EmptySlot(SlotIndex);
            }
            ++ SlotIndex;
            goto J0x463;
        }
    }
    UpdateSoloSquadText();
}

function HandleLeaderChange(UniqueNetId AdminId)
{
    local string HostName;

    if(OnlineLobby != none)
    {
        HostName = OnlineLobby.GetFriendNickname(AdminId);
    }
    HostName = OnlineLobby.GetFriendNickname(AdminId);
    Manager.HandleSteamLobbyLeaderTakeOver(AdminId);
    if(LastLeaderID != ZeroUniqueId)
    {
        Manager.OpenPopup(2, PartHostLeftString, HostName @ PartyLeaderChangedString, Class'KFCommon_LocalizedStrings'.default.OKString);
    }
    LastLeaderID = AdminId;
}

function RefreshSlot(int SlotIndex, UniqueNetId PlayerUID)
{
    local string PlayerName, ReadablePlayerName;
    local UniqueNetId AdminId;
    local bool bIsLeader, bIsMyPlayer;
    local PlayerController PC;

    PC = Outer.GetPC();
    if(OnlineLobby != none)
    {
        OnlineLobby.GetLobbyAdmin(OnlineLobby.GetCurrentLobbyId(), AdminId);
    }
    if(Class'WorldInfo'.static.IsConsoleBuild(8))
    {
        bIsLeader = PlayerUID == AdminId && (Manager.StartMenuState != 2) && Manager.StartMenuState != 255;        
    }
    else
    {
        bIsLeader = PlayerUID == AdminId;
    }
    MemberSlots[SlotIndex].bIsSlotTaken = true;
    MemberSlots[SlotIndex].bIsLeader = bIsLeader;
    MemberSlots[SlotIndex].PlayerUID = PlayerUID;
    bIsMyPlayer = PC.PlayerReplicationInfo.UniqueId == PlayerUID;
    if(OnlineLobby != none)
    {
        PlayerName = OnlineLobby.GetFriendNickname(PlayerUID);
    }
    if(PlayerName == "")
    {
        ReadablePlayerName = PC.PlayerReplicationInfo.GetHumanReadableName();
        PlayerName = ((ReadablePlayerName == DefaultPlayerName) ? DefaultPlayerName $ string(SlotIndex) : ReadablePlayerName);
    }
    UpdatePlayerName(SlotIndex, PlayerName);
    SlotChanged(SlotIndex, true, bIsMyPlayer, bIsLeader);
    CreatePlayerOptions(PlayerUID, SlotIndex);
    MemberSlots[SlotIndex].MemberSlotObject.SetString("profileImageSource", KFPC.GetSteamAvatar(PlayerUID));
}

function InitializePerk()
{
    local KFPerk CurrentPerk;
    local string PerkIconPath;
    local class<KFPerk> PerkClass;
    local byte PerkLevel;

    CurrentPerk = KFPC.GetPerk();
    if(CurrentPerk != none)
    {
        PerkClass = KFPlayerReplicationInfo(Outer.GetPC().PlayerReplicationInfo).CurrentPerkClass;
        PerkLevel = CurrentPerk.GetLevel();
        if((PerkClass != MemberSlots[0].PerkClass) || PerkLevel != MemberSlots[0].PerkLevel)
        {
            MemberSlots[0].PerkClass = PerkClass;
            PerkIconPath = "img://" $ CurrentPerk.GetPerkIconPath();
            UpdatePerk(0, CurrentPerk.PerkName, string(PerkLevel), PerkIconPath);
        }
    }
}

function UpdatePerks(string Message)
{
    local array<string> PlayerInfoStrings;
    local UniqueNetId PlayerID;
    local string PerkName, IconPath, PerkLevel;
    local ActiveLobbyInfo LobbyInfo;
    local byte I;
    local int PerkIndex;

    ParseStringIntoArray(Message, PlayerInfoStrings, "/", true);
    Class'OnlineSubsystem'.static.StringToUniqueNetId(PlayerInfoStrings[0], PlayerID);
    PerkIndex = int(PlayerInfoStrings[1]);
    PerkName = KFPC.PerkList[PerkIndex].PerkClass.default.PerkName;
    IconPath = "img://" $ KFPC.PerkList[PerkIndex].PerkClass.static.GetPerkIconPath();
    PerkLevel = PlayerInfoStrings[2];
    if(OnlineLobby == none)
    {
        return;
    }
    if(OnlineLobby.GetCurrentLobby(LobbyInfo))
    {
        I = 0;
        J0x187:

        if(I < LobbyInfo.Members.Length)
        {
            if(LobbyInfo.Members[I].PlayerUID == PlayerID)
            {
                UpdatePlayerName(I, OnlineLobby.GetFriendNickname(PlayerID));
                UpdatePerk(I, PerkName, PerkLevel, IconPath);
            }
            ++ I;
            goto J0x187;
        }
    }
}

function UpdateSearching(string Message)
{
    local string SearchingText, PartyLeaderName;
    local UniqueNetId AdminId;

    if(OnlineLobby != none)
    {
        OnlineLobby.GetLobbyAdmin(OnlineLobby.GetCurrentLobbyId(), AdminId);
        PartyLeaderName = OnlineLobby.GetFriendNickname(AdminId);
    }
    switch(Message)
    {
        case InOtherMenu:
            SearchingText = PartyLeaderInOtherMenuString;
            break;
        case ServerBrowserOpen:
            Manager.ChangeOverviewState(true);
            SearchingText = PartyLeaderInServerBrowserString;
            break;
        case SearchingForGame:
            SearchingText = PartyLeaderSearchingForMatchString;
            break;
        case UpdatingOptions:
            Manager.ChangeOverviewState(false);
            SearchingText = PartyLeaderIsUpdatingMatchOptionsString;
            break;
        case InOtherMenu:
            SearchingText = PartyLeaderInOtherMenuString;
            break;
        default:
            break;
    }
    SetSearchingText(PartyLeaderName @ SearchingText);
}

function ToggelMuteOnPlayer(int SlotIndex)
{
    local ActiveLobbyInfo LobbyInfo;

    if(OnlineLobby != none)
    {
        OnlineLobby.GetCurrentLobby(LobbyInfo);
        if(LobbyInfo.Members.Length > SlotIndex)
        {
            LogInternal("CALL MUTE FOR PLAYER: " @ OnlineLobby.GetFriendNickname(LobbyInfo.Members[SlotIndex].PlayerUID));
        }
    }
}

function ViewProfile(int SlotIndex)
{
    local ActiveLobbyInfo LobbyInfo;

    if(OnlineLobby != none)
    {
        OnlineLobby.GetCurrentLobby(LobbyInfo);
        if(LobbyInfo.Members.Length > SlotIndex)
        {
            LogInternal("View PLAYER profile: " @ OnlineLobby.GetFriendNickname(LobbyInfo.Members[SlotIndex].PlayerUID));
        }
    }
}

function AddFriend(int SlotIndex)
{
    local ActiveLobbyInfo LobbyInfo;
    local LocalPlayer LocPlayer;

    LocPlayer = LocalPlayer(Outer.GetPC().Player);
    if(OnlineLobby != none)
    {
        OnlineLobby.GetCurrentLobby(LobbyInfo);
        if(LobbyInfo.Members.Length > SlotIndex)
        {
            if(OnlineSub.IsFriend(byte(LocPlayer.ControllerId), LobbyInfo.Members[SlotIndex].PlayerUID))
            {
                if(!OnlineSub.RemoveFriend(byte(LocPlayer.ControllerId), LobbyInfo.Members[SlotIndex].PlayerUID))
                {
                    LogInternal("Failed to remove friend!");
                }                
            }
            else
            {
                if(!OnlineSub.AddFriend(byte(LocPlayer.ControllerId), LobbyInfo.Members[SlotIndex].PlayerUID))
                {
                    LogInternal("Failed to add friend!");
                }
            }
        }
    }
}

function SendMyOptions()
{
    local KFPerk CurrentPerk;
    local int PerkIndex;
    local string CurrentLevel, PerkMessage, UIDStrings;

    CurrentPerk = KFPC.GetPerk();
    PerkIndex = KFPC.GetPerkIndexFromClass(CurrentPerk.Class);
    CurrentLevel = string(KFPC.GetLevel());
    UIDStrings = Class'OnlineSubsystem'.static.UniqueNetIdToString(Outer.GetPC().PlayerReplicationInfo.UniqueId);
    PerkMessage = ((((PerkPrefix $ UIDStrings) $ "/") $ string(PerkIndex)) $ "/") $ CurrentLevel;
    if(OnlineLobby != none)
    {
        OnlineLobby.LobbyMessage(PerkMessage);
    }
}
