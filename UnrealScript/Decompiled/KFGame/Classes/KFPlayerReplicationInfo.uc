/*******************************************************************************
 * KFPlayerReplicationInfo generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFPlayerReplicationInfo extends PlayerReplicationInfo
    native(ReplicationInfo)
    nativereplication
    config(Game)
    hidecategories(Navigation,Movement,Collision);

const NUM_COSMETIC_ATTACHMENTS = 3;

struct native CustomizationInfo
{
    var byte CharacterIndex;
    var byte HeadMeshIndex;
    var byte HeadSkinIndex;
    var byte BodyMeshIndex;
    var byte BodySkinIndex;
    var byte AttachmentMeshIndices[3];
    var byte AttachmentSkinIndices[3];

    structdefaultproperties
    {
        CharacterIndex=0
        HeadMeshIndex=0
        HeadSkinIndex=0
        BodyMeshIndex=0
        BodySkinIndex=0
        AttachmentMeshIndices[0]=255
        AttachmentMeshIndices[1]=255
        AttachmentMeshIndices[2]=255
        AttachmentSkinIndices[0]=0
        AttachmentSkinIndices[1]=0
        AttachmentSkinIndices[2]=0
    }
};

var array<KFCharacterInfo_Human> CharacterArchetypes;
var config byte StoredCharIndex;
var byte NumTimesReconnected;
var repnotify byte VOIPStatus;
var byte NetPerkIndex;
var private byte ActivePerkLevel;
var byte Assists;
var byte PlayerHealth;
var byte PlayerHealthMax;
var byte SharedUnlocks;
var float LastQuitTime;
var repnotify CustomizationInfo RepCustomizationInfo;
var Texture CharPortrait;
var class<KFPerk> CurrentPerkClass;
var bool bExtraFireRange;
var bool bSplashActive;
var bool bNukeActive;
var bool bConcussiveActive;
var bool bObjectivePlayer;

replication
{
     if(bNetDirty)
        ActivePerkLevel, Assists, 
        CurrentPerkClass, NetPerkIndex, 
        PlayerHealth, PlayerHealthMax, 
        RepCustomizationInfo, bConcussiveActive, 
        bExtraFireRange, bNukeActive, 
        bObjectivePlayer, bSplashActive;

     if(bNetDirty && !bNetOwner || bDemoRecording)
        SharedUnlocks, VOIPStatus;
}

// Export UKFPlayerReplicationInfo::execSaveCharacterConfig(FFrame&, void* const)
native function SaveCharacterConfig(string SectionString);

// Export UKFPlayerReplicationInfo::execLoadCharacterConfig(FFrame&, void* const)
native function LoadCharacterConfig(string SectionString);

simulated event ReplicatedEvent(name VarName)
{
    if(VarName == 'RepCustomizationInfo')
    {
        UpdateCustomizationPawn(RepCustomizationInfo.CharacterIndex);        
    }
    else
    {
        if(VarName == 'VOIPStatus')
        {
            VOIPStatusChanged(self, VOIPStatus > 0);            
        }
        else
        {
            if(VarName == 'Score')
            {
                UpdateTraderDosh();
            }
        }
    }
    super.ReplicatedEvent(VarName);
}

simulated event PostBeginPlay()
{
    super.PostBeginPlay();
}

simulated function byte GetActivePerkLevel()
{
    return ActivePerkLevel;
}

reliable server function ServerNotifyStartVoip()
{
    local int I;
    local KFPlayerController KFPC;
    local KFGameInfo KFGI;

    KFPC = KFPlayerController(Owner);
    if(KFPC == none)
    {
        return;
    }
    KFGI = KFGameInfo(WorldInfo.Game);
    if(KFGI == none)
    {
    }
    if(!KFGI.bDisableVOIP)
    {
        if(!bOnlySpectator)
        {
            VOIPStatus = 1;
            bNetDirty = true;
            bForceNetUpdate = true;
            if(!KFPC.IsLocalController())
            {
                VOIPStatusChanged(self, true);
            }
            KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
            if((KFPC.Pawn != none) && KFPC.Pawn.Health > 0)
            {
                I = 0;
                J0x19E:

                if(I < WorldInfo.GRI.PRIArray.Length)
                {
                    if(!WorldInfo.GRI.PRIArray[I].bBot)
                    {
                        KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
                        if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
                        {
                            PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
                        }
                    }
                    ++ I;
                    goto J0x19E;
                }                
            }
            else
            {
                if(KFGI.bEnableDeadToDeadVOIP)
                {
                    I = 0;
                    J0x3C8:

                    if(I < WorldInfo.GRI.PRIArray.Length)
                    {
                        if(!WorldInfo.GRI.PRIArray[I].bBot)
                        {
                            KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
                            if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
                            {
                                PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
                            }
                        }
                        ++ I;
                        goto J0x3C8;
                    }                    
                }
                else
                {
                    VOIPStatus = 0;
                    bNetDirty = true;
                    bForceNetUpdate = true;
                    if(!KFPC.IsLocalController())
                    {
                        VOIPStatusChanged(self, false);
                    }
                }
            }
            if(KFPC.VoiceReceivers.Length <= 0)
            {
                KFPC.VoiceReceivers.AddItem(UniqueId;
            }            
        }
        else
        {
            ServerStartSpectatorVoiceChat();
        }        
    }
    else
    {
        VOIPStatus = 0;
        bNetDirty = true;
        bForceNetUpdate = true;
        if(!KFPC.IsLocalController())
        {
            VOIPStatusChanged(self, false);
        }
        KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
        KFPC.VoiceReceivers.AddItem(UniqueId;
    }
}

function ServerStartSpectatorVoiceChat()
{
    local int I;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    ClearTimer('ClearVOIP');
    KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
    VOIPStatus = ((KFGameInfo(WorldInfo.Game).bPartitionSpectators) ? 6 : 5);
    I = 0;
    J0xCB:

    if(I < WorldInfo.GRI.PRIArray.Length)
    {
        if(!WorldInfo.GRI.PRIArray[I].bBot && (!KFGameInfo(WorldInfo.Game).bPartitionSpectators || WorldInfo.GRI.PRIArray[I].GetTeamNum() >= 2) || WorldInfo.GRI.PRIArray[I].bOnlySpectator)
        {
            KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
            if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
            {
                PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
            }
        }
        ++ I;
        goto J0xCB;
    }
    if(KFPC.VoiceReceivers.Length <= 0)
    {
        KFPC.VoiceReceivers.AddItem(UniqueId;
    }
}

reliable server function ServerNotifyStopVOIP()
{
    local KFPlayerController KFPC;

    VOIPStatus = 0;
    VOIPStatusChanged(self, false);
    KFPC = KFPlayerController(Owner);
    KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
    foreach WorldInfo.AllControllers(Class'KFPlayerController', KFPC)
    {
        J0xA8:

        if(KFPC.VoiceSenders.Find('Uid', UniqueId.Uid != -1)
        {
            KFPC.VoiceSenders.RemoveItem(UniqueId;
            goto J0xA8;
        }        
    }    
}

simulated function VOIPStatusChanged(PlayerReplicationInfo Talker, bool bIsTalking)
{
    local KFPlayerController KFPC;
    local KFPlayerReplicationInfo TalkerKFPRI;
    local KFGFxHudWrapper MyGFxHUD;

    foreach WorldInfo.LocalPlayerControllers(Class'KFPlayerController', KFPC)
    {
        MyGFxHUD = KFGFxHudWrapper(KFPC.myHUD);
        TalkerKFPRI = KFPlayerReplicationInfo(Talker);
        if(TalkerKFPRI != none)
        {
            if((TalkerKFPRI.VOIPStatus == 6) && !KFPC.PlayerReplicationInfo.bOnlySpectator)
            {                
                return;
            }
        }
        if((MyGFxHUD != none) && MyGFxHUD.HudMovie != none)
        {
            MyGFxHUD.HudMovie.VOIPWidget.VOIPEventTriggered(Talker, bIsTalking);
        }
        if(KFPC.MyGFxManager != none)
        {
            KFPC.MyGFxManager.UpdateVOIP(Talker, bIsTalking);
        }        
    }    
}

reliable client simulated function ShowKickVote(PlayerReplicationInfo PRI, byte VoteDuration, bool bShowChoices)
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.MyGFxHUD != none)
    {
        KFPC.MyGFxHUD.ShowKickVote(PRI, VoteDuration, bShowChoices);
    }
    if(((KFPC != none) && KFPC.MyGFxManager != none) && bShowChoices)
    {
        KFPC.MyGFxManager.ShowKickVote(PRI);
    }
}

reliable client simulated function HideKickVote()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.MyGFxHUD != none)
    {
        KFPC.MyGFxHUD.HideKickVote();
    }
    if((KFPC != none) && KFPC.MyGFxManager != none)
    {
        KFPC.MyGFxManager.HideKickVote();
    }
}

reliable server function ServerStartKickVote(PlayerReplicationInfo Kickee, PlayerReplicationInfo Kicker)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI != none)
    {
        KFGRI.ServerStartVoteKick(Kickee, Kicker);
    }
}

simulated function CastKickVote(PlayerReplicationInfo PRI, bool bKick)
{
    local KFPlayerController KFPC;

    ServerCastKickVote(self, bKick);
    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.MyGFxManager != none)
    {
        KFPC.MyGFxManager.HideKickVote();
    }
}

reliable server function ServerCastKickVote(PlayerReplicationInfo PRI, bool bKick)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI != none)
    {
        KFGRI.RecieveVoteKick(PRI, bKick);
    }
}

simulated function CastMapVote(int MapIndex, bool bDoubleClick)
{
    local KFGameInfo KFGI;

    ServerCastMapVote(self, MapIndex);
    if(WorldInfo.NetMode == NM_Standalone)
    {
        KFGI = KFGameInfo(WorldInfo.Game);
        if(KFGI != none)
        {
            KFGI.UpdateCurrentMapVoteTime(((bDoubleClick) ? 0 : 5));
        }
    }
}

reliable server function ServerCastMapVote(PlayerReplicationInfo PRI, int MapIndex)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI != none)
    {
        KFGRI.ReceiveVoteMap(PRI, MapIndex);
    }
}

reliable client simulated function RecieveAARMapOption(string MapOption)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if((KFGRI != none) && KFGRI.VoteCollector != none)
    {
        KFGRI.VoteCollector.AddMapOption(MapOption);
    }
}

reliable client simulated function RecieveTopMaps(TopVotes VoteObject)
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if(((KFPC != none) && KFPC.MyGFxManager != none) && KFPC.MyGFxManager.PostGameMenu != none)
    {
        KFPC.MyGFxManager.PostGameMenu.RecieveTopMaps(VoteObject);
    }
}

// Export UKFPlayerReplicationInfo::execServerSetSharedUnlocks(FFrame&, void* const)
private reliable server native final event ServerSetSharedUnlocks(byte NewUnlocks);

simulated function SetCharacter(int Index)
{
    StoredCharIndex = byte(Index);
    SaveConfig();
    InitializeCharacter(byte(Index));
}

reliable server event SeverAnnounceNewSharedContent()
{
    if((WorldInfo.GRI != none) && WorldInfo.GRI.bMatchHasBegun)
    {
        BroadcastLocalizedMessage(Class'KFLocalMessage_Game', 20, self);
    }
}

simulated function ClientInitialize(Controller C)
{
    if((Role < ROLE_Authority) && C == Owner)
    {
        return;
    }
    SetOwner(C);
    if(C.IsLocalController())
    {
        KFPlayerController(C).InitializeStats();
        InitializeCharacter(StoredCharIndex);
        Class'KFUnlockManager'.static.InitSharedUnlocksFor(self);
    }
}

simulated function InitializeCharacter(byte CharIndex)
{
    if(!Class'KFUnlockManager'.static.GetAvailable((CharacterArchetypes[CharIndex])))
    {
        CharIndex = byte(GetValidCharacterIndex(CharIndex));
        StoredCharIndex = CharIndex;
    }
    LoadCharacterConfig(PathName(CharacterArchetypes[CharIndex]));
    if(Role < ROLE_Authority)
    {
        ServerSetCharacter(RepCustomizationInfo);        
    }
    else
    {
        UpdateCustomizationPawn(CharIndex);
    }
}

simulated function int GetValidCharacterIndex(byte CharIndex)
{
    local byte I;

    I = 0;
    J0x0C:

    if(I < CharacterArchetypes.Length)
    {
        if(Class'KFUnlockManager'.static.GetAvailable((CharacterArchetypes[CharIndex])))
        {
            return I;
        }
        ++ I;
        goto J0x0C;
    }
    return 0;
}

private reliable server final function ServerSetCharacter(CustomizationInfo NewMeshInfo)
{
    local int I;

    RepCustomizationInfo.CharacterIndex = NewMeshInfo.CharacterIndex;
    RepCustomizationInfo.BodyMeshIndex = NewMeshInfo.BodyMeshIndex;
    RepCustomizationInfo.HeadMeshIndex = NewMeshInfo.HeadMeshIndex;
    RepCustomizationInfo.HeadSkinIndex = NewMeshInfo.HeadSkinIndex;
    RepCustomizationInfo.BodySkinIndex = NewMeshInfo.BodySkinIndex;
    I = 0;
    J0x128:

    if(I < 3)
    {
        RepCustomizationInfo.AttachmentMeshIndices[I] = NewMeshInfo.AttachmentMeshIndices[I];
        RepCustomizationInfo.AttachmentSkinIndices[I] = NewMeshInfo.AttachmentSkinIndices[I];
        ++ I;
        goto J0x128;
    }
    if(Role == ROLE_Authority)
    {
        UpdateCustomizationPawn(RepCustomizationInfo.CharacterIndex);
    }
}

simulated function UpdateCustomizationPawn(byte CharIndex)
{
    local KFPawn_Human KFP;

    foreach WorldInfo.AllPawns(Class'KFPawn_Human', KFP)
    {
        if((KFP.PlayerReplicationInfo == self) || (KFP.DrivenVehicle != none) && KFP.DrivenVehicle.PlayerReplicationInfo == self)
        {
            KFP.UpdateCustomizationChar(CharacterArchetypes[CharIndex]);
        }        
    }    
}

function PlayerReplicationInfo Duplicate()
{
    local KFPlayerReplicationInfo NewKFPRI;

    NewKFPRI = KFPlayerReplicationInfo(super.Duplicate());
    NewKFPRI.LastQuitTime = LastQuitTime;
    NewKFPRI.NumTimesReconnected = NumTimesReconnected;
    return NewKFPRI;
}

simulated function SetPlayerReady(bool bReady)
{
    bReadyToPlay = bReady;
    ServerSetPlayerReady(bReady);
}

private reliable server final function ServerSetPlayerReady(bool bReady)
{
    bReadyToPlay = bReady;
}

function AddDosh(int DoshAmount, optional bool bEarned)
{
    Score = float(Max(0, int(Score + float(DoshAmount))));
    if(WorldInfo.NetMode == NM_ListenServer)
    {
        UpdateTraderDosh();
    }
    if(bEarned && DoshAmount > 0)
    {
        if((KFPlayerController(Owner) != none) && KFPlayerController(Owner).MatchStats != none)
        {
            KFPlayerController(Owner).MatchStats.RecordIntStat(1, DoshAmount);
        }
    }
}

simulated function UpdateTraderDosh()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.bClientTraderMenuOpen)
    {
        KFPC.NotifyTraderDoshChanged();
    }
}

simulated event Destroyed()
{
    NotifyHUDofPRIDestroyed();
    super.Destroyed();
}

simulated function NotifyHUDofPRIDestroyed()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(GetALocalPlayerController());
    ServerNotifyStopVOIP();
    if(KFPC != none)
    {
        if(KFPC.MyGFxHUD != none)
        {
            KFPC.MyGFxHUD.NotifyHUDofPRIDestroyed(self);
        }
        if((KFPC != Owner) && KFPC.MyGFxManager != none)
        {
            KFPC.MyGFxManager.RemotePlayerDisconnected(UniqueId);
        }
    }
}

function IncrementDeaths(optional int Amt)
{
    Amt = 1;
    if((WorldInfo.GRI != none) && WorldInfo.GRI.bMatchHasBegun)
    {
        super.IncrementDeaths(Amt);
    }
}

defaultproperties
{
    CharacterArchetypes(0)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Ana_Archetype'
    CharacterArchetypes(1)=KFCharacterInfo_Human'CHR_Playable_ARCH.chr_DJSkully_archetype'
    CharacterArchetypes(2)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Coleman_archetype'
    CharacterArchetypes(3)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Tanaka_Archetype'
    CharacterArchetypes(4)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Masterson_Archetype'
    CharacterArchetypes(5)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_MrFoster_archetype'
    CharacterArchetypes(6)=KFCharacterInfo_Human'CHR_Playable_ARCH.chr_briar_archetype'
    CharacterArchetypes(7)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Alberts_archetype'
    CharacterArchetypes(8)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Mark_archetype'
    CharacterArchetypes(9)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Alan_Archetype'
    CharacterArchetypes(10)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Strasser_Archetype'
    CharacterArchetypes(11)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Knight_Archetype'
    RepCustomizationInfo=(CharacterIndex=0,HeadMeshIndex=0,HeadSkinIndex=0,BodyMeshIndex=0,BodySkinIndex=0,AttachmentMeshIndices=255,AttachmentMeshIndices[1]=255,AttachmentMeshIndices[2]=255,AttachmentSkinIndices=0,AttachmentSkinIndices[1]=0,AttachmentSkinIndices[2]=0)
}