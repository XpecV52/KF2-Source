/*******************************************************************************
 * KFPlayerReplicationInfo generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFPlayerReplicationInfo extends PlayerReplicationInfo
    native(ReplicationInfo)
    nativereplication
    hidecategories(Navigation,Movement,Collision);

const NUM_COSMETIC_ATTACHMENTS = 3;

struct native CustomizationInfo
{
    var const byte CharacterIndex;
    var const byte HeadMeshIndex;
    var const byte HeadSkinIndex;
    var const byte BodyMeshIndex;
    var const byte BodySkinIndex;
    var const byte AttachmentMeshIndices[3];
    var const byte AttachmentSkinIndices[3];

    structdefaultproperties
    {
        CharacterIndex=0
        HeadMeshIndex=0
        HeadSkinIndex=0
        BodyMeshIndex=0
        BodySkinIndex=0
        AttachmentMeshIndices[0]=255
        AttachmentMeshIndices[1]=255
        AttachmentMeshIndices[2]=255
        AttachmentSkinIndices[0]=0
        AttachmentSkinIndices[1]=0
        AttachmentSkinIndices[2]=0
    }
};

var float LastQuitTime;
var byte NumTimesReconnected;
var repnotify byte VOIPStatus;
var byte NetPerkIndex;
var private byte ActivePerkLevel;
var byte PlayerHealth;
var byte PlayerHealthPercent;
var byte SharedUnlocks;
var const array<KFCharacterInfo_Human> CharacterArchetypes;
var repnotify const CustomizationInfo RepCustomizationInfo;
var Texture CharPortrait;
var class<KFPerk> CurrentPerkClass;
var int Assists;
var bool bExtraFireRange;
var bool bSplashActive;
var bool bNukeActive;
var bool bConcussiveActive;
var bool bPerkCanSupply;
var bool bPerkSupplyUsed;
var bool bObjectivePlayer;

replication
{
     if(bNetDirty)
        ActivePerkLevel, Assists, 
        CharPortrait, CurrentPerkClass, 
        NetPerkIndex, PlayerHealth, 
        PlayerHealthPercent, RepCustomizationInfo, 
        bConcussiveActive, bExtraFireRange, 
        bNukeActive, bObjectivePlayer, 
        bPerkCanSupply, bSplashActive;

     if(bNetDirty && !bNetOwner || bDemoRecording)
        SharedUnlocks, VOIPStatus;
}

simulated event ReplicatedEvent(name VarName)
{
    if(VarName == 'RepCustomizationInfo')
    {
        CharacterCustomizationChanged();        
    }
    else
    {
        if(VarName == 'VOIPStatus')
        {
            VOIPStatusChanged(self, VOIPStatus > 0);            
        }
        else
        {
            if(VarName == 'Score')
            {
                UpdateTraderDosh();
            }
        }
    }
    if(VarName == 'Team')
    {
        ClientRecieveNewTeam();
    }
    super.ReplicatedEvent(VarName);
}

simulated event PostBeginPlay()
{
    super.PostBeginPlay();
}

reliable server function ServerSwitchTeam();

reliable client simulated function ClientRecieveNewTeam();

simulated function byte GetActivePerkLevel()
{
    return ActivePerkLevel;
}

reliable server function ServerNotifyStartVoip()
{
    local int I;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if(!KFGameInfo(WorldInfo.Game).bDisableVOIP && !KFGameInfo(WorldInfo.Game).bDisablePublicVOIPChannel)
    {
        if(!bOnlySpectator)
        {
            bNetDirty = true;
            bForceNetUpdate = true;
            if(!KFPC.IsLocalController())
            {
                VOIPStatusChanged(self, true);
            }
            VOIPStatus = 1;
            KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
            if((KFPC.Pawn != none) && KFPC.Pawn.Health > 0)
            {
                I = 0;
                J0x1AF:

                if(I < WorldInfo.GRI.PRIArray.Length)
                {
                    if(!WorldInfo.GRI.PRIArray[I].bBot)
                    {
                        KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
                        if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
                        {
                            PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
                        }
                    }
                    ++ I;
                    goto J0x1AF;
                }                
            }
            else
            {
                if(KFGameInfo(WorldInfo.Game).bEnableDeadToVOIP)
                {
                    I = 0;
                    J0x3F7:

                    if(I < WorldInfo.GRI.PRIArray.Length)
                    {
                        if(!WorldInfo.GRI.PRIArray[I].bBot)
                        {
                            KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
                            if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
                            {
                                PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
                            }
                        }
                        ++ I;
                        goto J0x3F7;
                    }
                }
            }
            if(KFPC.VoiceReceivers.Length <= 0)
            {
                KFPC.VoiceReceivers.AddItem(UniqueId;
            }            
        }
        else
        {
            ServerStartSpectatorVoiceChat();
        }        
    }
    else
    {
        KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
        KFPC.VoiceReceivers.AddItem(UniqueId;
    }
}

reliable server function ServerNotifyStartTeamVoip()
{
    local byte TeamIndex;
    local int I;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if(!KFGameInfo(WorldInfo.Game).bDisableVOIP)
    {
        TeamIndex = GetTeamNum();
        if(!bOnlySpectator)
        {
            bNetDirty = true;
            bForceNetUpdate = true;
            if(!KFPC.IsLocalController())
            {
                VOIPStatusChanged(self, true);
            }
            VOIPStatus = 2;
            KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
            if((KFPC.Pawn != none) && KFPC.Pawn.Health > 0)
            {
                I = 0;
                J0x17F:

                if(I < WorldInfo.GRI.PRIArray.Length)
                {
                    if(!WorldInfo.GRI.PRIArray[I].bBot && ((WorldInfo.GRI.PRIArray[I].GetTeamNum() == TeamIndex) || !WorldInfo.GRI.bMatchHasBegun) || WorldInfo.GRI.bMatchIsOver)
                    {
                        KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
                        if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
                        {
                            PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
                        }
                    }
                    ++ I;
                    goto J0x17F;
                }                
            }
            else
            {
                if(KFGameInfo(WorldInfo.Game).bEnableDeadToVOIP)
                {
                    I = 0;
                    J0x4A2:

                    if(I < WorldInfo.GRI.PRIArray.Length)
                    {
                        if(!WorldInfo.GRI.PRIArray[I].bBot && ((WorldInfo.GRI.PRIArray[I].GetTeamNum() == TeamIndex) || !WorldInfo.GRI.bMatchHasBegun) || WorldInfo.GRI.bMatchIsOver)
                        {
                            KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
                            if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
                            {
                                PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
                            }
                        }
                        ++ I;
                        goto J0x4A2;
                    }
                }
            }
            if(KFPC.VoiceReceivers.Length <= 0)
            {
                KFPC.VoiceReceivers.AddItem(UniqueId;
            }            
        }
        else
        {
            ServerStartSpectatorVoiceChat();
        }        
    }
    else
    {
        KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
        KFPC.VoiceReceivers.AddItem(UniqueId;
    }
}

function ServerStartSpectatorVoiceChat()
{
    local int I;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    ClearTimer('ClearVOIP');
    KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
    VOIPStatus = ((KFGameInfo(WorldInfo.Game).bPartitionSpectators) ? 6 : 5);
    I = 0;
    J0xCB:

    if(I < WorldInfo.GRI.PRIArray.Length)
    {
        if(!WorldInfo.GRI.PRIArray[I].bBot && (!KFGameInfo(WorldInfo.Game).bPartitionSpectators || WorldInfo.GRI.PRIArray[I].GetTeamNum() >= 2) || WorldInfo.GRI.PRIArray[I].bOnlySpectator)
        {
            KFPC.VoiceReceivers.AddItem(WorldInfo.GRI.PRIArray[I].UniqueId;
            if(PlayerController(WorldInfo.GRI.PRIArray[I].Owner) != none)
            {
                PlayerController(WorldInfo.GRI.PRIArray[I].Owner).VoiceSenders.AddItem(UniqueId;
            }
        }
        ++ I;
        goto J0xCB;
    }
    if(KFPC.VoiceReceivers.Length <= 0)
    {
        KFPC.VoiceReceivers.AddItem(UniqueId;
    }
}

reliable server function ServerNotifyStopVOIP()
{
    local KFPlayerController KFPC;

    VOIPStatus = 0;
    VOIPStatusChanged(self, false);
    KFPC = KFPlayerController(Owner);
    if(KFPC != none)
    {
        KFPC.VoiceReceivers.Remove(0, KFPC.VoiceReceivers.Length;
    }
    foreach WorldInfo.AllControllers(Class'KFPlayerController', KFPC)
    {
        J0xB7:

        if(KFPC.VoiceSenders.Find('Uid', UniqueId.Uid != -1)
        {
            KFPC.VoiceSenders.RemoveItem(UniqueId;
            goto J0xB7;
        }        
    }    
}

simulated function VOIPStatusChanged(PlayerReplicationInfo Talker, bool bIsTalking)
{
    local KFPlayerController KFPC;
    local KFPlayerReplicationInfo TalkerKFPRI;
    local KFGFxHudWrapper MyGFxHUD;

    foreach WorldInfo.LocalPlayerControllers(Class'KFPlayerController', KFPC)
    {
        MyGFxHUD = KFGFxHudWrapper(KFPC.myHUD);
        TalkerKFPRI = KFPlayerReplicationInfo(Talker);
        if(TalkerKFPRI != none)
        {
            if((TalkerKFPRI.VOIPStatus == 6) && !KFPC.PlayerReplicationInfo.bOnlySpectator)
            {                
                return;
            }
        }
        if((MyGFxHUD != none) && MyGFxHUD.HudMovie != none)
        {
            MyGFxHUD.HudMovie.VOIPWidget.VOIPEventTriggered(Talker, bIsTalking);
        }
        if(KFPC.MyGFxManager != none)
        {
            KFPC.MyGFxManager.UpdateVOIP(Talker, bIsTalking);
        }        
    }    
}

reliable client simulated function ShowKickVote(PlayerReplicationInfo PRI, byte VoteDuration, bool bShowChoices)
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.MyGFxHUD != none)
    {
        KFPC.MyGFxHUD.ShowKickVote(PRI, VoteDuration, bShowChoices);
    }
    if(((KFPC != none) && KFPC.MyGFxManager != none) && bShowChoices)
    {
        KFPC.MyGFxManager.ShowKickVote(PRI);
    }
}

reliable client simulated function HideKickVote()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.MyGFxHUD != none)
    {
        KFPC.MyGFxHUD.HideKickVote();
    }
    if((KFPC != none) && KFPC.MyGFxManager != none)
    {
        KFPC.MyGFxManager.HideKickVote();
    }
}

reliable server function ServerStartKickVote(PlayerReplicationInfo Kickee, PlayerReplicationInfo Kicker)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI != none)
    {
        KFGRI.ServerStartVoteKick(Kickee, Kicker);
    }
}

simulated function CastKickVote(PlayerReplicationInfo PRI, bool bKick)
{
    local KFPlayerController KFPC;

    ServerCastKickVote(self, bKick);
    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.MyGFxManager != none)
    {
        KFPC.MyGFxManager.HideKickVote();
    }
}

reliable server function ServerCastKickVote(PlayerReplicationInfo PRI, bool bKick)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI != none)
    {
        KFGRI.RecieveVoteKick(PRI, bKick);
    }
}

simulated function CastMapVote(int MapIndex, bool bDoubleClick)
{
    local KFGameInfo KFGI;

    ServerCastMapVote(self, KFGameReplicationInfo(WorldInfo.GRI).VoteCollector.MapList[MapIndex]);
    if(WorldInfo.NetMode == NM_Standalone)
    {
        KFGI = KFGameInfo(WorldInfo.Game);
        if(KFGI != none)
        {
            KFGI.UpdateCurrentMapVoteTime(((bDoubleClick) ? 0 : 5));
        }
    }
}

reliable server function ServerCastMapVote(PlayerReplicationInfo PRI, string MapName)
{
    local KFGameReplicationInfo KFGRI;
    local KFGameInfo KFGI;

    KFGI = KFGameInfo(WorldInfo.Game);
    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if((KFGI != none) && KFGI.bDisableMapVote)
    {
        return;
    }
    if((KFGRI != none) && !bOnlySpectator)
    {
        KFGRI.ReceiveVoteMap(PRI, KFGI.GameMapCycles[KFGI.ActiveMapCycle].Maps.Find(MapName);
    }
}

reliable client simulated function RecieveAARMapOption(string MapOption)
{
    local KFGameReplicationInfo KFGRI;

    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if((KFGRI != none) && KFGRI.VoteCollector != none)
    {
        KFGRI.VoteCollector.AddMapOption(MapOption);
    }
}

reliable client simulated function RecieveTopMaps(TopVotes VoteObject)
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if(((KFPC != none) && KFPC.MyGFxManager != none) && KFPC.MyGFxManager.PostGameMenu != none)
    {
        KFPC.MyGFxManager.PostGameMenu.RecieveTopMaps(VoteObject);
    }
}

// Export UKFPlayerReplicationInfo::execServerSetSharedUnlocks(FFrame&, void* const)
private reliable server native final event ServerSetSharedUnlocks(byte NewUnlocks);

// Export UKFPlayerReplicationInfo::execServerSetCharacterCustomization(FFrame&, void* const)
private reliable server native final event ServerSetCharacterCustomization(CustomizationInfo NewMeshInfo);

// Export UKFPlayerReplicationInfo::execSaveCharacterConfig(FFrame&, void* const)
private native final function bool SaveCharacterConfig();

// Export UKFPlayerReplicationInfo::execLoadCharacterConfig(FFrame&, void* const)
private native final function bool LoadCharacterConfig(out int CharacterIndex);

// Export UKFPlayerReplicationInfo::execClearCharacterAttachment(FFrame&, void* const)
native function ClearCharacterAttachment(int AttachmentIndex);

simulated function ClientInitialize(Controller C)
{
    if((Role < ROLE_Authority) && C == Owner)
    {
        return;
    }
    SetOwner(C);
    if(C.IsLocalController())
    {
        KFPlayerController(C).InitializeStats();
        SelectCharacter();
        Class'KFUnlockManager'.static.InitSharedUnlocksFor(self);
    }
}

private final simulated event SelectCharacter(optional int CharIndex)
{
    CharIndex = -1;
    LoadCharacterConfig(CharIndex);
    if(!Class'KFUnlockManager'.static.GetAvailable((CharacterArchetypes[CharIndex])))
    {
        CharIndex = GetAnyAvailableCharacter(byte(CharIndex));
        LoadCharacterConfig(CharIndex);
    }
    if(Role < ROLE_Authority)
    {
        ServerSetCharacterCustomization(RepCustomizationInfo);        
    }
    else
    {
        CharacterCustomizationChanged();
    }
}

private final simulated function int GetAnyAvailableCharacter(byte CharIndex)
{
    local byte I;

    I = 0;
    J0x0C:

    if(I < CharacterArchetypes.Length)
    {
        if(Class'KFUnlockManager'.static.GetAvailable((CharacterArchetypes[CharIndex])))
        {
            return I;
        }
        ++ I;
        goto J0x0C;
    }
    return 0;
}

private final simulated event string GetCharacterConfigSection(int Idx)
{
    return PathName(CharacterArchetypes[Idx]);
}

simulated event CharacterCustomizationChanged()
{
    local KFPawn_Human KFP;
    local KFCharacterInfoBase NewCharArch;

    if(WorldInfo.GRI.GameClass.static.AllowAnalyticsLogging())
    {
        WorldInfo.TWLogEvent("character_change", self, string(CharacterArchetypes[RepCustomizationInfo.CharacterIndex].Name));
    }
    foreach WorldInfo.AllPawns(Class'KFPawn_Human', KFP)
    {
        if((KFP.PlayerReplicationInfo == self) || (KFP.DrivenVehicle != none) && KFP.DrivenVehicle.PlayerReplicationInfo == self)
        {
            NewCharArch = CharacterArchetypes[RepCustomizationInfo.CharacterIndex];
            if(NewCharArch != KFP.CharacterArch)
            {
                KFP.SetCharacterArch(NewCharArch);
                continue;
            }
            if(WorldInfo.NetMode != NM_DedicatedServer)
            {
                KFP.CharacterArch.SetCharacterMeshFromArch(KFP, self);
            }
        }        
    }    
}

private reliable server final event ServerAnnounceNewSharedContent()
{
    if((WorldInfo.GRI != none) && WorldInfo.GRI.bMatchHasBegun)
    {
        BroadcastLocalizedMessage(Class'KFLocalMessage_Game', 21, self);
    }
}

function PlayerReplicationInfo Duplicate()
{
    local KFPlayerReplicationInfo NewKFPRI;

    NewKFPRI = KFPlayerReplicationInfo(super.Duplicate());
    NewKFPRI.LastQuitTime = LastQuitTime;
    NewKFPRI.NumTimesReconnected = NumTimesReconnected;
    return NewKFPRI;
}

simulated function SetPlayerReady(bool bReady)
{
    bReadyToPlay = bReady;
    ServerSetPlayerReady(bReady);
}

private reliable server final function ServerSetPlayerReady(bool bReady)
{
    bReadyToPlay = bReady;
}

function AddDosh(int DoshAmount, optional bool bEarned)
{
    Score = float(Max(0, int(Score + float(DoshAmount))));
    if(WorldInfo.NetMode == NM_ListenServer)
    {
        UpdateTraderDosh();
    }
    if(bEarned && DoshAmount > 0)
    {
        if((KFPlayerController(Owner) != none) && KFPlayerController(Owner).MatchStats != none)
        {
            KFPlayerController(Owner).MatchStats.RecordIntStat(1, DoshAmount);
        }
    }
}

simulated function UpdateTraderDosh()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.bClientTraderMenuOpen)
    {
        KFPC.NotifyTraderDoshChanged();
    }
}

simulated event Destroyed()
{
    NotifyHUDofPRIDestroyed();
    super.Destroyed();
}

simulated function NotifyHUDofPRIDestroyed()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(GetALocalPlayerController());
    ServerNotifyStopVOIP();
    if(KFPC != none)
    {
        if(KFPC.MyGFxHUD != none)
        {
            KFPC.MyGFxHUD.NotifyHUDofPRIDestroyed(self);
        }
        if((KFPC != Owner) && KFPC.MyGFxManager != none)
        {
            KFPC.MyGFxManager.RemotePlayerDisconnected(UniqueId);
        }
    }
}

function IncrementDeaths(optional int Amt)
{
    Amt = 1;
    if((WorldInfo.GRI != none) && WorldInfo.GRI.bMatchHasBegun)
    {
        super.IncrementDeaths(Amt);
    }
}

reliable client simulated function MarkSupplierOwnerUsed(KFPlayerReplicationInfo SupplierPRI)
{
    if(SupplierPRI != none)
    {
        SupplierPRI.MarkSupplierUsed();
    }
}

simulated function MarkSupplierUsed()
{
    bPerkSupplyUsed = true;
}

simulated function ResetSupplierUsed()
{
    local array<KFPlayerReplicationInfo> KFPRIArray;
    local int I;

    KFGameReplicationInfo(WorldInfo.GRI).GetKFPRIArray(KFPRIArray);
    I = 0;
    J0x52:

    if(I < KFPRIArray.Length)
    {
        KFPRIArray[I].bPerkSupplyUsed = false;
        ++ I;
        goto J0x52;
    }
}

defaultproperties
{
    CharacterArchetypes(0)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Alberts_archetype'
    CharacterArchetypes(1)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Knight_Archetype'
    CharacterArchetypes(2)=KFCharacterInfo_Human'CHR_Playable_ARCH.chr_briar_archetype'
    CharacterArchetypes(3)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Mark_archetype'
    CharacterArchetypes(4)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_MrFoster_archetype'
    CharacterArchetypes(5)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Jagerhorn_Archetype'
    CharacterArchetypes(6)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Ana_Archetype'
    CharacterArchetypes(7)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Masterson_Archetype'
    CharacterArchetypes(8)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Alan_Archetype'
    CharacterArchetypes(9)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Coleman_archetype'
    CharacterArchetypes(10)=KFCharacterInfo_Human'CHR_Playable_ARCH.chr_DJSkully_archetype'
    CharacterArchetypes(11)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Strasser_Archetype'
    CharacterArchetypes(12)=KFCharacterInfo_Human'CHR_Playable_ARCH.CHR_Tanaka_Archetype'
    RepCustomizationInfo=(CharacterIndex=0,HeadMeshIndex=0,HeadSkinIndex=0,BodyMeshIndex=0,BodySkinIndex=0,AttachmentMeshIndices=255,AttachmentMeshIndices[1]=255,AttachmentMeshIndices[2]=255,AttachmentSkinIndices=0,AttachmentSkinIndices[1]=0,AttachmentSkinIndices[2]=0)
}