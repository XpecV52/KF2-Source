/*******************************************************************************
 * KFGFxMenu_Gear generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxMenu_Gear extends KFGFxObject_Menu within GFxMoviePlayer;

var KFGFxObject_Container CustomizationComponent;
var KFPlayerReplicationInfo MyKFPRI;
var const string HeadMeshKey;
var const string HeadSkinKey;
var const string HeadFunctionKey;
var const string BodyMeshKey;
var const string BodySkinKey;
var const string BodyFunctionKey;
var const string AttachmentKey;
var const string AttachmentSkinKey;
var const string AttachmentFunctionKey;
var const string KFCharacterInfoString;
var KFCharacterInfo_Human CurrentCharInfo;
var string CharInfoPath;
var const localized string GearHeaderString;
var const localized string CharacterString;
var const localized string BioString;
var const localized string HeadString;
var const localized string BodyString;
var const localized string AttachmentsString;
var const localized string SkinsString;
var const localized string BackString;
var const localized string NoneString;
var const int ControllerRotationRate;
var const float ControllerRotationThreshold;
var string ClearImagePath;

function InitializeMenu(KFGFxMoviePlayer_Manager InManager)
{
    super.InitializeMenu(InManager);
    MyKFPRI = KFPlayerReplicationInfo(Outer.GetPC().PlayerReplicationInfo);
    LocalizeText();
    UpdateCharacterList();
    UpdateGear();
}

function OnOpen()
{
    local PlayerController PC;

    PC = Outer.GetPC();
    if(PC == none)
    {
        return;
    }
    Outer.GetGameViewportClient().__HandleInputAxis__Delegate = OnAxisModified;
    if(Class'WorldInfo'.static.IsMenuLevel())
    {
        Manager.ManagerObject.SetBool("backgroundVisible", false);        
    }
    else
    {
        if(PC.PlayerReplicationInfo.bReadyToPlay && PC.WorldInfo.GRI.bMatchHasBegun)
        {
            SetBool("characterButtonEnabled", false);
            Manager.CloseMenus();
        }
    }
}

function LocalizeText()
{
    local GFxObject LocalizedObject;

    LocalizedObject = Outer.CreateObject("Object");
    LocalizedObject.SetString("header", GearHeaderString);
    LocalizedObject.SetString("listButton", BackString);
    LocalizedObject.SetString("bioStringText", BioString);
    LocalizedObject.SetString("charactersString", CharacterString);
    LocalizedObject.SetString("headsString", HeadString);
    LocalizedObject.SetString("bodiesString", BodyString);
    LocalizedObject.SetString("skinsString", SkinsString);
    LocalizedObject.SetString("attachmentsString", AttachmentsString);
    SetObject("localizeText", LocalizedObject);
}

function UpdateCharacterList()
{
    local byte I, ItemIndex;
    local GFxObject DataProvider, SlotObject;
    local string TexturePath;

    ItemIndex = 0;
    DataProvider = Outer.CreateArray();
    I = 0;
    J0x41:

    if(I < MyKFPRI.CharacterArchetypes.Length)
    {
        if(Class'KFUnlockManager'.static.GetAvailable((MyKFPRI.CharacterArchetypes[I])))
        {
            SlotObject = Outer.CreateObject("Object");
            SlotObject.SetInt("ItemIndex", I);
            SlotObject.SetString("label", Localize(string(MyKFPRI.CharacterArchetypes[I].Name), "CharacterName", KFCharacterInfoString));
            TexturePath = "img://" $ PathName(MyKFPRI.CharacterArchetypes[I].DefaultHeadPortrait);
            SlotObject.SetString("source", TexturePath);
            DataProvider.SetElementObject(ItemIndex, SlotObject);
            ++ ItemIndex;            
        }
        else
        {
            LogInternal(string(MyKFPRI.CharacterArchetypes[I]) @ "is not purchased.");
        }
        ++ I;
        goto J0x41;
    }
    SetObject("characterArray", DataProvider);
}

function UpdateGear()
{
    CurrentCharInfo = MyKFPRI.CharacterArchetypes[MyKFPRI.StoredCharIndex];
    CharInfoPath = string(CurrentCharInfo.Name);
    UpdateMeshList(BodyMeshKey, BodySkinKey, CurrentCharInfo.BodyVariants, "bodyArray");
    UpdateMeshList(HeadMeshKey, HeadSkinKey, CurrentCharInfo.HeadVariants, "headsArray");
    UpdateAttachmentsList(AttachmentKey, CurrentCharInfo.CosmeticVariants, "attachmentsArray");
    SetCurrentCharacterButtons();
}

function UpdateMeshList(string OutfitKey, string SkinKey, array<OutfitVariants> Outfits, string DataArrayString)
{
    local byte I, ItemIndex;
    local GFxObject DataProvider, SlotObject;
    local string TexturePath;
    local OutfitVariants Outfit;

    ItemIndex = 0;
    DataProvider = Outer.CreateArray();
    I = 0;
    J0x41:

    if(I < Outfits.Length)
    {
        Outfit = Outfits[I];
        if(Class'KFUnlockManager'.static.GetAvailableOutfit(Outfit))
        {
            SlotObject = Outer.CreateObject("Object");
            SlotObject.SetInt("ItemIndex", I);
            SlotObject.SetString("label", Localize(CharInfoPath, OutfitKey $ string(I), KFCharacterInfoString));
            TexturePath = "img://" $ PathName(Outfit.UITexture);
            SlotObject.SetString("source", TexturePath);
            UpdateVariants(OutfitKey, SkinKey, Outfit.SkinVariations, I, SlotObject);
            DataProvider.SetElementObject(ItemIndex, SlotObject);
            ++ ItemIndex;            
        }
        else
        {
            LogInternal(("Outfit" @ Outfit.MeshName) @ "is not purchased.");
        }
        ++ I;
        goto J0x41;
    }
    SetObject(DataArrayString, DataProvider);
}

function UpdateAttachmentsList(string ItemKey, array<AttachmentVariants> Attachments, string DataArrayString)
{
    local byte I, ItemIndex;
    local GFxObject DataProvider, SlotObject;
    local string TexturePath;
    local AttachmentVariants Variant;

    ItemIndex = 0;
    DataProvider = Outer.CreateArray();
    SlotObject = Outer.CreateObject("Object");
    SlotObject.SetString("label", NoneString);
    SlotObject.SetString("source", "img://" $ ClearImagePath);
    DataProvider.SetElementObject(ItemIndex, SlotObject);
    ++ ItemIndex;
    I = 0;
    J0x11D:

    if(I < Attachments.Length)
    {
        Variant = Attachments[I];
        if(Class'KFUnlockManager'.static.GetAvailableAttachment(Variant))
        {
            SlotObject = Outer.CreateObject("Object");
            SlotObject.SetInt("ItemIndex", I);
            SlotObject.SetString("label", Localize(CharInfoPath, ItemKey $ string(I), KFCharacterInfoString));
            TexturePath = "img://" $ PathName(Variant.UITexture);
            SlotObject.SetString("source", TexturePath);
            UpdateVariants(ItemKey, AttachmentSkinKey, Variant.SkinVariations, I, SlotObject);
            DataProvider.SetElementObject(ItemIndex, SlotObject);
            ++ ItemIndex;            
        }
        else
        {
            LogInternal(("Attachment" @ Variant.MeshName) @ "is not purchased.");
        }
        ++ I;
        goto J0x11D;
    }
    SetObject(DataArrayString, DataProvider);
}

function UpdateVariants(string OutfitKey, string KeyName, out array<SkinVariant> SkinVariations, int OutfitIndex, out GFxObject MeshObject)
{
    local byte I, ItemIndex;
    local GFxObject DataProvider, SlotObject;
    local SkinVariant Skin;
    local string SectionPath, TexturePath;

    ItemIndex = 0;
    DataProvider = Outer.CreateArray();
    SectionPath = ((CharInfoPath $ ".") $ OutfitKey) $ string(OutfitIndex);
    I = 0;
    J0x71:

    if(I < SkinVariations.Length)
    {
        Skin = SkinVariations[I];
        if(Class'KFUnlockManager'.static.GetAvailableSkin(Skin))
        {
            SlotObject = Outer.CreateObject("Object");
            SlotObject.SetInt("ItemIndex", I);
            SlotObject.SetString("label", Localize(SectionPath, KeyName $ string(I), KFCharacterInfoString));
            TexturePath = "img://" $ PathName(Skin.UITexture);
            SlotObject.SetString("source", TexturePath);
            DataProvider.SetElementObject(ItemIndex, SlotObject);
            ++ ItemIndex;            
        }
        else
        {
            LogInternal(("Skin" @ string(Skin.UITexture.Name)) @ "is not purchased.");
        }
        ++ I;
        goto J0x71;
    }
    MeshObject.SetObject("skinInfo", DataProvider);
}

function SetCurrentCharacterButtons()
{
    local GFxObject DataObject;

    DataObject = Outer.CreateObject("Object");
    DataObject.SetString("selectedCharacter", Localize(CharInfoPath, "CharacterName", KFCharacterInfoString));
    DataObject.SetString("characterBio", Localize(CharInfoPath, "Description", KFCharacterInfoString));
    DataObject.SetInt("selectedCharacterIndex", MyKFPRI.StoredCharIndex);
    SetObject("selectedCharacter", DataObject);
    SetGearButtons(MyKFPRI.RepCustomizationInfo.HeadMeshIndex, MyKFPRI.RepCustomizationInfo.HeadSkinIndex, HeadMeshKey, HeadSkinKey, HeadFunctionKey);
    SetGearButtons(MyKFPRI.RepCustomizationInfo.BodyMeshIndex, MyKFPRI.RepCustomizationInfo.BodySkinIndex, BodyMeshKey, BodySkinKey, BodyFunctionKey);
    SetAttachmentButtons(AttachmentKey, AttachmentFunctionKey);
}

function SetGearButtons(byte MeshIndex, byte SkinIndex, string MeshKey, string SkinKey, string sectionFunctionName)
{
    local string SectionPath, CurrentMesh, SkinName, MeshName;
    local GFxObject DataObject;

    DataObject = Outer.CreateObject("Object");
    if(MeshIndex == 255)
    {
        DataObject.SetString(sectionFunctionName, NoneString);        
    }
    else
    {
        CurrentMesh = MeshKey $ string(MeshIndex);
        SectionPath = (CharInfoPath $ ".") $ CurrentMesh;
        SkinName = Localize(SectionPath, SkinKey $ string(SkinIndex), KFCharacterInfoString);
        MeshName = Localize(CharInfoPath, CurrentMesh, KFCharacterInfoString);
        DataObject.SetString(sectionFunctionName, (MeshName @ "
") @ SkinName);
    }
    DataObject.SetInt(sectionFunctionName $ "Index", MeshIndex);
    DataObject.SetInt(sectionFunctionName $ "SkinIndex", SkinIndex);
    SetObject(sectionFunctionName, DataObject);
}

function SetAttachmentButtons(string AttachmentMeshKey, string sectionFunctionName)
{
    local string CurrentMesh, FinishedString;
    local GFxObject DataObject;
    local byte I, AttachmentIndex;

    DataObject = Outer.CreateObject("Object");
    I = 0;
    J0x3F:

    if(I < 3)
    {
        AttachmentIndex = MyKFPRI.RepCustomizationInfo.AttachmentMeshIndices[I];
        if(AttachmentIndex == 255)
        {            
            FinishedString $= ("----" $ "
");            
        }
        else
        {
            CurrentMesh = AttachmentMeshKey $ string(AttachmentIndex);            
            FinishedString $= ((Localize(CharInfoPath, CurrentMesh, KFCharacterInfoString)) $ "
");
        }
        ++ I;
        goto J0x3F;
    }
    DataObject.SetString(sectionFunctionName, FinishedString);
    SetObject(sectionFunctionName, DataObject);
}

event OnClose()
{
    local PlayerController PC;

    super.OnClose();
    Outer.GetGameViewportClient().__HandleInputAxis__Delegate = None;
    if(Class'WorldInfo'.static.IsMenuLevel())
    {
        Manager.ManagerObject.SetBool("backgroundVisible", true);
    }
    PC = Outer.GetPC();
    if((((PC != none) && PC.WorldInfo.GRI.bMatchHasBegun) && PC.Pawn != none) && !PC.Pawn.IsA('KFPawn_Customization'))
    {
        PC.ServerCamera('FirstPerson');
    }
}

event bool OnAxisModified(int ControllerId, name Key, float Delta, float DeltaTime, bool bGamepad)
{
    if(Outer.GetPC().PlayerInput.bUsingGamepad)
    {
        if((Key == 'XboxTypeS_RightX') && Abs(Delta) > ControllerRotationThreshold)
        {
            Callback_RotateCamera(int(Delta * float(ControllerRotationRate)));
        }
    }
    return false;
}

function Callback_RotateCamera(int RotationDirection)
{
    local KFPlayerCamera PlayerCamera;

    PlayerCamera = KFPlayerCamera(Outer.GetPC().PlayerCamera);
    if(PlayerCamera != none)
    {
        PlayerCamera.CustomizationCam.RotatedCamera(RotationDirection);
    }
}

function Callback_EndRotateCamera()
{
    local KFPlayerCamera PlayerCamera;

    PlayerCamera = KFPlayerCamera(Outer.GetPC().PlayerCamera);
    if(PlayerCamera != none)
    {
        PlayerCamera.CustomizationCam.StartFadeRotation();
    }
}

function Callback_BodyCamera()
{
    if(KFPlayerCamera(Outer.GetPC().PlayerCamera) != none)
    {
        KFPlayerCamera(Outer.GetPC().PlayerCamera).CustomizationCam.SetBodyView(0);
    }
}

function Callback_HeadCamera()
{
    if(KFPlayerCamera(Outer.GetPC().PlayerCamera) != none)
    {
        KFPlayerCamera(Outer.GetPC().PlayerCamera).CustomizationCam.SetBodyView(1);
    }
}

function Callback_Character(byte Index)
{
    SetOption(0, Index);
    UpdateGear();
}

function Callback_Head(byte MeshIndex, byte SkinIndex)
{
    SetOption(1, MeshIndex, SkinIndex);
    SetGearButtons(MeshIndex, SkinIndex, HeadMeshKey, HeadSkinKey, HeadFunctionKey);
}

function Callback_Body(byte MeshIndex, byte SkinIndex)
{
    SetOption(2, MeshIndex, SkinIndex);
    SetGearButtons(MeshIndex, SkinIndex, BodyMeshKey, BodySkinKey, BodyFunctionKey);
}

function Callback_Attachment(byte MeshIndex, byte SkinIndex)
{
    SetOption(3, MeshIndex, SkinIndex, 0);
    SetAttachmentButtons(AttachmentKey, AttachmentFunctionKey);
}

function SetOption(KFPawn_Human.ECustomizationOption CustomizationOption, byte PrimaryIndex, optional byte SecondaryIndex, optional byte AttachmentSlot)
{
    local KFPawn_Human KFP;

    if(Outer.GetPC().Pawn != none)
    {
        KFP = KFPawn_Human(Outer.GetPC().Pawn);
        if(KFP != none)
        {
            if((CustomizationOption == 0) && KFPawn_Customization(Outer.GetPC().Pawn) != none)
            {
                KFPawn_Customization(Outer.GetPC().Pawn).UpdateCustomizationCharacter(PrimaryIndex);                
            }
            else
            {
                if(CustomizationOption == 3)
                {
                    KFP.UpdateCustomizationOption(CustomizationOption, PrimaryIndex, SecondaryIndex, AttachmentSlot);                    
                }
                else
                {
                    KFP.UpdateCustomizationOption(CustomizationOption, PrimaryIndex, SecondaryIndex);
                }
            }
        }
    }
}

defaultproperties
{
    HeadMeshKey="HeadMesh"
    HeadSkinKey="HeadSkin"
    HeadFunctionKey="selectedHead"
    BodyMeshKey="BodyMesh"
    BodySkinKey="BodySkin"
    BodyFunctionKey="selectedBody"
    AttachmentKey="Attachment"
    AttachmentSkinKey="AttachmentSkin"
    AttachmentFunctionKey="selectedAttachment"
    KFCharacterInfoString="KFCharacterInfo"
    GearHeaderString="CUSTOMIZE GEAR"
    CharacterString="CHARACTER"
    BioString="BIO"
    HeadString="HEAD"
    BodyString="BODY"
    AttachmentsString="ACCESSORIES"
    SkinsString="SKINS"
    BackString="BACK"
    NoneString="NONE"
    ControllerRotationRate=15
    ControllerRotationThreshold=0.25
    ClearImagePath="CHR_Shared_TEX.NoItem_Selection"
    SubWidgetBindings=/* Array type was not detected. */
}