/*******************************************************************************
 * KFGFxHUD_PlayerStatus generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxHUD_PlayerStatus extends GFxObject within GFxMoviePlayer;

var KFPlayerController MyPC;
var class<KFPerk> LastPerkClass;
var int LastPerkLevel;
var int LastHealth;
var int LastArmor;
var float LastHealerAmmoPct;
var int LastEXPValue;
var const localized string EXPString;

function InitializeHUD()
{
    MyPC = KFPlayerController(Outer.GetPC());
    LocalizeText();
}

function LocalizeText()
{
    SetString("expString", EXPString);
}

function TickHud(float DeltaTime)
{
    UpdatePerk();
    UpdateHealth();
    UpdateArmor();
    UpdateHealer();
}

function ShowActiveIndicators(array<string> IconPathStrings)
{
    local byte I;
    local GFxObject DataProvider, TempObj;

    DataProvider = Outer.CreateArray();
    I = 0;
    J0x35:

    if(I < IconPathStrings.Length)
    {
        TempObj = Outer.CreateObject("Object");
        TempObj.SetString("iconPath", "img://" $ IconPathStrings[I]);
        DataProvider.SetElementObject(I, TempObj);
        ++ I;
        goto J0x35;
    }
    SetObject("activeEffects", DataProvider);
}

function ClearBuffIcons()
{
    local GFxObject DataProvider;

    DataProvider = Outer.CreateArray();
    SetObject("activeEffects", DataProvider);
}

function UpdateHealer()
{
    local float CurrentHealerAmmoPct;
    local KFInventoryManager KFInvManager;

    if((MyPC.Pawn != none) && MyPC.Pawn.IsAliveAndWell())
    {
        KFInvManager = KFInventoryManager(MyPC.Pawn.InvManager);
        if((KFInvManager != none) && KFInvManager.HealerWeapon != none)
        {
            CurrentHealerAmmoPct = FClamp(float(KFInvManager.HealerWeapon.AmmoCount[0]) / float(KFInvManager.HealerWeapon.MagazineCapacity[0]), 0, 1);
        }
    }
    if(LastHealerAmmoPct != CurrentHealerAmmoPct)
    {
        SetInt("playerHealerCharge", int(CurrentHealerAmmoPct * 100));
        LastHealerAmmoPct = CurrentHealerAmmoPct;
    }
}

function UpdatePerk()
{
    local byte CurrentPerkLevel;
    local int CurrentPerkEXP;

    if((MyPC == none) || MyPC.CurrentPerk == none)
    {
        return;
    }
    CurrentPerkLevel = MyPC.GetLevel();
    CurrentPerkEXP = MyPC.GetPerkXP(MyPC.CurrentPerk.Class);
    if((LastPerkClass != MyPC.CurrentPerk.Class) || LastPerkLevel != CurrentPerkLevel)
    {
        SetString("playerPerkIcon", "img://" $ MyPC.CurrentPerk.GetPerkIconPath());
        if(LastPerkLevel != CurrentPerkLevel)
        {
            if((LastPerkClass != none) && LastPerkClass == MyPC.CurrentPerk.Class)
            {
                UpdateXP(CurrentPerkEXP, int(MyPC.GetPerkLevelProgressPercentage(MyPC.CurrentPerk.Class, CurrentPerkEXP)), true, MyPC.CurrentPerk.Class);                
            }
            else
            {
                SetBool("bXPInit", false);
            }
        }
        LastPerkClass = MyPC.CurrentPerk.Class;
        SetInt("playerPerkLevel", CurrentPerkLevel);
        LastPerkLevel = CurrentPerkLevel;
        SetInt("playerPerkXPPercent", int(MyPC.GetPerkLevelProgressPercentage(LastPerkClass)));
        LastEXPValue = CurrentPerkEXP;
    }
}

function UpdateHealth()
{
    local KFPawn_Human MyKFP;

    MyKFP = KFPawn_Human(MyPC.Pawn);
    if(MyKFP == none)
    {
        LastHealth = 0;
        SetInt("playerHealth", LastHealth);        
    }
    else
    {
        if(LastHealth != MyKFP.Health)
        {
            SetInt("playerHealth", MyKFP.Health);
            LastHealth = MyKFP.Health;
        }
    }
}

function UpdateArmor()
{
    local KFPawn_Human MyKFP;

    MyKFP = KFPawn_Human(MyPC.Pawn);
    if(MyKFP == none)
    {
        LastArmor = 0;
        SetInt("playerArmor", LastArmor);        
    }
    else
    {
        if(LastArmor != MyKFP.Armor)
        {
            SetInt("playerArmor", MyKFP.Armor);
            LastArmor = MyKFP.Armor;
        }
    }
}

function UpdateXP(int XPDelta, int XPPercent, bool bLevelUp, class<KFPerk> PerkClass)
{
    local bool bIsCurrentPerk;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Outer.GetPC());
    SetBool("bLevelUp", bLevelUp);
    bIsCurrentPerk = PerkClass == MyPC.CurrentPerk.Class;
    if(bIsCurrentPerk)
    {
        SetInt("playerPerkXPPercent", int(MyPC.GetPerkLevelProgressPercentage(PerkClass)));
    }
    if(!bLevelUp && KFPC.GetPerkLevelFromPerkList(PerkClass) < 25)
    {
        ShowXPBark(XPDelta, "img://" $ PerkClass.static.GetPerkIconPath(), bIsCurrentPerk);
    }
}

function ShowXPBark(int DeltaXP, string IconPath, bool bIsCurrentPerk)
{
    ActionScriptVoid("showXPBark");
}

defaultproperties
{
    EXPString="XP"
}