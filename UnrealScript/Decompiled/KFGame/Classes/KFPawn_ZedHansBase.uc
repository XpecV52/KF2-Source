/*******************************************************************************
 * KFPawn_ZedHansBase generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFPawn_ZedHansBase extends KFPawn_MonsterBoss
    abstract
    config(Game)
    hidecategories(Navigation);

enum EHansNadeType
{
    HNT_None,
    HNT_HEGrenade,
    HNT_NerveGas,
    HNT_Smoke,
    HNT_HEGrenadeBarrage,
    HNT_NerveGasBarrage,
    HNT_SmokeBarrage,
    HNT_MAX
};

struct HansBattlePhaseInfo
{
    var bool bCanFrenzy;
    var bool bSprintingBehavior;
    var float GlobalOffensiveNadePhaseCooldown;
    var bool bCanTossNerveGas;
    var float NerveGasTossPhaseCooldown;
    var bool bCanBarrageNerveGas;
    var float NerveGasBarragePhaseCooldown;
    var bool bCanUseGuns;
    var float GunAttackPhaseCooldown;
    var float GunAttackLengthPhase;
    var bool bCanTossGrenade;
    var float HENadeTossPhaseCooldown;
    var bool bCanBarrageGrenades;
    var float HENadeBarragePhaseCooldown;

    structdefaultproperties
    {
        bCanFrenzy=false
        bSprintingBehavior=true
        GlobalOffensiveNadePhaseCooldown=8
        bCanTossNerveGas=false
        NerveGasTossPhaseCooldown=10
        bCanBarrageNerveGas=false
        NerveGasBarragePhaseCooldown=20
        bCanUseGuns=false
        GunAttackPhaseCooldown=20
        GunAttackLengthPhase=15
        bCanTossGrenade=false
        HENadeTossPhaseCooldown=10
        bCanBarrageGrenades=false
        HENadeBarragePhaseCooldown=20
    }
};

struct HansMinionWaveInfo
{
    var KFAIWaveInfo PhaseOneWave;
    var KFAIWaveInfo PhaseTwoWave;
    var KFAIWaveInfo PhaseThreeWave;

    structdefaultproperties
    {
        PhaseOneWave=none
        PhaseTwoWave=none
        PhaseThreeWave=none
    }
};

var repnotify bool bGunsEquipped;
var bool bHealedThisPhase;
var repnotify bool bInHuntAndHealMode;
var bool bPendingSmokeGrenadeBarrage;
var bool bDoingBarrage;
var array<HansBattlePhaseInfo> BattlePhases;
var repnotify int CurrentBattlePhase;
/** How much to reduce Hans' damage he recieves when he is in hunt and heal mode */
var() float HuntAndHealModeDamageReduction;
var class<KFProj_Grenade> ActiveGrenadeClass;
var const class<KFProj_Grenade> ExplosiveGrenadeClass;
var const class<KFProj_Grenade> NerveGasGrenadeClass;
var const class<KFProj_Grenade> SmokeGrenadeClass;
var name RightHandSocketName;
var name LeftHandSocketName;
var float GrenadeTossSpread;
var int BarrageTossCount;
var float GlobalOffensiveNadeCooldown;
var float LastOffensiveNadeTime;
var float HENadeTossCooldown;
var float LastHENadeTossTime;
var float HENadeBarrageCooldown;
var float LastHENadeBarrageTime;
var float NerveGasTossCooldown;
var float LastNerveGasTossTime;
var float NerveGasBarrageCooldown;
var float LastNerveGasBarrageTime;
var float SmokeTossCooldown;
var float LastSmokeTossTime;
var HansMinionWaveInfo SummonWaves[4];
var int NumMinionsToSpawn;

replication
{
     if(bNetDirty)
        CurrentBattlePhase, bGunsEquipped, 
        bInHuntAndHealMode;
}

simulated event ReplicatedEvent(name VarName)
{
    switch(VarName)
    {
        case 'bInHuntAndHealMode':
            SetHuntAndHealMode(bInHuntAndHealMode);
            break;
        default:
            super(KFPawn_Monster).ReplicatedEvent(VarName);
            break;
    }
}

function PossessedBy(Controller C, bool bVehicleTransition)
{
    local KFAIController_Hans HansAI;

    super.PossessedBy(C, bVehicleTransition);
    HansAI = KFAIController_Hans(C);
    SetPhaseCooldowns(HansAI);
}

function IncrementBattlePhase(KFAIController_Hans HansAI)
{
    ++ CurrentBattlePhase;
    bHealedThisPhase = true;
    SetPhaseCooldowns(HansAI);
}

function SetPhaseCooldowns(KFAIController_Hans HansAI)
{
    GlobalOffensiveNadeCooldown = BattlePhases[CurrentBattlePhase - 1].GlobalOffensiveNadePhaseCooldown;
    HENadeTossCooldown = BattlePhases[CurrentBattlePhase - 1].HENadeTossPhaseCooldown;
    HENadeBarrageCooldown = BattlePhases[CurrentBattlePhase - 1].HENadeBarragePhaseCooldown;
    NerveGasTossCooldown = BattlePhases[CurrentBattlePhase - 1].NerveGasTossPhaseCooldown;
    NerveGasBarrageCooldown = BattlePhases[CurrentBattlePhase - 1].NerveGasBarragePhaseCooldown;
    if(HansAI != none)
    {
        HansAI.ShootingCooldown = BattlePhases[CurrentBattlePhase - 1].GunAttackPhaseCooldown;
        HansAI.MaxGunAttackLength = BattlePhases[CurrentBattlePhase - 1].GunAttackLengthPhase;
    }
}

function AdjustDamage(out int InDamage, out Vector Momentum, Controller InstigatedBy, Vector HitLocation, class<DamageType> DamageType, TraceHitInfo HitInfo, Actor DamageCauser)
{
    if(bInHuntAndHealMode)
    {
        InDamage *= HuntAndHealModeDamageReduction;
    }
    super(KFPawn_Monster).AdjustDamage(InDamage, Momentum, InstigatedBy, HitLocation, DamageType, HitInfo, DamageCauser);
}

function bool CanFrenzyInThisPhase()
{
    return BattlePhases[CurrentBattlePhase - 1].bCanFrenzy;
}

function bool DesireSprintingInThisPhase()
{
    return BattlePhases[CurrentBattlePhase - 1].bSprintingBehavior;
}

function bool ShouldPlaySpecialMeleeAnims()
{
    return CanFrenzyInThisPhase();
}

function bool OffensiveGrenadeCooldownComplete()
{
    if((LastOffensiveNadeTime == float(0)) || (WorldInfo.TimeSeconds - LastOffensiveNadeTime) > GlobalOffensiveNadeCooldown)
    {
        return true;
    }
    return false;
}

function bool CanTossNerveGasInThisPhase()
{
    if((((BattlePhases[CurrentBattlePhase - 1].bCanTossNerveGas && !bInHuntAndHealMode) && (WorldInfo.TimeSeconds - LastNerveGasTossTime) > float(0)) && (WorldInfo.TimeSeconds - LastNerveGasTossTime) > NerveGasTossCooldown) && OffensiveGrenadeCooldownComplete())
    {
        return true;
    }
    return false;
}

function bool CanBarrageNerveGasInThisPhase()
{
    if((((BattlePhases[CurrentBattlePhase - 1].bCanBarrageNerveGas && !bInHuntAndHealMode) && (WorldInfo.TimeSeconds - LastNerveGasBarrageTime) > float(0)) && (WorldInfo.TimeSeconds - LastNerveGasBarrageTime) > NerveGasBarrageCooldown) && OffensiveGrenadeCooldownComplete())
    {
        return true;
    }
    return false;
}

function bool CanUseGunsInThisPhase()
{
    return BattlePhases[CurrentBattlePhase - 1].bCanUseGuns;
}

function bool CanTossGrenadeInThisPhase()
{
    if((((BattlePhases[CurrentBattlePhase - 1].bCanTossGrenade && !bInHuntAndHealMode) && (WorldInfo.TimeSeconds - LastHENadeTossTime) > float(0)) && (WorldInfo.TimeSeconds - LastHENadeTossTime) > HENadeTossCooldown) && OffensiveGrenadeCooldownComplete())
    {
        return true;
    }
    return false;
}

function bool CanGrenadeBarrageInThisPhase()
{
    if((((BattlePhases[CurrentBattlePhase - 1].bCanBarrageGrenades && !bInHuntAndHealMode) && (WorldInfo.TimeSeconds - LastHENadeBarrageTime) > float(0)) && (WorldInfo.TimeSeconds - LastHENadeBarrageTime) > HENadeBarrageCooldown) && OffensiveGrenadeCooldownComplete())
    {
        return true;
    }
    return false;
}

function bool CanSmokeTossInThisPhase()
{
    return (bInHuntAndHealMode && (WorldInfo.TimeSeconds - LastSmokeTossTime) > float(0)) && (WorldInfo.TimeSeconds - LastSmokeTossTime) > SmokeTossCooldown;
}

function bool IsThrowingGrenade()
{
    return false;
}

function bool CacheGrenadeThrowLocation(optional bool bLeftHand)
{
    return false;
}

function SetActiveGrenadeClassGrenade()
{
    ActiveGrenadeClass = ExplosiveGrenadeClass;
}

function SetActiveGrenadeClassSmoke()
{
    ActiveGrenadeClass = SmokeGrenadeClass;
}

function SetActiveGrenadeClassNerveGas()
{
    ActiveGrenadeClass = NerveGasGrenadeClass;
}

function PlayDrawGunsDialog()
{
    if(((Role == ROLE_Authority) && KFGameInfo(WorldInfo.Game) != none) && KFGameInfo(WorldInfo.Game).DialogManager != none)
    {
        KFGameInfo(WorldInfo.Game).DialogManager.PlayHansDrawGunsDialog(self);
    }
}

function PlayGrenadeDialog(bool bBarrage)
{
    switch(ActiveGrenadeClass)
    {
        case ExplosiveGrenadeClass:
            if(((Role == ROLE_Authority) && KFGameInfo(WorldInfo.Game) != none) && KFGameInfo(WorldInfo.Game).DialogManager != none)
            {
                KFGameInfo(WorldInfo.Game).DialogManager.PlayHansNadeDialog(self, bBarrage);
            }
            break;
        case SmokeGrenadeClass:
            if(((Role == ROLE_Authority) && KFGameInfo(WorldInfo.Game) != none) && KFGameInfo(WorldInfo.Game).DialogManager != none)
            {
                KFGameInfo(WorldInfo.Game).DialogManager.PlayHansSmokeDialog(self, bBarrage);
            }
            break;
        case NerveGasGrenadeClass:
            if(((Role == ROLE_Authority) && KFGameInfo(WorldInfo.Game) != none) && KFGameInfo(WorldInfo.Game).DialogManager != none)
            {
                KFGameInfo(WorldInfo.Game).DialogManager.PlayHansGasDialog(self, bBarrage);
            }
            break;
        default:
            break;
    }
}

simulated function SetHuntAndHealMode(bool bOn)
{
    bInHuntAndHealMode = bOn;
    if(Role == ROLE_Authority)
    {
        if(bInHuntAndHealMode)
        {
            SetTimer(0.25, true, 'HuntAndHealBump');            
        }
        else
        {
            ClearTimer('HuntAndHealBump');
            if(((Role == ROLE_Authority) && KFGameInfo(WorldInfo.Game) != none) && KFGameInfo(WorldInfo.Game).DialogManager != none)
            {
                KFGameInfo(WorldInfo.Game).DialogManager.PlayHansBattlePhaseDialog(self, CurrentBattlePhase);
            }
        }
    }
    if(!bOn)
    {
        bHealedThisPhase = false;
    }
}

function HuntAndHealBump()
{
    local KFPawn_Monster KFPM;
    local Vector ClosestPoint;
    local float ClosestDist;

    if(((MyKFAIC == none) || MyKFAIC.Enemy == none) || VSizeSq(Location - MyKFAIC.Enemy.Location) > float(250000))
    {
        return;
    }
    foreach WorldInfo.AllPawns(Class'KFPawn_Monster', KFPM, Location, 300)
    {
        if((KFPM != self) && KFPM.IsAliveAndWell())
        {
            ClosestDist = PointDistToSegment(KFPM.Location, Location, MyKFAIC.Enemy.Location, ClosestPoint);
            if(ClosestDist < ((GetCollisionRadius()) * 1.5))
            {
                MyKFAIC.DoHeavyZedBump(KFPM, Normal(KFPM.Location - Location));
            }
        }        
    }    
}

function bool NeedToTurnEx(Vector targ, optional float Angle)
{
    local Vector LookDir, AimDir;

    Angle = 0.93;
    LookDir = vector(Rotation);
    LookDir.Z = 0;
    LookDir = Normal(LookDir);
    AimDir = targ - Location;
    AimDir.Z = 0;
    AimDir = Normal(AimDir);
    return (LookDir Dot AimDir) < Angle;
}

simulated function ANIMNOTIFY_AoENerveGas();

simulated function ApplyBloodDecals(int HitZoneIndex, Vector HitLocation, Vector HitDirection, name HitZoneName, name HitBoneName, class<KFDamageType> dmgType, bool bIsDismemberingHit, bool bWasObliterated)
{
    if(!bInHuntAndHealMode)
    {
        super(KFPawn_Monster).ApplyBloodDecals(HitZoneIndex, HitLocation, HitDirection, HitZoneName, HitBoneName, dmgType, bIsDismemberingHit, bWasObliterated);
    }
}

simulated function DetachShieldFX();

defaultproperties
{
    BossName="Dr. Hans Volter"
    BossCaptionStrings(0)="Hans is nearly invulnerable during his smoke grenade healing phase. Don't waste your ammo!"
    BossCaptionStrings(1)="Watch his power core: Hans is more aggressive as it changes color."
    BossCaptionStrings(2)="Aim for his emissive power core. It is a vulnerable zone."
    BossCaptionStrings(3)="Gas from Han's grenades clings to you, like Bloat bile. Try to avoid it!"
    BossCaptionStrings(4)="His slashing attacks are too strong to parry. You'll still take full damage."
    BossCaptionStrings(5)="Watch for red grenade warning indicators, which may help you spot where they land."
    BossCaptionStrings(6)="When Hans pulls out his guns, stay out of the line of sight. Obvious, but important!"
    MeleeAttackHelper=KFMeleeHelperAI'Default__KFPawn_ZedHansBase.MeleeHelper'
    begin object name=ThirdPersonHead0 class=SkeletalMeshComponent
        ReplacementPrimitive=none
    object end
    // Reference: SkeletalMeshComponent'Default__KFPawn_ZedHansBase.ThirdPersonHead0'
    ThirdPersonHeadMeshComponent=ThirdPersonHead0
    AfflictionHandler=KFPawnAfflictions'Default__KFPawn_ZedHansBase.Afflictions'
    begin object name=FirstPersonArms class=KFSkeletalMeshComponent
        ReplacementPrimitive=none
    object end
    // Reference: KFSkeletalMeshComponent'Default__KFPawn_ZedHansBase.FirstPersonArms'
    ArmsMesh=FirstPersonArms
    SpecialMoveHandler=KFSpecialMoveHandler'Default__KFPawn_ZedHansBase.SpecialMoveHandler'
    AmbientAkComponent=AkComponent'Default__KFPawn_ZedHansBase.AmbientAkSoundComponent_1'
    WeaponAkComponent=AkComponent'Default__KFPawn_ZedHansBase.AmbientAkSoundComponent'
    WeaponAmbientEchoHandler=KFWeaponAmbientEchoHandler'Default__KFPawn_ZedHansBase.WeaponAmbientEchoHandler'
    FootstepAkComponent=AkComponent'Default__KFPawn_ZedHansBase.FootstepAkSoundComponent'
    DialogAkComponent=AkComponent'Default__KFPawn_ZedHansBase.DialogAkSoundComponent'
    begin object name=KFPawnSkeletalMeshComponent class=KFSkeletalMeshComponent
        ReplacementPrimitive=none
    object end
    // Reference: KFSkeletalMeshComponent'Default__KFPawn_ZedHansBase.KFPawnSkeletalMeshComponent'
    Mesh=KFPawnSkeletalMeshComponent
    begin object name=CollisionCylinder class=CylinderComponent
        ReplacementPrimitive=none
    object end
    // Reference: CylinderComponent'Default__KFPawn_ZedHansBase.CollisionCylinder'
    CylinderComponent=CollisionCylinder
    begin object name=Sprite class=SpriteComponent
        ReplacementPrimitive=none
    object end
    // Reference: SpriteComponent'Default__KFPawn_ZedHansBase.Sprite'
    Components(0)=Sprite
    begin object name=CollisionCylinder class=CylinderComponent
        ReplacementPrimitive=none
    object end
    // Reference: CylinderComponent'Default__KFPawn_ZedHansBase.CollisionCylinder'
    Components(1)=CollisionCylinder
    begin object name=Arrow class=ArrowComponent
        ReplacementPrimitive=none
    object end
    // Reference: ArrowComponent'Default__KFPawn_ZedHansBase.Arrow'
    Components(2)=Arrow
    begin object name=KFPawnSkeletalMeshComponent class=KFSkeletalMeshComponent
        ReplacementPrimitive=none
    object end
    // Reference: KFSkeletalMeshComponent'Default__KFPawn_ZedHansBase.KFPawnSkeletalMeshComponent'
    Components(3)=KFPawnSkeletalMeshComponent
    Components(4)=AkComponent'Default__KFPawn_ZedHansBase.AmbientAkSoundComponent'
    Components(5)=AkComponent'Default__KFPawn_ZedHansBase.AmbientAkSoundComponent_1'
    Components(6)=AkComponent'Default__KFPawn_ZedHansBase.FootstepAkSoundComponent'
    Components(7)=AkComponent'Default__KFPawn_ZedHansBase.DialogAkSoundComponent'
    begin object name=CollisionCylinder class=CylinderComponent
        ReplacementPrimitive=none
    object end
    // Reference: CylinderComponent'Default__KFPawn_ZedHansBase.CollisionCylinder'
    CollisionComponent=CollisionCylinder
}