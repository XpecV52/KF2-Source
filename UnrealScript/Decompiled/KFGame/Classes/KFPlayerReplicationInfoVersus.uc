/*******************************************************************************
 * KFPlayerReplicationInfoVersus generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFPlayerReplicationInfoVersus extends KFPlayerReplicationInfo
    native(ReplicationInfo)
    nativereplication
    hidecategories(Navigation,Movement,Collision);

var PlayerController PlayerOwner;
var private Vector PawnLocationCompressed;
var private Vector LastReplicatedSmoothedLocation;

replication
{
     if(!bNetOwner && bNetDirty)
        PawnLocationCompressed;
}

simulated event PostBeginPlay()
{
    super.PostBeginPlay();
    if(Role == ROLE_Authority)
    {
        PlayerOwner = PlayerController(Owner);
    }
}

simulated function Pawn GetOwnerPawn()
{
    local Pawn aPawn;

    foreach WorldInfo.AllPawns(Class'Pawn', aPawn)
    {
        if(aPawn.PlayerReplicationInfo == self)
        {            
            return aPawn;
        }        
    }    
    return none;
}

function SetPlayerTeam(TeamInfo NewTeam)
{
    super(PlayerReplicationInfo).SetPlayerTeam(NewTeam);
    if(NewTeam == none)
    {
        return;
    }
    PlayerOwner = PlayerController(Owner);
    SetTimer(1, true, 'UpdateReplicatedVariables');
}

reliable server function ServerSwitchTeam()
{
    local KFGameInfo MyGameInfo;
    local KFGameReplicationInfo KFGRI;

    MyGameInfo = KFGameInfo(WorldInfo.Game);
    if(MyGameInfo == none)
    {
        return;
    }
    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if((KFGRI == none) || !KFGRI.bAllowSwitchTeam)
    {
        return;
    }
    if(KFGRI.bMatchHasBegun)
    {
        if(!WillMaintainTeamBalance())
        {
            ClientRefusedTeamSwitch();
            return;
        }
        PlayerController(Owner).Pawn.Suicide();
    }
    switch(GetTeamNum())
    {
        case byte(MyGameInfo.Teams[0].TeamIndex):
            MyGameInfo.SetTeam(PlayerController(Owner), MyGameInfo.Teams[1]);
            break;
        case byte(MyGameInfo.Teams[1].TeamIndex):
            MyGameInfo.SetTeam(PlayerController(Owner), MyGameInfo.Teams[0]);
            break;
        default:
            LogInternal("Function: KFPlayerReplicationInfo::ServerSwitchTeam Team index not accounted for - " @ string(GetTeamNum()));
            break;
    }
    if(PlayerController(Owner).IsLocalController() && Role == ROLE_Authority)
    {
        ClientRecieveNewTeam();
    }
}

function bool WillMaintainTeamBalance()
{
    local KFGameInfo MyGameInfo;
    local KFGameReplicationInfo KFGRI;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    MyGameInfo = KFGameInfo(WorldInfo.Game);
    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI.bMatchHasBegun)
    {
        if((KFPC.Pawn == none) && GetTeamNum() == 0)
        {
            return false;
        }
        switch(GetTeamNum())
        {
            case byte(MyGameInfo.Teams[0].TeamIndex):
                return (MyGameInfo.Teams[1].Size < MyGameInfo.Teams[0].Size) && MyGameInfo.Teams[1].Size < (MyGameInfo.MaxPlayersAllowed / 2);
            case byte(MyGameInfo.Teams[1].TeamIndex):
                return (MyGameInfo.Teams[0].Size < MyGameInfo.Teams[1].Size) && MyGameInfo.Teams[0].Size < (MyGameInfo.MaxPlayersAllowed / 2);
            default:
                LogInternal("Function: KFPlayerReplicationInfo::WillUpsetTeamBalance Team index not accounted for - " @ string(GetTeamNum()));
                break;
            }
    }
    return true;
}

reliable client simulated function ClientRefusedTeamSwitch()
{
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.IsLocalController())
    {
        if((KFPC.MyGFxManager != none) && KFPC.MyGFxManager.bMenusOpen)
        {
            KFPC.MyGFxManager.OpenPopup(2, Class'KFCommon_LocalizedStrings'.default.UnableToSwitchTeamString, Class'KFCommon_LocalizedStrings'.default.NoSwitchReasonString, Class'KFCommon_LocalizedStrings'.default.OKString);            
        }
        else
        {
            if(KFPC.MyGFxHUD != none)
            {
                KFPC.MyGFxHUD.ShowNonCriticalMessage(Class'KFCommon_LocalizedStrings'.default.NoSwitchReasonString);
            }
        }
    }
}

reliable client simulated function ClientRecieveNewTeam()
{
    local KFGameReplicationInfo KFGRI;
    local KFGFxHudWrapper MyGFxHUD;
    local KFPlayerController KFPC;

    KFPC = KFPlayerController(Owner);
    if((KFPC != none) && KFPC.IsLocalController())
    {
        MyGFxHUD = KFGFxHudWrapper(KFPC.myHUD);
        KFPC.ClientRecieveNewTeam();        
    }
    else
    {
        return;
    }
    KFGRI = KFGameReplicationInfo(WorldInfo.GRI);
    if(KFGRI.bMatchHasBegun)
    {
        MyGFxHUD.CreateHUDMovie();
    }
}

function UpdateReplicatedVariables()
{
    if((((!bIsSpectator && PlayerOwner != none) && PlayerOwner.GetTeamNum() == 0) && PlayerOwner.Pawn != none) && PlayerOwner.Pawn.IsAliveAndWell())
    {
        UpdatePawnLocation();        
    }
    else
    {
        if(!IsZero(PawnLocationCompressed))
        {
            PawnLocationCompressed = vect(0, 0, 0);
        }
    }
    UpdateReplicatedPlayerHealth();
}

function UpdatePawnLocation()
{
    PawnLocationCompressed = PlayerOwner.Pawn.Location;
    PawnLocationCompressed *= 0.01;
}

function UpdateReplicatedPlayerHealth()
{
    local Pawn OwnerPawn;

    if(PlayerOwner != none)
    {
        OwnerPawn = PlayerOwner.Pawn;
        if((OwnerPawn != none) && OwnerPawn.Health != PlayerHealth)
        {
            PlayerHealth = byte(OwnerPawn.Health);
            PlayerHealthPercent = FloatToByte(float(OwnerPawn.Health) / float(OwnerPawn.HealthMax));
        }
    }
}

function IncrementDeaths(optional int Amt)
{
    Amt = 1;
    super.IncrementDeaths(Amt);
    PawnLocationCompressed = vect(0, 0, 0);
}

simulated function Vector GetReplicatedPawnIconLocation(float BlendSpeed)
{
    local Vector UncompressedLocation;

    UncompressedLocation = PawnLocationCompressed * 100;
    if(((BlendSpeed > float(0)) && !IsZero(UncompressedLocation)) && VSizeSq(UncompressedLocation - LastReplicatedSmoothedLocation) < Square(500))
    {
        LastReplicatedSmoothedLocation = VInterpTo(LastReplicatedSmoothedLocation, UncompressedLocation, WorldInfo.DeltaSeconds, VSize(UncompressedLocation - LastReplicatedSmoothedLocation) * BlendSpeed);        
    }
    else
    {
        LastReplicatedSmoothedLocation = UncompressedLocation;
    }
    return LastReplicatedSmoothedLocation;
}

simulated function VOIPStatusChanged(PlayerReplicationInfo Talker, bool bIsTalking)
{
    if(Talker.GetTeamNum() != GetTeamNum())
    {
        return;
    }
    super.VOIPStatusChanged(Talker, bIsTalking);
}
