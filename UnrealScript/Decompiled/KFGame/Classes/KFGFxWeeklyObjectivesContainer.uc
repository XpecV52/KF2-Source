/*******************************************************************************
 * KFGFxWeeklyObjectivesContainer generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxWeeklyObjectivesContainer extends KFGFxObject_Container within GFxMoviePlayer;

var bool bInitialDataPopulated;
var bool bLastWeeklyComplete;
var KFPlayerController KFPC;

function Initialize(KFGFxObject_Menu NewParentMenu)
{
    super.Initialize(NewParentMenu);
    KFPC = KFPlayerController(Outer.GetPC());
    if(KFPC != none)
    {
        LocalizeMenu();
        PopulateData();
    }
}

function bool PopulateData()
{
    local GFxObject DataObject;
    local KFWeeklyOutbreakInformation WeeklyInfo;
    local bool bWeeklyComplete;
    local int WeeklyIndex;

    bWeeklyComplete = KFPC.IsWeeklyEventComplete();
    WeeklyIndex = -1;
    if((bWeeklyComplete != bLastWeeklyComplete) || !bInitialDataPopulated)
    {
        if(KFPC.WorldInfo.NetMode == NM_Client)
        {
            if((KFPC != none) && KFGameReplicationInfo(KFPC.WorldInfo.GRI) != none)
            {
                WeeklyIndex = KFGameReplicationInfo(KFPC.WorldInfo.GRI).CurrentWeeklyIndex;
                WeeklyInfo = Class'KFMission_LocalizedStrings'.static.GetWeeklyOutbreakInfoByIndex(WeeklyIndex);                
            }
            else
            {
                Outer.GetPC().SetTimer(0.5, false, 'PopulateData');
            }            
        }
        else
        {
            WeeklyInfo = Class'KFMission_LocalizedStrings'.static.GetCurrentWeeklyOutbreakInfo();
        }
        DataObject = Outer.CreateObject("Object");
        if(WeeklyInfo == none)
        {
            return false;
        }
        DataObject.SetString("label", WeeklyInfo.FriendlyName);
        if(WeeklyInfo.ModifierDescriptions.Length > 0)
        {
            LogInternal("SETTING DESCRIPTION: " $ WeeklyInfo.DescriptionStrings[0]);
            DataObject.SetString("description", WeeklyInfo.DescriptionStrings[0]);
        }
        DataObject.SetString("iconPath", "img://" $ WeeklyInfo.IconPath);
        DataObject.SetBool("complete", bWeeklyComplete);
        DataObject.SetBool("showProgres", false);
        DataObject.SetFloat("progress", 0);
        DataObject.SetString("textValue", "");
        SetObject("weeklyObjectiveData", DataObject);
        if(WeeklyInfo.ModifierDescriptions.Length > 0)
        {
            SetString("weeklyDescription", WeeklyInfo.ModifierDescriptions[0]);
        }
        PopulateModifiers(WeeklyInfo);
        PopulateRewards(WeeklyInfo, WeeklyIndex);
        bLastWeeklyComplete = bWeeklyComplete;
        bInitialDataPopulated = true;
        return true;
    }
    return false;
}

function PopulateModifiers(KFWeeklyOutbreakInformation WeeklyInfo)
{
    local int I;
    local GFxObject DataObject, DataProvider;

    if((WeeklyInfo == none) || (Outer.GetPC().WorldInfo.NetMode == NM_Client) && KFPC.WorldInfo.GRI == none)
    {
        return;
    }
    DataProvider = Outer.CreateArray();
    I = 0;
    J0xD6:

    if(I < WeeklyInfo.ModifierDescriptions.Length)
    {
        DataObject = Outer.CreateObject("Object");
        DataObject.SetString("label", "");
        DataObject.SetString("description", WeeklyInfo.ModifierDescriptions[I]);
        DataProvider.SetElementObject(I, DataObject);
        ++ I;
        goto J0xD6;
    }
    SetObject("modifiers", DataProvider);
}

function PopulateRewards(KFWeeklyOutbreakInformation WeeklyInfo, int WeeklyIndex)
{
    local int I, ItemCount;
    local GFxObject DataProvider, GfxRewardItem;

    if(WeeklyInfo == none)
    {
        return;
    }
    ItemCount = 0;
    DataProvider = Outer.CreateArray();
    WeeklyInfo.RewardIDs = Class'KFOnlineStatsWrite'.static.GetWeeklyOutbreakRewards(WeeklyIndex);
    I = 0;
    J0x97:

    if(I < WeeklyInfo.RewardIDs.Length)
    {
        GfxRewardItem = CreateRewardItem(WeeklyInfo, WeeklyInfo.RewardIDs[I]);
        if(GfxRewardItem != none)
        {
            DataProvider.SetElementObject(ItemCount, GfxRewardItem);
            ++ ItemCount;
        }
        ++ I;
        goto J0x97;
    }
    SetObject("rewards", DataProvider);
    UpdateDoshVaultRewardValue();
}

function UpdateDoshVaultRewardValue()
{
    SetInt("vaultDoshReward", Class'KFOnlineStatsWrite'.static.GetWeeklyEventReward());
}

function GFxObject CreateRewardItem(KFWeeklyOutbreakInformation WeeklyInfo, int ItemId)
{
    local GFxObject DataObject;
    local int ItemIndex;
    local ItemProperties RewardItem;
    local OnlineSubsystem OnlineSub;

    OnlineSub = Class'GameEngine'.static.GetOnlineSubsystem();
    if(OnlineSub == none)
    {
        return none;
    }
    ItemIndex = OnlineSub.ItemPropertiesList.Find('Definition', ItemId;
    if(ItemIndex == -1)
    {
        LogInternal("ItemID not found: " @ string(ItemId));
        return none;
    }
    RewardItem = OnlineSub.ItemPropertiesList[ItemIndex];
    DataObject = Outer.CreateObject("Object");
    DataObject.SetString("label", RewardItem.Name);
    DataObject.SetString("iconPath", "img://" $ RewardItem.IconURL);
    return DataObject;
}

function LocalizeMenu()
{
    local GFxObject TextObject;

    TextObject = Outer.CreateObject("Object");
    TextObject.SetString("currentModifier", Class'KFMission_LocalizedStrings'.default.CurrentWeeklySettingsString);
    TextObject.SetString("reward", Class'KFMission_LocalizedStrings'.default.RewardsString);
    TextObject.SetString("granted", Class'KFMission_LocalizedStrings'.default.GrantedWeeklyString);
    TextObject.SetString("weekly", Class'KFMission_LocalizedStrings'.default.WeeklyString);
    TextObject.SetString("overview", Class'KFMission_LocalizedStrings'.default.WeeklyOverview);
    TextObject.SetString("vaultDosh", Class'KFMission_LocalizedStrings'.default.VaultDoshString);
    SetObject("localizedText", TextObject);
}
