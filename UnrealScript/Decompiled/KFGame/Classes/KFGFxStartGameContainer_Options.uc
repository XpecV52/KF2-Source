/*******************************************************************************
 * KFGFxStartGameContainer_Options generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFGFxStartGameContainer_Options extends KFGFxObject_Container within GFxMoviePlayer
    native(UI)
    config(UI);

enum EServerType
{
    ES_Maps,
    ES_Stock,
    ES_Custom,
    ES_Unranked,
    ES_MAX
};

enum EInProgess
{
    EIP_Allow_In_Progress,
    EIP_Not_Started,
    EIP_MAX
};

var int ModeFilter;
var int DifficultyFilter;
var int LengthFilter;
var int ServerTypeFilter;
var int InProgressFilter;
var int PermissionsFilter;
var bool bModeFilterSet;
var bool bLengthFilterSet;
var bool bServerTypeFilterSet;
var bool bInProgressFilterSet;
var bool bPermissionsFilterSet;
var bool bIsSoloGame;
var byte InitialMapIndex;
var config byte SavedSoloModeIndex;
var config byte SavedSoloDifficultyIndex;
var config byte SavedSoloLengthIndex;
var config byte SavedModeIndex;
var config byte SavedDifficultyIndex;
var config byte SavedLengthIndex;
var config byte SavedPrivacyIndex;
var config byte SavedServerTypeIndex;
var config byte SavedInProgressIndex;
var config string SavedSoloMapString;
var config string SavedMapString;
var KFGFxMenu_StartGame StartMenu;
var const localized string BackString;
var const localized string StartGameString;
var const localized string LaunchGameString;
var const localized string ServerTypeString;
var const localized string InProgressString;
var const localized string SoloGameString;
var const localized string LeaveMatchMakingString;
var const localized string MultiplayerLaunchString;
var const localized string SearchingString;
var const localized string CancelSearchingString;
var const localized string StandardServerString;
var const localized string UnrankedServerString;
var const localized string CustomServerString;
var const localized string AllowInProgressString;
var const localized string NotStartedString;
var array<string> ServerTypeStrings;
var array<string> InProgessOptionStrings;
var const localized array<localized string> GameTypes;
var string PreviousMapName;

function Initialize(KFGFxObject_Menu NewParentMenu)
{
    super.Initialize(NewParentMenu);
    ClampSavedFiltersToMode();
    StartMenu = KFGFxMenu_StartGame(NewParentMenu);
    InitializeGameOptions();
    LocalizeArrays();
    SetOptions();
}

function ClampSavedFiltersToMode()
{
    SavedDifficultyIndex = byte(Clamp(SavedDifficultyIndex, 0, Class'KFGameInfo'.default.GameModes[SavedModeIndex].DifficultyLevels));
    if(SavedLengthIndex >= Class'KFGameInfo'.default.GameModes[SavedModeIndex].Lengths)
    {
        SavedLengthIndex = 0;
    }
}

function SetHelpText(string TextValue)
{
    SetString("helpText", TextValue);
}

function SetModeMenus(GFxObject TextObject, int ModeIndex)
{
    local int DifficultyLevels, Lengths;
    local byte NewDifficultyIndex, NewLengthIndex;

    DifficultyLevels = Class'KFGameInfo'.default.GameModes[ModeIndex].DifficultyLevels;
    Lengths = Class'KFGameInfo'.default.GameModes[ModeIndex].Lengths;
    NewDifficultyIndex = byte(Clamp(NewDifficultyIndex, 0, DifficultyLevels));
    NewLengthIndex = byte(Clamp(NewLengthIndex, 0, Lengths));
    TextObject.SetObject("difficultyList", CreateList(Class'KFCommon_LocalizedStrings'.static.GetDifficultyStringsArray(), ((bIsSoloGame) ? SavedSoloDifficultyIndex : SavedDifficultyIndex), false, false, byte(DifficultyLevels)));
    TextObject.SetObject("lengthList", CreateList(Class'KFCommon_LocalizedStrings'.static.GetLengthStringsArray(), ((bIsSoloGame) ? SavedSoloLengthIndex : SavedLengthIndex), true, false, byte(Lengths)));
}

function InitializeGameOptions()
{
    local GFxObject TextObject;
    local array<string> SupportedGameModeStrings;
    local int I;

    bIsSoloGame = GetBool("bIsSoloGame");
    InitialMapIndex = byte(StartMenu.MapStringList.Find(((bIsSoloGame) ? SavedSoloMapString : SavedMapString));
    if((InitialMapIndex == 255) || InitialMapIndex == -1)
    {
        if(bIsSoloGame)
        {
            InitialMapIndex = 0;            
        }
        else
        {
            InitialMapIndex = byte(StartMenu.MapStringList.Length);
        }
    }
    TextObject = Outer.CreateObject("Object");
    TextObject.SetString("soloGameString", SoloGameString);
    TextObject.SetString("matchMakingString", StartMenu.MatchmakingString);
    TextObject.SetString("leaveMatchmakingString", LeaveMatchMakingString);
    TextObject.SetString("backString", BackString);
    TextObject.SetString("lauchGameString", LaunchGameString);
    TextObject.SetString("multiplayerLaunchString", MultiplayerLaunchString);
    TextObject.SetString("searchingString", CancelSearchingString);
    TextObject.SetString("mode", StartMenu.GameModeTitle);
    TextObject.SetString("map", StartMenu.MapTitle);
    TextObject.SetString("difficulty", StartMenu.DifficultyTitle);
    TextObject.SetString("length", StartMenu.LengthTitle);
    TextObject.SetString("privacy", StartMenu.PermissionsTitle);
    TextObject.SetString("serverType", ServerTypeString);
    TextObject.SetString("inProgress", InProgressString);
    SupportedGameModeStrings = Class'KFCommon_LocalizedStrings'.static.GetGameModeStringsArray();
    if(bIsSoloGame)
    {
        I = 0;
        J0x4D5:

        if(I < SupportedGameModeStrings.Length)
        {
            if(!Class'KFGameInfo'.static.IsGameModeSoloPlayAllowed(I))
            {
                SupportedGameModeStrings.Remove(I, 1;
                -- I;
            }
            ++ I;
            goto J0x4D5;
        }
    }
    TextObject.SetObject("modeList", CreateList(SupportedGameModeStrings, byte(Min(((bIsSoloGame) ? SavedSoloModeIndex : SavedModeIndex), SupportedGameModeStrings.Length)), true));
    SetModeMenus(TextObject, Min(SavedModeIndex, SupportedGameModeStrings.Length));
    TextObject.SetObject("mapList", CreateList(StartMenu.MapStringList, InitialMapIndex, true, true));
    TextObject.SetObject("serverTypeList", CreateList(ServerTypeStrings, SavedServerTypeIndex, true));
    TextObject.SetObject("inProgressList", CreateList(InProgessOptionStrings, SavedInProgressIndex, false));
    TextObject.SetObject("privacyList", CreateList(Class'KFCommon_LocalizedStrings'.static.GetPermissionStringsArray(), SavedPrivacyIndex, false));
    SetInt("currentSelectedMapIndex", InitialMapIndex);
    SetObject("localizedText", TextObject);
}

function LocalizeArrays()
{
    ServerTypeStrings[1] = Localize("KFGFxStartGameContainer_Options", "StandardServerString", "KFGame");
    ServerTypeStrings[2] = Localize("KFGFxStartGameContainer_Options", "CustomServerString", "KFGame");
    ServerTypeStrings[3] = Localize("KFGFxStartGameContainer_Options", "UnrankedServerString", "KFGame");
    ServerTypeStrings[0] = Localize("KFGFxStartGameContainer_Options", "AnyMapServerString", "KFGame");
    InProgessOptionStrings[0] = Localize("KFGFxStartGameContainer_Options", "AllowInProgressString", "KFGame");
    InProgessOptionStrings[1] = Localize("KFGFxStartGameContainer_Options", "NotStartedString", "KFGame");
}

function GFxObject CreateList(array<string> TextArray, byte SelectedIndex, bool bAddNoPrefString, optional bool bIsMapList, optional byte MaxLength)
{
    local byte I;
    local GFxObject OptionList, DataProvider, ItemSlot;
    local string TempString;
    local byte ArrayLen;

    OptionList = Outer.CreateObject("Object");
    DataProvider = Outer.CreateArray();
    if(MaxLength > 0)
    {
        ArrayLen = byte(Min(MaxLength, TextArray.Length));        
    }
    else
    {
        ArrayLen = byte(TextArray.Length);
    }
    I = 0;
    J0xBA:

    if(I < ArrayLen)
    {
        ItemSlot = Outer.CreateObject("Object");
        TempString = ((bIsMapList) ? StartMenu.GetFriendlyMapName(TextArray[I]) : TextArray[I]);
        ItemSlot.SetString("label", TempString);
        DataProvider.SetElementObject(I, ItemSlot);
        ++ I;
        goto J0xBA;
    }
    if(bAddNoPrefString && !GetBool("bIsSoloGame"))
    {
        ItemSlot = Outer.CreateObject("Object");
        TempString = Class'KFCommon_LocalizedStrings'.default.NoPreferenceString;
        ItemSlot.SetString("label", TempString);
        DataProvider.SetElementObject(I, ItemSlot);
    }
    OptionList.SetInt("selectedIndex", SelectedIndex);
    OptionList.SetObject("dataProvider", DataProvider);
    OptionList.ActionScriptVoid("invalidateData");
    return OptionList;
}

function SetOptions()
{
    if(((SavedMapString == "") || InitialMapIndex >= StartMenu.MapStringList.Length) && !bIsSoloGame)
    {
        MapChanged("", false);        
    }
    else
    {
        if(InitialMapIndex == 255)
        {
            InitialMapIndex = 0;
        }
        MapChanged(StartMenu.MapStringList[InitialMapIndex], false);
    }
    InProgressChanged(SavedInProgressIndex);
    PrivacyChanged(SavedPrivacyIndex);
}

function SetSearching(bool bSearching)
{
    SetBool("bSearchingForGame", bSearching);
    InProgressChanged(SavedInProgressIndex);
    PrivacyChanged(SavedPrivacyIndex);
    if(bSearching)
    {
        SetHelpText(SearchingString);        
    }
    else
    {
        SetHelpText("");
    }
}

function ModeChanged(int Index)
{
    if(bIsSoloGame)
    {
        SavedSoloModeIndex = byte(Index);        
    }
    else
    {
        SavedModeIndex = byte(Index);
    }
    ClampSavedFiltersToMode();
    InitializeGameOptions();
    SaveConfig();
}

function LengthChanged(int Index)
{
    if(bIsSoloGame)
    {
        SavedSoloLengthIndex = byte(Index);        
    }
    else
    {
        SavedLengthIndex = byte(Index);
    }
    SaveConfig();
}

function DifficultyChanged(int Index)
{
    if(bIsSoloGame)
    {
        SavedSoloDifficultyIndex = byte(Index);        
    }
    else
    {
        SavedDifficultyIndex = byte(Index);
    }
    SaveConfig();
}

function MapChanged(string MapName, optional bool bSave)
{
    bSave = true;
    if(bIsSoloGame)
    {
        SavedSoloMapString = MapName;        
    }
    else
    {
        SavedMapString = MapName;
    }
    UpdateMapSource(MapName);
    if(bSave)
    {
        SaveConfig();
    }
}

function UpdateMapSource(string MapName)
{
    if((PreviousMapName == "") || PreviousMapName != MapName)
    {
        SetString("mapSource", StartMenu.GetMapSource(MapName));
        PreviousMapName = MapName;
    }
}

function PrivacyChanged(int Index)
{
    SavedPrivacyIndex = byte(Index);
    SaveConfig();
    SetBool("bPublicGame", (GetPartyPrivacy() == 0) || GetPartyPrivacy() == 1);
}

function ServerTypeChanged(int Index)
{
    SavedServerTypeIndex = byte(Index);
    SaveConfig();
}

function InProgressChanged(int Index)
{
    SavedInProgressIndex = byte(Index);
    SaveConfig();
    SetBool("bAllowGameInProgress", SavedInProgressIndex == 0);
}

function UpdateFilters()
{
    local GFxObject DataObject;

    DataObject = GetObject("options");
    ModeFilter = DataObject.GetInt("mode");
    bModeFilterSet = ModeFilter < Class'KFCommon_LocalizedStrings'.static.GetGameModeStringsArray().Length;
    DifficultyFilter = DataObject.GetInt("difficulty");
    if(DifficultyFilter >= Class'KFCommon_LocalizedStrings'.static.GetDifficultyStringsArray().Length)
    {
        DifficultyFilter = 0;
    }
    LengthFilter = DataObject.GetInt("length");
    bLengthFilterSet = LengthFilter < Class'KFCommon_LocalizedStrings'.static.GetLengthStringsArray().Length;
    ServerTypeFilter = DataObject.GetInt("serverType");
    bServerTypeFilterSet = LengthFilter < ServerTypeStrings.Length;
    InProgressFilter = DataObject.GetInt("inProgress");
    bInProgressFilterSet = SavedInProgressIndex == 0;
    PermissionsFilter = DataObject.GetInt("permissions");
    bPermissionsFilterSet = GetPartyPrivacy() != 0;
}

function int GetGameLength()
{
    if(!bLengthFilterSet)
    {
        return -1;
    }
    switch(LengthFilter)
    {
        case 0:
            return 4;
        case 1:
            return 7;
        case 2:
            return 10;
        default:
            return -1;
            break;
    }
}

function bool GetAllowInProgress()
{
    return bInProgressFilterSet;
}

function int GetModeIndex()
{
    if(bIsSoloGame)
    {
        return SavedSoloModeIndex;        
    }
    else
    {
        return SavedModeIndex;
    }
}

function int GetDifficultyIndex()
{
    if(bIsSoloGame)
    {
        return SavedSoloDifficultyIndex;        
    }
    else
    {
        return SavedDifficultyIndex;
    }
}

function int GetLengthIndex()
{
    if(bIsSoloGame)
    {
        return SavedSoloLengthIndex;        
    }
    else
    {
        return SavedLengthIndex;
    }
}

function int GetDifficulty()
{
    if(DifficultyFilter >= Class'KFCommon_LocalizedStrings'.static.GetDifficultyStringsArray().Length)
    {
        DifficultyFilter = 0;
    }
    return DifficultyFilter;
}

function string GetMapName()
{
    if(bIsSoloGame)
    {
        return SavedSoloMapString;        
    }
    else
    {
        return SavedMapString;
    }
}

function bool GetServerType()
{
    return true;
}

function Engine.TWOnlineLobby.ELobbyVisibility GetPartyPrivacy()
{
    switch(SavedPrivacyIndex)
    {
        case 0:
            return 0;
        case 1:
            return 1;
        case 2:
        default:
            return 2;
            break;
    }
}

function bool GetServerTypeListen()
{
    return false;
}

defaultproperties
{
    BackString="BACK"
    StartGameString="START GAME"
    LaunchGameString="LAUNCH GAME"
    ServerTypeString="SERVER TYPE"
    InProgressString="GAME PROGRESS"
    SoloGameString="SOLO GAME"
    LeaveMatchMakingString="LEAVE MATCHMAKING"
    MultiplayerLaunchString="PLAY ONLINE NOW"
    SearchingString="SEARCHING FOR ONLINE GAME...PLEASE WAIT"
    CancelSearchingString="CANCEL SEARCH"
    StandardServerString="Ranked - Stock"
    UnrankedServerString="Unranked"
    CustomServerString="Ranked - Custom"
    AllowInProgressString="Allow In Progress Games"
    NotStartedString="Only New Games"
}