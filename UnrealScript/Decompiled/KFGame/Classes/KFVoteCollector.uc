/*******************************************************************************
 * KFVoteCollector generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class KFVoteCollector extends Object within KFGameReplicationInfo;

struct sKickVoteInfo
{
    var UniqueNetId PlayerID;
    var PlayerReplicationInfo PlayerPRI;
    var string PlayerIPAddress;

    structdefaultproperties
    {
        PlayerID=(Uid=none)
        PlayerPRI=none
        PlayerIPAddress=""
    }
};

struct MapVote
{
    var array<PlayerReplicationInfo> VoterPRIList;
    var int MapIndex;

    structdefaultproperties
    {
        VoterPRIList=none
        MapIndex=0
    }
};

struct TopVotes
{
    var byte Map1Index;
    var byte Map1Votes;
    var byte Map2Index;
    var byte Map2Votes;
    var byte Map3Index;
    var byte Map3Votes;

    structdefaultproperties
    {
        Map1Index=255
        Map1Votes=255
        Map2Index=255
        Map2Votes=255
        Map3Index=255
        Map3Votes=255
    }
};

var byte VoteTime;
var byte YesVotes;
var byte NoVotes;
var byte KickedPlayers;
var byte LastKickVoteValue;
var sKickVoteInfo CurrentVote;
var bool bIsVoteInProgress;
var bool bIsFailedVoteTimerActive;
var const int TopResultsToShow;
var const int ActiveTimeUntilVoteEnabled;
var array<PlayerReplicationInfo> PlayersThatHaveVoted;
var TopVotes TopVotesObject;
var array<MapVote> MapVoteList;
var array<string> MapList;

reliable server function ServerStartVoteKick(PlayerReplicationInfo PRI_Kickee, PlayerReplicationInfo PRI_Kicker)
{
    local int I;
    local array<KFPlayerReplicationInfo> PRIs;
    local KFGameInfo KFGI;
    local KFPlayerController KFPC, KickeePC;

    KFGI = KFGameInfo(Outer.WorldInfo.Game);
    KFPC = KFPlayerController(PRI_Kicker.Owner);
    KickeePC = KFPlayerController(PRI_Kickee.Owner);
    if(KFGI.bDisableKickVote)
    {
        KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 10);
        return;
    }
    if(PRI_Kicker.bOnlySpectator)
    {
        KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 18);
        return;
    }
    if(KFGI.NumPlayers <= 2)
    {
        KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 17);
        return;
    }
    if(KickedPlayers >= 2)
    {
        KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 16);
        return;
    }
    if(Outer.WorldInfo.GRI.ElapsedTime < ActiveTimeUntilVoteEnabled)
    {
        if(Outer.WorldInfo.GRI.bMatchHasBegun)
        {
            KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 14);            
        }
        else
        {
            KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 15);
        }
        return;
    }
    if(KFGI.AccessControl != none)
    {
        if(KFGI.AccessControl.IsAdmin(KickeePC))
        {
            KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 13);
            return;
        }
    }
    if(bIsFailedVoteTimerActive)
    {
        KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 8);
        return;
    }
    if(!bIsVoteInProgress)
    {
        PlayersThatHaveVoted.Length = 0;
        CurrentVote.PlayerID = PRI_Kickee.UniqueId;
        CurrentVote.PlayerPRI = PRI_Kickee;
        CurrentVote.PlayerIPAddress = KickeePC.GetPlayerNetworkAddress();
        bIsVoteInProgress = true;
        RecieveVoteKick(PRI_Kicker, true);
        Outer.GetKFPRIArray(PRIs);
        I = 0;
        J0x4BD:

        if(I < PRIs.Length)
        {
            PRIs[I].ShowKickVote(PRI_Kickee, VoteTime, !(PRIs[I] == PRI_Kicker) || PRIs[I] == PRI_Kickee);
            ++ I;
            goto J0x4BD;
        }
        KFGI.BroadcastLocalized(KFGI, Class'KFLocalMessage', 5, CurrentVote.PlayerPRI);
        Outer.SetTimer(float(VoteTime), false, 'ConcludeVoteKick', self);        
    }
    else
    {
        if(PRI_Kickee == CurrentVote.PlayerPRI)
        {
            RecieveVoteKick(PRI_Kicker, false);            
        }
        else
        {
            KFPlayerController(PRI_Kicker.Owner).ReceiveLocalizedMessage(Class'KFLocalMessage', 9);
        }
    }
}

reliable server function RecieveVoteKick(PlayerReplicationInfo PRI, bool bKick)
{
    local KFPlayerController KFPC;

    if(PlayersThatHaveVoted.Find(PRI == -1)
    {
        PlayersThatHaveVoted.AddItem(PRI;
        if(bKick)
        {
            ++ YesVotes;            
        }
        else
        {
            ++ NoVotes;
        }
        KFPC = KFPlayerController(PRI.Owner);
        if(KFPC != none)
        {
            if(bKick)
            {
                KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 11, CurrentVote.PlayerPRI);                
            }
            else
            {
                KFPC.ReceiveLocalizedMessage(Class'KFLocalMessage', 12, CurrentVote.PlayerPRI);
            }
        }
        if(ShouldConcludeVote())
        {
            ConcludeVoteKick();            
        }
        else
        {
            ReplicateVotes();
        }
    }
}

function ReplicateVotes()
{
    Outer.RepKickVotes = byte(Min(YesVotes, 15) << 4);
    Outer.RepKickVotes = byte(Outer.RepKickVotes | Min(NoVotes, 15));
    if((Outer.Role == ROLE_Authority) && Outer.WorldInfo.NetMode != NM_DedicatedServer)
    {
        UnPackVotes();
    }
}

function UnPackVotes()
{
    local KFPlayerController KFPC;

    if(LastKickVoteValue != Outer.RepKickVotes)
    {
        NoVotes = byte(Outer.RepKickVotes & 15);
        YesVotes = byte(Outer.RepKickVotes >> 4);
        KFPC = KFPlayerController(Outer.GetALocalPlayerController());
        if((KFPC != none) && KFPC.MyGFxHUD != none)
        {
            KFPC.MyGFxHUD.UpdateKickVoteCount(YesVotes, NoVotes);
        }
        LastKickVoteValue = Outer.RepKickVotes;
    }
}

function bool ShouldConcludeVote()
{
    local array<KFPlayerReplicationInfo> PRIs;
    local KFGameInfo KFGI;
    local int NumPRIs;

    KFGI = KFGameInfo(Outer.WorldInfo.Game);
    Outer.GetKFPRIArray(PRIs);
    NumPRIs = PRIs.Length;
    if(PRIs.Find(CurrentVote.PlayerPRI != -1)
    {
        -- NumPRIs;
    }
    if((YesVotes + NoVotes) >= NumPRIs)
    {
        return true;        
    }
    else
    {
        if(KFGI != none)
        {
            if((float(YesVotes) / float(NumPRIs)) > KFGI.KickVotePercentage)
            {
                return true;                
            }
            else
            {
                if((float(NoVotes) / float(NumPRIs)) >= (1 - KFGI.KickVotePercentage))
                {
                    return true;
                }
            }
        }
    }
    return false;
}

reliable server function ConcludeVoteKick()
{
    local array<KFPlayerReplicationInfo> PRIs;
    local int I, NumPRIs;
    local KFGameInfo KFGI;
    local KFPlayerController KickedPC;

    KFGI = KFGameInfo(Outer.WorldInfo.Game);
    if(bIsVoteInProgress)
    {
        Outer.GetKFPRIArray(PRIs);
        I = 0;
        J0x87:

        if(I < PRIs.Length)
        {
            PRIs[I].HideKickVote();
            ++ I;
            goto J0x87;
        }
        NumPRIs = PRIs.Length;
        if(PRIs.Find(CurrentVote.PlayerPRI != -1)
        {
            -- NumPRIs;
        }
        if((YesVotes >= NumPRIs) || (float(YesVotes) / float(NumPRIs)) > KFGI.KickVotePercentage)
        {
            if((CurrentVote.PlayerPRI == none) || CurrentVote.PlayerPRI.bPendingDelete)
            {
                I = 0;
                J0x1E2:

                if(I < Outer.WorldInfo.Game.InactivePRIArray.Length)
                {
                    if(Outer.WorldInfo.Game.InactivePRIArray[I].UniqueId == CurrentVote.PlayerID)
                    {
                        CurrentVote.PlayerPRI = Outer.WorldInfo.Game.InactivePRIArray[I];
                        goto J0x348;
                    }
                    ++ I;
                    goto J0x1E2;
                }
            }
            J0x348:

            if(KFGI.AccessControl != none)
            {
                KickedPC = (((CurrentVote.PlayerPRI != none) && CurrentVote.PlayerPRI.Owner != none) ? KFPlayerController(CurrentVote.PlayerPRI.Owner) : none);
                KFAccessControl(KFGI.AccessControl).KickSessionBanPlayer(KickedPC, CurrentVote.PlayerID, KFGI.AccessControl.KickedMsg);
            }
            KFGI.BroadcastLocalized(KFGI, Class'KFLocalMessage', 7, CurrentVote.PlayerPRI);
            ++ KickedPlayers;            
        }
        else
        {
            bIsFailedVoteTimerActive = true;
            Outer.SetTimer(KFGI.TimeBetweenFailedVotes, false, 'ClearFailedVoteFlag', self);
            KFGI.BroadcastLocalized(KFGI, Class'KFLocalMessage', 6, CurrentVote.PlayerPRI);
        }
        bIsVoteInProgress = false;
        CurrentVote.PlayerPRI = none;
        CurrentVote.PlayerID = Class'PlayerReplicationInfo'.default.UniqueId;
        YesVotes = 0;
        NoVotes = 0;
    }
}

function ClearFailedVoteFlag()
{
    bIsFailedVoteTimerActive = false;
}

function AddMapOption(string MapOption)
{
    MapList.AddItem(MapOption;
}

function int GetNextMap()
{
    if(MapVoteList.Length > 0)
    {
        return MapVoteList[0].MapIndex;
    }
    return -1;
}

function SearchAndClearPreviousVote(PlayerReplicationInfo PRI)
{
    local int I;

    I = 0;
    J0x0B:

    if(I < MapVoteList.Length)
    {
        if(MapVoteList[I].VoterPRIList.Find(PRI != -1)
        {
            MapVoteList[I].VoterPRIList.RemoveItem(PRI;
            return;
        }
        ++ I;
        goto J0x0B;
    }
}

reliable server function ReceiveVoteMap(PlayerReplicationInfo PRI, int MapIndex)
{
    local int I;
    local bool bMapFound;
    local MapVote TempMapVote;
    local array<KFPlayerReplicationInfo> PRIs;

    Outer.GetKFPRIArray(PRIs);
    if(MapVoteList.Length > 0)
    {
        SearchAndClearPreviousVote(PRI);
        I = 0;
        J0x57:

        if(I < MapVoteList.Length)
        {
            if(MapVoteList[I].MapIndex == MapIndex)
            {
                bMapFound = true;
                MapVoteList[I].VoterPRIList.AddItem(PRI;
                goto J0xF3;
            }
            ++ I;
            goto J0x57;
        }
    }
    J0xF3:

    if(!bMapFound)
    {
        TempMapVote.MapIndex = MapIndex;
        TempMapVote.VoterPRIList.AddItem(PRI;
        MapVoteList.AddItem(TempMapVote;
    }    
    MapVoteList.Sort(MapVoteSort;
    I = 0;
    J0x199:

    if(I < TopResultsToShow)
    {
        if(I < MapVoteList.Length)
        {
            switch(I)
            {
                case 0:
                    TopVotesObject.Map1Votes = byte(MapVoteList[I].VoterPRIList.Length);
                    TopVotesObject.Map1Index = byte(MapVoteList[I].MapIndex);
                    break;
                case 1:
                    TopVotesObject.Map2Votes = byte(MapVoteList[I].VoterPRIList.Length);
                    TopVotesObject.Map2Index = byte(MapVoteList[I].MapIndex);
                    break;
                case 2:
                    TopVotesObject.Map3Votes = byte(MapVoteList[I].VoterPRIList.Length);
                    TopVotesObject.Map3Index = byte(MapVoteList[I].MapIndex);
                    break;
                default:
                    break;
            }
        }
        else
        {
            ++ I;
            goto J0x199;
        }/* !MISMATCHING REMOVE, tried Loop got Type:Else Position:0x395! */
        I = 0;
        J0x3AE:

        if(I < PRIs.Length)
        {
            PRIs[I].RecieveTopMaps(TopVotesObject);
            ++ I;
            goto J0x3AE;
        }
    }/* !MISMATCHING REMOVE, tried Else got Type:Loop Position:0x199! */
}

function int MapVoteSort(MapVote A, MapVote B)
{
    local int Result;

    if(A.VoterPRIList.Length == B.VoterPRIList.Length)
    {
        Result = 0;        
    }
    else
    {
        Result = ((A.VoterPRIList.Length > B.VoterPRIList.Length) ? 1 : -1);
    }
    return Result;
}

defaultproperties
{
    VoteTime=30
    TopResultsToShow=3
    ActiveTimeUntilVoteEnabled=30
    TopVotesObject=(Map1Index=255,Map1Votes=255,Map2Index=255,Map2Votes=255,Map3Index=255,Map3Votes=255)
}