/*******************************************************************************
 * GameCrowdDestinationQueuePoint generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class GameCrowdDestinationQueuePoint extends GameCrowdInteractionPoint
    native
    placeable
    hidecategories(Navigation,Advanced,Collision,Display,Actor,Movement,Physics);

/** Position behind this one in line */
var() GameCrowdDestinationQueuePoint NextQueuePosition;
var GameCrowdInteractionPoint PreviousQueuePosition;
var GameCrowdAgent QueuedAgent;
var transient GameCrowdDestination QueueDestination;
var bool bClearingQueue;
var bool bPendingAdvance;
/** Average pause time before agent reacts to queue movement */
var() float AverageReactionTime;
var class<GameCrowdBehavior_WaitInQueue> QueueBehaviorClass;

// Export UGameCrowdDestinationQueuePoint::execQueueReachedBy(FFrame&, void* const)
native function bool QueueReachedBy(GameCrowdAgent Agent, Vector TestPosition);

simulated function bool HasSpace()
{
    if((QueuedAgent == none) && ((NextQueuePosition == none) || !NextQueuePosition.bPendingAdvance) || NextQueuePosition.QueuedAgent == none)
    {
        return true;
    }
    if(NextQueuePosition == none)
    {
        return false;
    }
    return NextQueuePosition.HasSpace();
}

simulated event ReachedDestination(GameCrowdAgent Agent)
{
    local GameCrowdDestinationQueuePoint QueuePoint;

    QueuePoint = Agent.CurrentDestination.QueueHead;
    J0x3D:

    if(QueuePoint != none)
    {
        if(QueuePoint.NextQueuePosition == self)
        {
            if(QueuePoint.QueuedAgent == none)
            {
                WarnInternal((string(Agent) $ "in queue behind empty spot at ") $ string(self));                
            }
            else
            {
                if(!QueuePoint.QueueReachedBy(QueuePoint.QueuedAgent, QueuePoint.QueuedAgent.Location) && VSizeSq(QueuePoint.Location - Agent.Location) < VSizeSq(QueuePoint.Location - QueuePoint.QueuedAgent.Location))
                {
                    QueuedAgent = QueuePoint.QueuedAgent;
                    QueuePoint.QueuedAgent = Agent;
                    GameCrowdBehavior_WaitInQueue(QueuedAgent.CurrentBehavior).QueuePosition = self;
                    GameCrowdBehavior_WaitInQueue(QueuePoint.QueuedAgent.CurrentBehavior).QueuePosition = QueuePoint;
                    return;
                }
            }
        }
        QueuePoint = QueuePoint.NextQueuePosition;
        goto J0x3D;
    }
    GameCrowdBehavior_WaitInQueue(QueuedAgent.CurrentBehavior).bIdleBehavior = true;
    QueuedAgent.PlayIdleAnimation();
}

simulated function AdvanceCustomerTo(GameCrowdInteractionPoint FrontPosition)
{
    PreviousQueuePosition = FrontPosition;
    bPendingAdvance = true;
    SetTimer(AverageReactionTime, false, 'ActuallyAdvance');
}

private final simulated function ActuallyAdvance()
{
    local GameCrowdDestinationQueuePoint FrontQueuePosition;
    local GameCrowdDestination QueueFront;
    local GameCrowdAgent TempAgent;

    bPendingAdvance = false;
    if(QueuedAgent != none)
    {
        TempAgent = QueuedAgent;
        bClearingQueue = true;
        QueuedAgent.StopBehavior();
        bClearingQueue = false;
        QueuedAgent = none;
        FrontQueuePosition = GameCrowdDestinationQueuePoint(PreviousQueuePosition);
        if(FrontQueuePosition != none)
        {
            FrontQueuePosition.AddCustomer(TempAgent, none);            
        }
        else
        {
            QueueFront = GameCrowdDestination(PreviousQueuePosition);
            if(QueueFront == none)
            {
                WarnInternal("Illegal front position for queue " $ string(self));
                return;
            }
            QueueFront.IncrementCustomerCount(TempAgent);
        }
        if(QueuedAgent != none)
        {
            WarnInternal((((string(self) $ " GOT QUEUED AGENT BACK - Head ") $ string(PreviousQueuePosition)) $ " Tail ") $ string(NextQueuePosition));            
        }
        else
        {
            if(NextQueuePosition != none)
            {
                NextQueuePosition.AdvanceCustomerTo(self);
            }
        }
    }
}

simulated function AddCustomer(GameCrowdAgent NewCustomer, GameCrowdInteractionPoint PreviousPosition)
{
    if(PreviousPosition != none)
    {
        PreviousQueuePosition = PreviousPosition;
    }
    if(QueuedAgent == none)
    {
        QueuedAgent = NewCustomer;
        NewCustomer.ActivateInstancedBehavior(new (NewCustomer) QueueBehaviorClass);
        GameCrowdBehavior_WaitInQueue(NewCustomer.CurrentBehavior).QueuePosition = self;
        GameCrowdBehavior_WaitInQueue(NewCustomer.CurrentBehavior).ActionTarget = PreviousQueuePosition;        
    }
    else
    {
        if(NextQueuePosition != none)
        {
            NextQueuePosition.AddCustomer(NewCustomer, self);            
        }
        else
        {
            WarnInternal(((string(self) $ " Attempted to add customer ") $ string(NewCustomer)) $ " beyond end of queue");
        }
    }
}

simulated function ClearQueue(GameCrowdAgent OldCustomer)
{
    if(!bClearingQueue)
    {
        bClearingQueue = true;
        if(OldCustomer == QueuedAgent)
        {
            QueuedAgent.StopBehavior();
            QueuedAgent = none;
            if(NextQueuePosition != none)
            {
                NextQueuePosition.AdvanceCustomerTo(self);
            }            
        }
        else
        {
            WarnInternal((("Attempted to clear " $ string(OldCustomer)) $ " from queue position with customer ") $ string(QueuedAgent));
        }
        bClearingQueue = false;
    }
}

simulated function bool HasCustomer()
{
    return QueuedAgent != none;
}

defaultproperties
{
    AverageReactionTime=0.7
    QueueBehaviorClass=Class'GameCrowdBehavior_WaitInQueue'
    begin object name=CollisionCylinder class=CylinderComponent
        CollisionRadius=100
        ReplacementPrimitive=none
    object end
    // Reference: CylinderComponent'Default__GameCrowdDestinationQueuePoint.CollisionCylinder'
    CylinderComponent=CollisionCylinder
    begin object name=CollisionCylinder class=CylinderComponent
        CollisionRadius=100
        ReplacementPrimitive=none
    object end
    // Reference: CylinderComponent'Default__GameCrowdDestinationQueuePoint.CollisionCylinder'
    Components(0)=CollisionCylinder
    begin object name=Sprite class=SpriteComponent
        ReplacementPrimitive=none
    object end
    // Reference: SpriteComponent'Default__GameCrowdDestinationQueuePoint.Sprite'
    Components(1)=Sprite
    begin object name=CollisionCylinder class=CylinderComponent
        CollisionRadius=100
        ReplacementPrimitive=none
    object end
    // Reference: CylinderComponent'Default__GameCrowdDestinationQueuePoint.CollisionCylinder'
    CollisionComponent=CollisionCylinder
}