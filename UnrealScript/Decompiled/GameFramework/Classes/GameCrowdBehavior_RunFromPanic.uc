/*******************************************************************************
 * GameCrowdBehavior_RunFromPanic generated by Eliot.UELib using UE Explorer.
 * Eliot.UELib ? 2009-2022 Eliot van Uytfanghe. All rights reserved.
 * http://eliotvu.com
 *
 * All rights belong to their respective owners.
 *******************************************************************************/
class GameCrowdBehavior_RunFromPanic extends GameCrowdAgentBehavior
    native;

var transient Actor PanicFocus;

function ActivatedBy(Actor NewActionTarget)
{
    local GameCrowdDestination TempDest, PrevDest;

    PanicFocus = NewActionTarget;
    PrevDest = MyAgent.PreviousDestination;
    if((MyAgent.CurrentDestination != none) && AllowThisDestination(MyAgent.CurrentDestination))
    {
        return;        
    }
    else
    {
        if((PrevDest != none) && PrevDest.AllowableDestinationFor(MyAgent))
        {
            TempDest = MyAgent.CurrentDestination;
            MyAgent.CurrentDestination.DecrementCustomerCount(MyAgent);
            MyAgent.SetCurrentDestination(MyAgent.PreviousDestination);
            MyAgent.PreviousDestination = TempDest;
            MyAgent.UpdateIntermediatePoint();
        }
    }
}

function InitBehavior(GameCrowdAgent Agent)
{
    super.InitBehavior(Agent);
    MyAgent.bIsPanicked = true;
    MyAgent.SetMaxSpeed();
}

function StopBehavior()
{
    super.StopBehavior();
    MyAgent.bIsPanicked = false;
    MyAgent.SetMaxSpeed();
}

function Actor GetBehaviorInstigator()
{
    return PanicFocus;
}

function bool AllowThisDestination(GameCrowdDestination Destination)
{
    return (!Destination.bAvoidWhenPanicked && !Destination.AtCapacity()) && (Destination.bFleeDestination || PanicFocus == none) || ((Destination.Location - MyAgent.Location) Dot (MyAgent.Location - PanicFocus.Location)) > 0;
}

function bool AllowBehaviorAt(GameCrowdDestination Destination)
{
    return !Destination.bSkipBehaviorIfPanicked && !Destination.bAvoidWhenPanicked;
}

function string GetBehaviorString()
{
    return "Run from PANIC " @ string(PanicFocus);
}

defaultproperties
{
    MyEventType=ECrowdBehaviorEvent.CBE_Panic
    ViralBehaviorEvent=ECrowdBehaviorEvent.CBE_Alert
    bIsViralBehavior=true
    MaxPlayerDistance=20000
    DebugBehaviorColor=(B=0,G=0,R=255,A=0)
}